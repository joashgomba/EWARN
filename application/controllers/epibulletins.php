<?php
set_time_limit(0); //no limit
class Epibulletins extends CI_Controller {

    function __construct()
    {
        parent::__construct();
        $this->load->model('epibulletinsmodel');
        $this->load->model('reportsmodel');

    }

    public function index()
    {
        if (!$this->erkanaauth->try_session_login()) {
            redirect('login','refresh');
        }
        $data = array(
            'rows' => $this->db->get('epibulletins'),
            'error_message' => $this->session->flashdata('error_message'),
        );
        $this->load->view('epibulletins/index', $data);
    }

    public function add()
    {
        if (!$this->erkanaauth->try_session_login()) {
            redirect('login','refresh');
        }

        $country_id = $this->erkanaauth->getField('country_id');

        if(getRole() != 'SuperAdmin' && getRole() != 'Admin')
        {
            redirect('home', 'refresh');
        }

        $data = array();

        $data['countries'] = $this->countriesmodel->get_list();
        $data['country_id'] = $country_id;

        $this->load->view('epibulletins/add',$data);
    }

    public function template()
    {

        //create new PDF document
        $pdf = new Pdf(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);

        // set document information
        $pdf->SetCreator(PDF_CREATOR);
        $pdf->SetAuthor('WHO EMRO');
        $pdf->SetTitle('EPI Weekly Bulletin');
        $pdf->SetSubject('WHO EMRO Weekly Bulletin');
        $pdf->SetKeywords('WHO, EMRO, Bulletin, Diseases','Surveillance','EPI','Alerts');

        // set default header data
        $pdf->SetHeaderData(false, false, '', '');


        // set header and footer fonts
        $pdf->setHeaderFont(Array(PDF_FONT_NAME_MAIN, '', PDF_FONT_SIZE_MAIN));
        $pdf->setFooterFont(Array(PDF_FONT_NAME_DATA, '', PDF_FONT_SIZE_DATA));

        // set default monospaced font
        $pdf->SetDefaultMonospacedFont(PDF_FONT_MONOSPACED);


        //set margins
        //$pdf->SetMargins(PDF_MARGIN_LEFT, PDF_MARGIN_TOP, PDF_MARGIN_RIGHT);
        $pdf->SetMargins(9,9,9,9);
        $pdf->SetHeaderMargin(PDF_MARGIN_HEADER);
        $pdf->SetFooterMargin(PDF_MARGIN_FOOTER);

        //set auto page breaks
        $pdf->SetAutoPageBreak(TRUE, PDF_MARGIN_BOTTOM);

        //set image scale factor
        $pdf->setImageScale(PDF_IMAGE_SCALE_RATIO);

        //set some language-dependent strings
        //$pdf->setLanguageArray($l);

        // ---------------------------------------------------------

        // set font
        $pdf->SetFont('dejavusans', '', 9);

        $pdf->SetPrintHeader(false);

        // add a page
        //$pdf->AddPage('L','A4');
        $pdf->AddPage();


        $html = '<table width="100%" cellpadding="3" cellspacing="0" border="2" bordercolor="#999999">
        <tr><td align="center"><img src="'. base_url().'images/header.png" alt=""></td></tr>
        <tr bgcolor="#1f7eb8"><th align="center"><center>
        <font color="#FFFFFF"><strong>Epi Week 28, 10 July 2017 - 16 July 2017</strong></font></center>
        </th></tr>
        ';

        $html .= '<tr><td>
<table width="100%" cellpadding="2" cellspacing="2" id="customers">
		<tr>
		<td bgcolor="#892A24" width="50%">
		<font color="#FFFFFF"><strong>Highlights</strong></font>
		</td>
		<td bgcolor="#892A24" width="50%">
		<font color="#FFFFFF"><strong>eDEWS Reporting Rates vs Consultations in All States, Epi weeks 1 to 34, 2016</strong></font>
		</td>
		</tr>
		<tr>
		<td valign="top">
		<p>Reports were received from 17 out of 496 reporting
        facilities (3.4%) in week 28. Compared to 13 (2.6%) in
        week 27.</p>
        <p>The total number of consultatations reported during the
        reporting week was 4,326 compared to 2,358
        consultations during week 27.</p>
        <p>The highest number of consultations in week 28 were
        OAD(128 cases), ILI(54 cases), followed by AWD(51 cases)
        The number of AWD decreased from 123 cases in week 27
        to 51 cases in week 28</p>
        <p>There was no change on the number of Meas cases with
        the number remaining at 28 cases in week 27 and 28
        cases in week 28</p>
        
   <p> A total of 291 alerts were generated by eDEWS system in week 34, 2016; Of these 12 alerts were verified as true for further investigations with appropriate response.</p>
       
<p>
<table border="1" width="100%" cellspacing="0" cellpadding="2">
<tr bgcolor="#892A24"><td><font color="#FFFFFF" size="8">State</font></td><td><font color="#FFFFFF" size="8">Reporting Sites</font></td><td><font color="#FFFFFF" size="8">No. Sentinal Sites</font></td><td><font color="#FFFFFF" size="8">Completeness</font></td></tr>
<tr bgcolor="#CCCCCC"><td>Banadir</td><td>107</td><td>109</td><td>98%</td></tr>
<tr><td>Puntland</td><td>107</td><td>109</td><td>98%</td></tr>
<tr bgcolor="#CCCCCC"><td>Somaliland</td><td>107</td><td>109</td><td>98%</td></tr>
<tr><td>Jubaland</td><td>107</td><td>109</td><td>98%</td></tr>
<tr bgcolor="#CCCCCC"><td>Southwest</td><td>107</td><td>109</td><td>98%</td></tr>
<tr><td>Hirshabele</td><td>107</td><td>109</td><td>98%</td></tr>
<tr bgcolor="#CCCCCC"><td>Galmuduq</td><td>107</td><td>109</td><td>98%</td></tr>
<tr><td>Total</td><td>469</td><td>478</td><td>98%</td></tr>

</table>
</p>

</td>
		<td valign="top">
		<img src="'. base_url().'images/reportelements/rates_SOM_28_2017.jpg" height="250" alt="">
		<hr>
	<p><font size="6"> <strong>Distribution of Reporting Rates by States (Epi-week 34 , 2016)</strong></font></p>
		
		<img src="'. base_url().'images/reportelements/chart.jpeg" height="200" alt="">
		</td>
		</tr>
		</table>
        </td></tr>';



        $html .= '<tr><td>
<table width="100%" cellpadding="2" cellspacing="2" id="customers">
		<tr>
		<td bgcolor="#892A24" width="50%">
		<font color="#FFFFFF"><strong>Number of alerts received and reported</strong></font>
		</td>
		<td bgcolor="#892A24" width="50%">
		<font color="#FFFFFF"><strong>Epi curve for priority diseases weeks 18 2017 to 28 2017</strong></font>
		</td>
		</tr>
		
		<tr>
		<td>
		<img src="'. base_url().'images/reportelements/alertgraph_SOM_28_2017.jpg" height="200" alt="">		
        </td>
		<td>
		
		<img src="'. base_url().'images/reportelements/epicurve_SOM_28_2017.jpg" height="200" alt="">	
        </td>
        </tr>
		
		
		</table>
</td>

        </tr>';

        $html .= '</table>';

        $html .= '<br pagebreak="true">';

        $html .= '<table width="100%" cellpadding="3" cellspacing="0" border="2" bordercolor="#999999">';
        $html .= '<tr><td>
<table width="100%" cellpadding="2" cellspacing="2" id="customers">
		<tr>
		<td bgcolor="#892A24" width="50%">
		<font color="#FFFFFF"><strong>Leading causes of morbidity and mortality in Epi-week 34, 2016 a). OAD</strong></font>
		</td>
		<td bgcolor="#892A24" width="50%">
		<font color="#FFFFFF"><strong>Leading disease outbreak in all states &amp; Proportional morbidity of leading priority diseases, Epi weeks 1 to 34, 2016</strong></font>
		</td>
		</tr>
		<tr><td>
		
		<p>446 suspected dengue cases were reported in 14 governorates, out of these 112 cases reported from Al-Hodidah, 85 Cases from Shabwah, 32 Cases from Aden, and 22 Cases from Lahj, 1 cases with hemorrhagic manifestations were reported in Mareb governorate through the eDEWS system.
        </p>
        <p>Other Acute Diarrhea (4.3%), Malaria (0.6%), Suspected Measles (0.0%) remain the leading causes of morbidity representing a total of 4.9%.</p>
       <p>Severe acute respiratory infection, acute watery diarrhea and Acute Jaundice Syndrome represented less than 0.0% of total morbidity in reporting period. Bloody diarrhea represented 0.0% of this morbidity.</p>
		<p>All diarrheal diseases comprised 4.3% and Influenza like illnesses 0.0% of total morbidity in all zones this week.</p>
		<p>All diarrheal diseases &lt; 5 accounted for 3.9% and those &gt; 5 years of age accounted for 0.4% of total morbidity in all zones this week.</p>
		
		<table width="100%" border="1" >
		<tr bgcolor="#892A24"><td><font color="#FFFFFF">Leading Diseases</font></td><td colspan="2"><font color="#FFFFFF">Epi week 49</font></td><td colspan="2"><font color="#FFFFFF">Epi week 48</font></td></tr>
		<tr bgcolor="#892A24"><td>&nbsp;</td><td><font color="#FFFFFF">Cases</font></td><td><font color="#FFFFFF">Percentage</font></td><td><font color="#FFFFFF">Cases</font></td><td><font color="#FFFFFF">Percentage</font></td></tr>
		<tr><td>OAD</td><td>80</td><td>30%</td><td>80</td><td>30%</td></tr>
		<tr><td>ILI</td><td>80</td><td>30%</td><td>80</td><td>30%</td></tr>
		<tr><td>AWD</td><td>80</td><td>30%</td><td>80</td><td>30%</td></tr>
		<tr bgcolor="#892A24"><td><font color="#FFFFFF">Total Consultations</font></td><td><font color="#FFFFFF">240</font></td><td><font color="#FFFFFF">100%</font></td><td><font color="#FFFFFF">240</font></td><td><font color="#FFFFFF">100%</font></td></tr>
		
		
        </table>
		</td>
        <td>
        <p> <img src="'. base_url().'images/reportelements/epicurve_SOM_28_2017.jpg" height="200" alt=""></p>
       <hr>
       <p> <img src="'. base_url().'images/reportelements/epicurve_SOM_28_2017.jpg" height="200" alt=""></p>
        </td>
        </tr>
		
		</table>

        </td></tr>';

        $html .= '<tr><td><table width="100%" border="1" cellpadding="3" cellspacing="0">
		<tr bgcolor="#892A24"><td colspan="2"><font color="#FFFFFF">Weekly trends of Respiratory Diseases, Gastro Intestinal Tract Diseases, Measles, and Suspected Malaria ( Epi week 1 to 34, 2015 & 2016)</font></td></tr>
		
		<tr><td>
		<p><div align="center"><strong>Respiratory Diseases</strong></div></p>
		<img src="'. base_url().'images/reportelements/chart.jpeg" height="250" alt="">
		SARI,ILI
		</td>
		<td>
		<p><div align="center"><strong>Gastro Intestinal Tract Diseases</strong></div></p>
		<img src="'. base_url().'images/reportelements/chart.jpeg" height="250" alt="">
		AWD,BD,OAD
		</td>
		</tr>
		
		</table>

        </td></tr>';

        $html .= '</table>';

        $html .= '<br pagebreak="true">';

        $html .= '<table width="100%" cellpadding="3" cellspacing="0" border="2" bordercolor="#999999">';
        $html .= '<tr><td><table width="100%" border="1" cellpadding="3" cellspacing="0">
            <tr><td>
            <p><div align="center"><strong>Prop. Morb. of Measles</strong></div></p>
            <img src="'. base_url().'images/reportelements/chart.jpeg" height="250" alt="">
            </td>
            <td>
            <p><div align="center"><strong>Trends for confirmed Malaria morbidity in Somalia</strong></div></p>
            <img src="'. base_url().'images/reportelements/malariagraph_SOM_28_2017.jpg" height="250" alt="">
            </td>
            </tr>
		
		</table>
        </td></tr>';
        $html .= '<tr><td><table width="100%" cellpadding="3" cellspacing="0">
		<tr bgcolor="#892A24"><td><font color="#FFFFFF">Summary of Diseases Reported in weeks 27 and 28
</font></td></tr>

<tr><td><table width="100%" cellpadding="3" cellspacing="0" border="1">
		<tr bgcolor="#892A24"><td><font color="#FFFFFF">Disease</font></td><td colspan="3" align="center"><font color="#FFFFFF">EPI week 27</font></td><td colspan="3"><font color="#FFFFFF">Epi week 28</font></td></tr>
		<tr bgcolor="#892A24"><td>&nbsp;</td><td><font color="#FFFFFF">&lt; 5</font></td><td><font color="#FFFFFF">&gt; 5</font></td><td><font color="#FFFFFF">Total Cases</font></td><td><font color="#FFFFFF">&lt; 5</font></td><td><font color="#FFFFFF">&gt; 5</font></td><td><font color="#FFFFFF">Total Cases</font></td></tr>
		</table>
		</td></tr>
		</table>
				
        </td></tr>';

        $html .= '';
        $html .= '</table>';

        $html .= '<br pagebreak="true">';

        $html .= '<table width="100%" cellpadding="3" cellspacing="0" border="2" bordercolor="#999999">';
        $html .= '<tr><td><table width="100%" cellpadding="3" cellspacing="0">
		<tr bgcolor="#892A24"><td><font color="#FFFFFF">Distribution of consultations of leading diseases by States, Epi week 34</font></td></tr>
        <tr><td><table width="100%" cellpadding="3" cellspacing="0" border="1">
		<tr bgcolor="#892A24"><td><font color="#FFFFFF">Suspected Disease</font></td><td><font color="#FFFFFF">Banadir</font></td><td><font color="#FFFFFF">Puntland</font></td><td><font color="#FFFFFF">Somaliland</font></td><td><font color="#FFFFFF">Jubaland</font></td><td><font color="#FFFFFF">South West</font></td><td><font color="#FFFFFF">Hirshabele</font></td><td><font color="#FFFFFF">Galmuduq</font></td></tr>
		
		</table>
		</td></tr>
        </table>

        </td></tr>
        
        <tr><td><table width="100%" cellpadding="3" cellspacing="0">
		<tr bgcolor="#892A24"><td><font color="#FFFFFF">Alerts\' Numbers by District</font></td></tr>
        <tr><td><table width="100%" cellpadding="3" cellspacing="0" border="1">
		<tr bgcolor="#892A24"><td><font color="#FFFFFF">Region</font></td><td><font color="#FFFFFF">Banadir</font></td><td><font color="#FFFFFF">Puntland</font></td><td><font color="#FFFFFF">Somaliland</font></td><td><font color="#FFFFFF">Jubaland</font></td><td><font color="#FFFFFF">South West</font></td><td><font color="#FFFFFF">Hirshabele</font></td><td><font color="#FFFFFF">Galmuduq</font></td></tr>
		
		</table>
		</td></tr>
        </table>

        </td></tr>
       
        </table>';

        $html .= '<br pagebreak="true">';


        $html .= '<table width="100%" cellpadding="3" cellspacing="0" border="2" bordercolor="#999999">';
        $html .= '<tr bgcolor="#892A24"><td><font color="#FFFFFF">The objective of this weekly epidemiological bulletin is to provide a snap shot on selected health events reported from the eWARN surveillance system in all states (Banadir, Puntland, Somaliland, Galmudug, Jubaland, South East) of Somalia. While every attempt is made to present the weekly trends of epidemic prone diseases, the information presented in the bulletin needs to be interpreted in the context that precise information on the reference populations is not always available. The bulletin also includes information collected by the eWARN teams. The primary focus of eWARN is early detection of epidemic prone desease, to facilitate a rapid public health response.</font></td></tr>
        <tr bgcolor="#cccccc"><td><p><strong>Abbreviations</strong></p>
        <p>*Epi=Epidemiological; Sus=Suspected; HF=Health Facility; SARI=Severe acute respiratory infection; ILI=Influenza like
illnesses; AWD=Acute Watery Diarrhea/Sus.Cholera; BD=Bloody Diarrhea/Sus.Shigellosis; OAD=Other Acute Diarrhea;
Diph=Suspected Diphtheria; WC=Suspected Whooping Cough; Meas=Suspected Measles; NNT=Neonatal Tetanus;
AFP=Acute Flaccid Paralysis; AJS=Suspected Acute Jaundice Syndrome; VHF=Suspected Viral Hemorrhagic Fever/Ebola;
Mal=Confirmed Malaria; Men=Suspected Meningitis; CSR=Communicable disease Surveillance and Response;
INT=Insecticides Treated Nets
</p>
        </td></tr>
        <tr bgcolor="#1f7eb8"><td><font color="#FFFFFF">This weekly Epidemiological bulletin is published jointly by the Health Authorities and the World Health Organization.
For further information, please contact the surveillance team on: mutaawea@who.int</font>
</td></tr>
        </table>';



        //echo $html;
        // output the HTML content
        $pdf->writeHTML($html, true, false, true, false, '');

        $txt = date("m/d/Y h:m:s");

        // print a block of text using Write()
        //$pdf->Write($h=0, $txt, $link='', $fill=0, $align='C', $ln=true, $stretch=0, $firstline=false, $firstblock=false, $maxh=0);
        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
        // test pre tag


        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

        // reset pointer to the last page
        $pdf->lastPage();
        ob_start();
        // ---------------------------------------------------------
        //ob_end_clean();
        //Close and output PDF document
        $pdf->Output('EPI_Bulletin_template.pdf', 'I');


        //============================================================+
        // END OF FILE
        //============================================================+
    }

    public function generatebulletin()
    {
        if (!$this->erkanaauth->try_session_login()) {
            redirect('login','refresh');
        }
        $this->load->library('form_validation');

        $this->form_validation->set_rules('week_no', 'Week no', 'trim|required');
        $this->form_validation->set_rules('week_year', 'Week year', 'trim|required');
        $this->form_validation->set_rules('country_id', 'Country id', 'trim|required');

        if ($this->form_validation->run() == false) {
            $this->add();
        } else {
            $current_week = $this->input->post('week_no');
            $current_year = $this->input->post('week_year');
            $country_id = $this->input->post('country_id');

            $country = $this->countriesmodel->get_by_id($country_id)->row();

            if($current_week==52)
            {
                $comming_week = 52;
            }
            else
            {
                $comming_week = ($current_week+1);
            }

            //$week_array = $this->getStartAndEndDate($current_week,$current_year);
            $week_array = $this->getStartAndEndDate($comming_week,$current_year);

            $epicalendar = $this->epdcalendarmodel->get_by_year_week_country($current_year,$current_week,$country->id)->row();

            $row = $this->db->get_where('epibulletins', array('epicalendar_id' => $epicalendar->id))->row();

            if(!empty($row))
            {
                $this->session->set_flashdata('error_message', 'A bulletin for week '.$current_week.' '.$current_year.' in '.$country->country_name.' has already been added.');

                redirect('epibulletins','refresh');
            }//end first if for $row empty check
            else
            {
                $this->displaymessage();

                $total = 16;
                $current = 0;

                $data = array();
                $zon_id = 0;
                $reg_id = 0;
                $dist_id = 0;
                $hf_id = 0;

                unset($row);

                $yearepilists = $this->epdcalendarmodel->get_list_by_year_country($current_year,$country_id);
                $epiyearidArray = array();

                foreach($yearepilists as $key=>$yearepilist):

                    $epiyearidArray[] = $yearepilist['id'];
                endforeach;

                unset($yearepilists);

                //$first_id = reset($epiyearidArray);
                //$last_id = end($epiyearidArray);

                /***HIGHLIGH SECTTION **/

                $reporting_facilities = $this->formsmodel->getreportingsites($epicalendar->id, $dist_id,$reg_id,$zon_id,$hf_id);

                $healthfacilities = $this->healthfacilitiesmodel->get_list_by_country($country_id);
                $total_facilities = count($healthfacilities);

                $zones = $this->zonesmodel->get_country_list($country_id);
                $total_zones = count($zones);

                if($total_facilities==0)
                {
                    $hf_percentage=0;
                }
                else
                {
                    $hf_percentage = ($reporting_facilities/$total_facilities)*100;
                }

                $consultations = $this->formsmodel->getconsultations($epicalendar->id, $dist_id,$reg_id,$zon_id,$hf_id);

                $find_last_week = ($current_week-1);
                if($find_last_week==0)
                {
                    $last_year = ($current_year-1);
                    $last_week = 52;
                    $query_year = $last_year;
                }
                else
                {
                    $query_year = $current_year;
                    $last_week = ($current_week-1);
                }

                $previousepi = $this->epdcalendarmodel->get_by_year_week_country($query_year,$last_week,$country_id)->row();
                $previous_consultations = $this->formsmodel->getconsultations($previousepi->id, $dist_id,$reg_id,$zon_id,$hf_id);


                $previous_reporting_facilities = $this->formsmodel->getreportingsites($previousepi->id, $dist_id,$reg_id,$zon_id,$hf_id);
                if($total_facilities==0)
                {
                    $prev_hf_percentage=0;
                }
                else
                {
                    $prev_hf_percentage = ($previous_reporting_facilities/$total_facilities)*100;
                }



                $diseasecount = $this->diseasesmodel->get_country_list($country_id);
                $limit = count($diseasecount);

                $diseases  = $this->db->get_where('diseases', array('country_id' => $country_id),$limit);

                $diseasearray = array();

                $colors = "";
                foreach ($diseases->result() as $disease):
                    $diseasearray[] = $disease->disease_code;
                    $colors .= "'".$disease->color_code."',";

                endforeach;


                $lists = $this->reportsmodel->get_full_list_case_single_week($epicalendar->id,$dist_id,$reg_id,$zon_id,$hf_id,$diseasearray);

                //find the highest number of mobirdity

                $highlightArray = array();

                foreach($lists as $key=>$list)
                {
                    foreach($diseasearray as $key=>$diseasecode):
                        $disease_element = $diseasecode;

                        $highlightArray["".$diseasecode.""] = $list->$disease_element;

                    endforeach;
                }


                $highest_highlight_num    = max($highlightArray);
                $highest_disease = array_keys($highlightArray, max($highlightArray));

                $total_highlight = $consultations;
                /**
                $previous_total_highlight = $previous_consultations;

                if($total_highlight==0)
                {
                    $highlight_percentage = 0;
                }
                else
                {
                    $highlight_percentage = ($highest_highlight_num/$total_highlight)*100;
                }

                **/


                $highlight = '<ul>';
                $highlight .= '<li>Reports were received from '.$reporting_facilities.' out of '.$total_facilities.' reporting facilities ('.number_format($hf_percentage,1).'%) in week '.$epicalendar->week_no.'. Compared to '.$previous_reporting_facilities.' ('.number_format($prev_hf_percentage,1).'%) in week '.$previousepi->week_no.'.</li>';

                $highlight .= '<li>The total number of consultatations reported during the reporting week was '.number_format($consultations).' compared to '.number_format($previous_consultations).' consultations during week '.$previousepi->week_no.'. </li>';



                //first paragraph
                $highlight .= '<li>The highest number of consultations in week '.$epicalendar->week_no.' were ';
                $positions = $this->top_three_positions($highlightArray);
                //$total_percent = 0;

                $highestdiseaseArray = array();

                //$current = 0;

                foreach($positions as $key=>$position)
                {
                    //$current++;
                    //$this->outputProgress($current, count($positions));
                    /**
                    if($total_highlight==0)
                    {
                        //$disease_percentage = 0;
                    }
                    else
                    {
                        //$disease_percentage = ($position/$total_highlight)*100;
                    }
                    **/


                    if($position==min($positions))
                    {
                        $highlight .= 'followed by ';
                    }

                    $highlight .= $key.'('.number_format($position).' cases)';

                    if($position!=min($positions))
                    {
                        $highlight .= ', ';
                    }
                    else
                    {
                        $highlight .= ' ';
                    }

                    $highestdiseaseArray[] = $key;
                }


                $highlight .= '</li>';


                //disease of interest
                $diseasesofinterest = $this->diseaseofinterestmodel->get_combined_list($country_id);

                $diseseinterestarray = array();
                $interestidArray = array();
                foreach($diseasesofinterest as $key=>$diseaseofinterest):

                    $diseseinterestarray[] = $diseaseofinterest->disease_code;
                    $interestidArray[] = $diseaseofinterest->id;

                endforeach;

                //$first_interest_id = reset($interestidArray);
                //$last_interest_id = end($interestidArray);

                //$interest_diseases = '';
                //$diseases_of_interest = '';

                /**

                foreach($diseseinterestarray as $key=>$diseaseinterestcode):

                    $interest_cases = $this->formsdatamodel->disease_interest_epi($epicalendar->id,$country_id,$dist_id,$reg_id,$zon_id,$hf_id,$diseaseinterestcode);
                    $previous_cases = $this->formsdatamodel->disease_interest_epi($previousepi->id,$country_id,$dist_id,$reg_id,$zon_id,$hf_id,$diseaseinterestcode);

                    $cummulative_cases = $this->formsdatamodel->cummulative_interest_figures($first_id,$last_id,$country_id,$diseaseinterestcode);

                    $interest_diseases .= '<li><strong>'.number_format($cummulative_cases).'</strong> cumulative cases of '.$diseaseinterestcode.'</li>';


                    if($previous_cases<$interest_cases)
                    {
                        $interesttext = 'There was an increase in the number of '.$diseaseinterestcode.' cases from';
                        $conjoin = 'to';
                    }
                    else if($previous_cases>$interest_cases)
                    {
                        $interesttext = 'The number of '.$diseaseinterestcode.' decreased from ';
                        $conjoin = 'to';
                    }
                    else
                    {
                        $interesttext = 'There was no change on the number of '.$diseaseinterestcode.' cases with the number remaining at';
                        $conjoin = 'and';
                    }

                    $highlight .= '<li>'.$interesttext.' '.number_format($previous_cases).' cases in week '.$previousepi->week_no.' '.$conjoin.' '.number_format($interest_cases).' cases in week '.$epicalendar->week_no.'</li>';


                endforeach;

                **/

                $cases = $this->formalertsmodel->get_total_alerts($epicalendar->id,$dist_id,$reg_id,$zon_id,$hf_id);
                $true_cases = $this->formalertsmodel->get_total_true_alerts($epicalendar->id,$dist_id,$reg_id,$zon_id,$hf_id);


                $highlight .= '<li> A total of '.$cases.' alerts were generated by eWARN system in week '.$epicalendar->week_no.', '.$epicalendar->epdyear.'; Of these '.$true_cases.' alerts were verified as true
for further investigations with appropriate response.</li>';


                $highlight .= '</ul>';

                unset($true_cases);
                unset($cases);
                unset($reporting_facilities);
                unset($healthfacilities);

                //one
                $current = $current+1;

                $this->outputProgress($current, $total);


                /***END HIGHLIGHT***/

                $end_date = $week_array['week_start'];

                $baseline_date = date('Y-m-d', strtotime('-10 weeks', strtotime($end_date)));

                $first_week = date("W", strtotime($baseline_date));
                $last_week = date("W", strtotime($end_date));

                $first_year = date("Y", strtotime($baseline_date));
                $last_year = date("Y", strtotime($end_date));

                //Two

                $current = $current+1;

                $this->outputProgress($current, $total);

                /****End consultations and reporting rates****/

                $epi_lists = $this->epdcalendarmodel->get_list_by_date($baseline_date,$end_date,$country_id);
                $categories = '';
                $consultations_column = '';
                $reporting_sites_column = '';

                //$current = 0;
                $epiArray = array();

                foreach($epi_lists as $key=>$epi_list)
                {
                    $consultations = $this->formsmodel->getconsultations($epi_list->id, $dist_id,$reg_id,$zon_id,$hf_id);
                    $reporting_sites = $this->formsmodel->getreportingsites($epi_list->id, $dist_id,$reg_id,$zon_id,$hf_id);

                    $categories .=  "'Wk".$epi_list->week_no."',";
                    $consultations_column .= $consultations.',';
                    $reporting_sites_column .= $reporting_sites.',';

                    $epiArray[] = $epi_list->id;

                    unset($consultations);
                    unset($reporting_sites);

                }

                $data['consultations_column'] = $consultations_column;
                $data['reporting_sites_column'] = $reporting_sites_column;

                unset($consultations_column);
                unset($reporting_sites_column);

                //three
                $current = $current+1;

                $this->outputProgress($current, $total);


                //zone reporting rates

                $zonecategories    = "";
                $zonereportingrate = "";

                $distribution_table = '<table border="1" width="100%" cellspacing="0" cellpadding="1">';
                $distribution_table .= '<tr bgcolor="#892A24"><td><font color="#FFFFFF">'.$country->first_admin_level_label.'</font></td><td><font color="#FFFFFF">Reporting Sites</font></td><td><font color="#FFFFFF">No. Sentinal Sites</font></td><td><font color="#FFFFFF">Completeness</font></td></tr>';

                $bgcolor = 'bgcolor = "#CCCCCC"';
                $total_sites = 0;
                $total_sentinal = 0;

               //$current = 0;
                foreach($zones as $key=>$zone)
                {
                    $thezonehf = $this->healthfacilitiesmodel->get_by_zone($zone['id']);
                    $hfsinzone          = count($thezonehf->result());

                    $zone_reporting_sites = $this->formsmodel->getreportingsites($epicalendar->id, $dist_id,$reg_id,$zone['id'],$hf_id);
                    if ($zone_reporting_sites == 0) {
                        $percentagezonereporting = 0;
                    } else {
                        $percentagezonereporting = ($zone_reporting_sites / $hfsinzone) * 100;
                    }

                    $zonecategories .= "'" . $zone['zone'] . "',";

                    $zonereportingrate .= number_format($percentagezonereporting, 1) . ", ";

                    if($bgcolor == 'bgcolor = "#CCCCCC"')
                    {
                        $bgcolor = '';
                    }
                    else
                    {
                        $bgcolor = 'bgcolor = "#CCCCCC"';
                    }

                    $distribution_table .= '<tr '.$bgcolor.'><td>'.$zone['zone'] .'</td><td>'.$zone_reporting_sites.'</td><td>'.$hfsinzone.'</td><td>'.number_format($percentagezonereporting).'%</td></tr>';
                    $total_sites = $total_sites+$zone_reporting_sites;
                    $total_sentinal = $total_sentinal+$hfsinzone;

                    //$current++;
                    //$this->outputProgress($current, count($zones));
                    unset($thezonehf);
                    unset($hfsinzone);
                    unset($zone_reporting_sites);

                }

                $data['zonecategories'] = $zonecategories;
                $data['zonereportingrate'] = $zonereportingrate;
                unset($zonecategories);
                unset($zonereportingrate);

                $overal_percentage = ($total_sites/$total_sentinal)*100;

                $distribution_table .= '<tr bgcolor="#892A24"><td><font color="#FFFFFF">Total</font></td><td><font color="#FFFFFF">'.$total_sites.'</font></td><td><font color="#FFFFFF">'.$total_sentinal.'</font></td><td><font color="#FFFFFF">'.number_format($overal_percentage).'%</font></td></tr>';
                $distribution_table .= '</table>';

                unset($overal_percentage );
                unset($total_sites);
                unset($total_sentinal);

                //Four
                $current = $current+1;
                $this->outputProgress($current, $total);


                /****End consultations and reporting rates****/

                /***Number of alerts received and reported***/
                $alerts = $this->reportsmodel->get_full_list_alert_week($query_year,$current_year,$previousepi->id,$epicalendar->id,$dist_id,$reg_id,$zon_id,$hf_id,$diseasearray);

                $graphcategories = '';
                $alertseries = '';
                //$current = 0;

                foreach ($alerts as $key => $alert) {

                    $graphcategories .= "'Wk".$alert->week_no."',";
                }

                foreach($diseasearray as $key=>$diseasecode):

                    $alertseries .= "{
						name: '".$diseasecode."',
						data: [";

                    foreach ($alerts as $key => $alert) {

                        //$alert_element = $diseasecode;

                        $alertseries .= $alert->$diseasecode.",";

                    }

                    $alertseries .= "]";

                    $alertseries .= "},";

                    //$current++;
                   // $this->outputProgress($current, count($diseasearray));

                endforeach;

                unset($alerts);
                $data['graphcategories'] = $graphcategories;
                $data['alertseries'] = $alertseries;
                unset($graphcategories);
                unset($alertseries);
                //five
                $current = $current+1;

                $this->outputProgress($current, $total);

                /***End alerts received**/

                /******EPI curve******/

                $int_end_date = $week_array['week_start'];

                $int_start_date = date('Y-m-d', strtotime('-8 weeks', strtotime($int_end_date)));

                $epilists = $this->epdcalendarmodel->get_list_by_date($int_start_date,$int_end_date,$country_id);

                $epicalendaridArray = array();

                foreach($epilists as $key=>$epilist)
                {
                    $epicalendaridArray[] =  $epilist->id;

                }

                unset($int_end_date);
                unset($int_start_date);

                //$interest_lists = $this->reportsmodel->get_full_list_case_epi_week($reporting_year='',$reporting_year2='',$epicalendaridArray,$dist_id,$reg_id,$zon_id,$hf_id,$diseseinterestarray);
                $interestseries = '';
                $interestcategory = '';

                foreach($diseseinterestarray as $key=>$diseaseinterestcode):

                    $interestseries .= '{';
                    $interestseries .= "name: '".$diseaseinterestcode."',";
                    $interestseries .= 'data: [';

                    $diseaselists = $this->reportsmodel->get_list_disease_sum($epiArray, $dist_id, $reg_id, $zon_id, $hf_id,$diseaseinterestcode);
                    foreach($diseaselists as $key=>$diseaselist)
                    {
                        $interestseries .= $diseaselist->Disease_Total.',';
                    }


                    $interestseries .= ']';

                    $interestseries .= '},';

                    unset($diseaselists);

                endforeach;

                $data['interestcategory'] = $interestcategory;
                $data['interestseries'] = $interestseries;
                unset($interestcategory);
                unset($interestseries);
                //Six
                $current = $current+1;

                $this->outputProgress($current, $total);

                /********End EPI curve************/


                /*********Leading diseases section************/


                $leading_diseases = '<ul>';

                $diarrheal = '';
                $respiratory = '';

                $diarrheal_diseases = $this->diseasesmodel->get_by_category_country(2,$country_id);
                $respiratory_diseases = $this->diseasesmodel->get_by_category_country(1,$country_id);

                $allcases = 0;
                $malariacases = 0;
                $measlescases = 0;

                foreach ($highlightArray as $key => $value) {

                    $allcases = $allcases+$value;

                    if($key=='Mal')
                    {
                        $malariacases = $malariacases+$value;
                    }

                    if($key=='Meas')
                    {
                        $measlescases = $measlescases+$value;
                    }
                }


                $total_diarrheal = 0;
                foreach ($diarrheal_diseases as $thekey=>$diarrheal_disease):
                    foreach ($highlightArray as $key => $value) {

                        if($diarrheal_disease->disease_code==$key)
                        {

                            $diarrheal .= $key.'('.$value.' cases),';
                            $total_diarrheal = $total_diarrheal+$value;
                        }

                    }

                endforeach;
                unset($diarrheal_diseases);
                $percentage_diarrheal = ($total_diarrheal/$allcases)*100;

                $total_respiratory = 0;
                foreach ($respiratory_diseases as $thkey=>$respiratory_disease):
                    foreach ($highlightArray as $key => $value) {

                        if($respiratory_disease->disease_code==$key)
                        {
                            $respiratory .= $key.'('.$value.' cases),';

                            $total_respiratory = $total_respiratory+$value;
                        }


                    }

                endforeach;

                unset($respiratory_diseases);

                $percentage_respiratory = ($total_respiratory/$allcases)*100;
                $malaria_percent = ($malariacases/$allcases)*100;
                $measles_percent = ($measlescases/$allcases)*100;
                $upper_percent = $percentage_diarrheal+$percentage_respiratory;
                $other_percent = (100 - $upper_percent);

                $highest_disease_code =  $highest_disease[0];

                $leading_diseases .= '<li>Being the highest course of morbidity in the reporting week, '.$highest_highlight_num.' cases of '.$highest_disease_code.' where reported in '.$total_zones.' sates, out of these, the reported cases from the states included ';
                foreach($zones as $key=>$zone)
                {

                    $diseasenumber = $this->reportsmodel->get_full_zone_week($epicalendar->id, $dist_id, $reg_id, $zone['id'], $hf_id,$highest_disease_code);

                    if(!empty($diseasenumber))
                    {
                        $leading_diseases .= $diseasenumber->$highest_disease_code.' Cases from '.$zone['zone'].', ';
                    }

                    unset($diseasenumber);

                }

                $leading_diseases .= 'which were captured through the eWARN system.</li>';


                $leading_diseases .= '<li>The number of cases for all diarrheal diseases i.e '.$diarrheal.' comprised '.number_format($percentage_diarrheal).'% of all the cases reported in Epi-week '.$epicalendar->week_no.', '.$epicalendar->epdyear.'</li>';
                $leading_diseases .= '<li>Respiratory diseases, i.e. '.$respiratory.' accounted for '.number_format($percentage_respiratory).' % of total morbidity in the reporting period</li>';

                $leading_diseases .= '<li>'.$measlescases.' cases of suspected measles were reported with '.$malariacases.' cases of confirmed malaria, each accounting for '.number_format($measles_percent).'% and '.number_format($malaria_percent).'% of total morbidity respectively.</li>';
                $leading_diseases .= '<li>All together, other vaccine preventable diseases and communicable diseases accounted for '.number_format($other_percent).'% of total morbidity in all states this week</li>';
                $leading_diseases .= '</ul>';

                unset($percentage_respiratory);
                unset($malaria_percent);
                unset($measles_percent);
                unset($upper_percent);
                unset($other_percent);
                unset($measlescases);
                unset($malariacases);
                unset($diarrheal);
                unset($respiratory);

                //Seven
                $current = $current+1;

                $this->outputProgress($current, $total);


                /**********************End**********************/

                /*************Disease outbreak in states******************/

                $outbreakcategories = '';
                $outbreakseries = '';

                foreach($zones as $key=>$zone) {

                    $diseasenumbers = $this->reportsmodel->get_full_list_zone_week($epicalendaridArray, $dist_id, $reg_id, $zone['id'], $hf_id, $highest_disease_code);
                    $outbreakseries .= '{';
                    $outbreakseries .= "name: '".$zone['zone']."',";
                    $outbreakseries .= 'data: [';

                    foreach($diseasenumbers as $key=>$diseasenumber)
                    {
                        $outbreakseries .= number_format($diseasenumber->$highest_disease_code).',';

                        $outbreakcategories .= "'WK.".$diseasenumber->week_no."',";

                    }

                    $outbreakseries .= ']';

                    $outbreakseries .= '},';

                    unset($diseasenumbers);

                }

                $data['outbreakcategories'] = $outbreakcategories;
                $data['outbreakseries'] = $outbreakseries;
                unset($outbreakcategories);
                unset($outbreakseries);

                $piedata = '';
                $i=0;

                foreach ($highlightArray as $key => $value) {
                    $i++;
                    $diseasepercent = ($value/$allcases)*100;

                    if($i==5)
                    {
                        $piedata .= "{
                        name: '".$key."',
                        y:  ".number_format($diseasepercent).",
                        sliced: true,
                        selected: true
                        },";
                    }
                    else{
                        $piedata .= " ['".$key."',    ".number_format($diseasepercent)."],";
                    }

                    unset($diseasepercent);

                }

                $data['piedata'] = $piedata;
                unset($piedata);

                //Eight
                $current = $current+1;

                $this->outputProgress($current, $total);

                /*******************End disease outbreak in states******/


                /******************Weekly trends****************************/

                $previous_year = ($current_year-1);

                //previous year EPI calendar array
                $previousepiarray = array();

                foreach($epilists as $key=>$epilist)
                {
                    $previousepicalendar = $this->epdcalendarmodel->get_by_year_week_country($previous_year,$epilist->week_no,$country_id)->row();
                    $previousepiarray[] =  $previousepicalendar->id;

                    unset($previousepicalendar);
                }

                //respiratory diseases
                $respcategory = '';
                $resplists = $this->reportsmodel->get_list_category_sum($epicalendaridArray, $dist_id, $reg_id, $zon_id, $hf_id,1);
                $respseries = '{';
                $respseries .= "name: '".$current_year."',";
                $respseries .= 'data: [';

                foreach($resplists as $key=>$resplist)
                {
                    $weekcases = $this->reportsmodel->get_list_sum($resplist->epicalendar_id, $dist_id, $reg_id, $zon_id, $hf_id);
                    $resppercent = ($resplist->Category_Total/$weekcases)*100;
                    $respseries .= number_format($resppercent).',';

                    $respcategory .= "'WK.".$resplist->week_no."',";
                    unset($weekcases);

                }

                unset($resplists);

                $respseries .= ']';

                $respseries .= '},';

                $respprevlists = $this->reportsmodel->get_list_category_sum($previousepiarray, $dist_id, $reg_id, $zon_id, $hf_id,1);
                $respseries .= '{';
                $respseries .= "name: '".$previous_year."',";
                $respseries .= 'data: [';

                foreach($respprevlists as $key=>$respprevlist)
                {
                    $prevweekcases = $this->reportsmodel->get_list_sum($respprevlist->epicalendar_id, $dist_id, $reg_id, $zon_id, $hf_id);
                    $respprevpercent = ($respprevlist->Category_Total/$prevweekcases)*100;
                    $respseries .= number_format($respprevpercent).',';

                    unset($prevweekcases);
                }

                unset($respprevlists);

                $respseries .= ']';

                $respseries .= '},';

                //Nine
                $current = $current+1;

                $this->outputProgress($current, $total);

                //Gastro intestinal diseases
                $gastrolists = $this->reportsmodel->get_list_category_sum($epicalendaridArray, $dist_id, $reg_id, $zon_id, $hf_id,2);
                $gastroseries = '{';
                $gastroseries .= "name: '".$current_year."',";
                $gastroseries .= 'data: [';

                foreach($gastrolists as $key=>$gastrolist)
                {
                    $weekcases = $this->reportsmodel->get_list_sum($gastrolist->epicalendar_id, $dist_id, $reg_id, $zon_id, $hf_id);
                    $gastropercent = ($gastrolist->Category_Total/$weekcases)*100;
                    $gastroseries .= number_format($gastropercent).',';

                    unset($weekcases);

                }

                unset($gastrolists);

                $gastroseries .= ']';

                $gastroseries .= '},';

                $prevgastrolists = $this->reportsmodel->get_list_category_sum($previousepiarray, $dist_id, $reg_id, $zon_id, $hf_id,1);
                $gastroseries .= '{';
                $gastroseries .= "name: '".$previous_year."',";
                $gastroseries .= 'data: [';

                foreach($prevgastrolists as $key=>$prevgastrolist)
                {
                    $prevweekcases = $this->reportsmodel->get_list_sum($prevgastrolist->epicalendar_id, $dist_id, $reg_id, $zon_id, $hf_id);
                    $gastoprevpercent = ($prevgastrolist->Category_Total/$prevweekcases)*100;
                    $gastroseries .= number_format($gastoprevpercent).',';

                    unset($prevweekcases);

                }

                unset($prevgastrolists);

                $gastroseries .= ']';

                $gastroseries .= '},';

                //Ten
                $current = $current+1;

                $this->outputProgress($current, $total);

                //measles
                $measleslists = $this->reportsmodel->get_list_disease_sum($epicalendaridArray, $dist_id, $reg_id, $zon_id, $hf_id,'Meas');
                $measseries = '{';
                $measseries .= "name: '".$current_year."',";
                $measseries .= 'data: [';

                foreach($measleslists as $key=>$measleslist)
                {
                    $weekcases = $this->reportsmodel->get_list_sum($measleslist->epicalendar_id, $dist_id, $reg_id, $zon_id, $hf_id);
                    $measpercent = ($measleslist->Disease_Total/$weekcases)*100;
                    $measseries .= number_format($measpercent).',';

                    unset($weekcases);

                }

                unset($measleslists);


                $measseries .= ']';

                $measseries .= '},';

                $prevmeaslists = $this->reportsmodel->get_list_disease_sum($previousepiarray, $dist_id, $reg_id, $zon_id, $hf_id,'Meas');

                $measseries .= '{';
                $measseries .= "name: '".$previous_year."',";
                $measseries .= 'data: [';

                foreach($prevmeaslists as $key=>$prevmeaslist)
                {
                    $prevweekcases = $this->reportsmodel->get_list_sum($prevmeaslist->epicalendar_id, $dist_id, $reg_id, $zon_id, $hf_id);
                    $measprevpercent = ($prevmeaslist->Disease_Total/$prevweekcases)*100;
                    $measseries .= number_format($measprevpercent).',';
                    unset($prevweekcases);

                }
                unset($prevmeaslists);

                $measseries .= ']';

                $measseries .= '},';

                //malaria
                $malarialists = $this->reportsmodel->get_list_disease_sum($epicalendaridArray, $dist_id, $reg_id, $zon_id, $hf_id,'Mal');
                $malsearies = '{';
                $malsearies .= "name: '".$current_year."',";
                $malsearies .= 'data: [';

                foreach($malarialists as $key=>$malarialist)
                {
                    $weekcases = $this->reportsmodel->get_list_sum($malarialist->epicalendar_id, $dist_id, $reg_id, $zon_id, $hf_id);
                    $malspercent = ($malarialist->Disease_Total/$weekcases)*100;
                    $malsearies .= number_format($malspercent).',';

                    unset( $weekcases);

                }
                unset($malarialists);

                $malsearies .= ']';

                $malsearies .= '},';

                $prevmallists = $this->reportsmodel->get_list_disease_sum($previousepiarray, $dist_id, $reg_id, $zon_id, $hf_id,'Mal');

                $malsearies .= '{';
                $malsearies .= "name: '".$previous_year."',";
                $malsearies .= 'data: [';

                foreach($prevmallists as $key=>$prevmallist)
                {
                    $prevweekcases = $this->reportsmodel->get_list_sum($prevmallist->epicalendar_id, $dist_id, $reg_id, $zon_id, $hf_id);
                    $malsprevpercent = ($prevmallist->Disease_Total/$prevweekcases)*100;
                    $malsearies .= number_format($malsprevpercent).',';
                    unset($prevweekcases);

                }

                unset($prevmallists);

                $malsearies .= ']';

                $malsearies .= '},';

                $data['respseries'] = $respseries;
                $data['respcategory'] = $respcategory;
                $data['gastroseries'] = $gastroseries;
                $data['measseries'] = $measseries;
                $data['malsearies'] = $malsearies;

                unset($respseries);
                unset($respcategory);
                unset($gastroseries);
                unset($measseries);
                unset($malsearies);

                //Eleven
                $current = $current+1;

                $this->outputProgress($current, $total);

                /******************End Weekly trends****************************/

                /***********************summary of diseases*************************************/

                $caselists = $this->reportsmodel->get_full_list_case_week($first_year,$last_year,$previousepi->id,$epicalendar->id,$dist_id,$reg_id,$zon_id,$hf_id,$diseasearray);

                //$caselists = $this->formsmodel->get_full_list($first_year, $last_year, $previousepi->id,$epicalendar->id, $dist_id, $reg_id, $zon_id, $hf_id,$diseasearray);

                //get previous week data
               // $previouslists = $this->reportsmodel->get_full_list_case_single_week($previousepi->id,$dist_id,$reg_id,$zon_id,$hf_id,$diseasearray);

                $leadingdiseasetable = '<table id="datatable" width="100%" border="1" cellspacing="0" cellpadding="2" bordercolor="#892a24">';
                $leadingdiseasetable .= '<tr bgcolor="#892A24" bordercolor="#892A24"><td><font color="#FFFFFF">Disease/syndrome</font></td>';

                foreach ($caselists as $key => $caselist):

                    $leadingdiseasetable .='<td colspan="3" align="center"><font color="#FFFFFF">Epi week ' . $caselist->week_no . '</font></td>';

                endforeach;

                $leadingdiseasetable .= '</tr>';
                $leadingdiseasetable .= '<tr bgcolor="#892A24"><td>&nbsp;</td><td><font color="#FFFFFF">Cases &lt;5</font></td><td><font color="#FFFFFF">Cases &gt;5</font></td><td><font color="#FFFFFF">Total Cases</font></td><td><font color="#FFFFFF">Cases &lt;5</font></td><td><font color="#FFFFFF">Cases &gt;5</font></td><td><font color="#FFFFFF">Total Cases</font></td></tr>';

                $total_current_week = 0;
                $total_previous_week = 0;
                $bg_color = 'bgcolor="#CCCCCC"';

                //$current = 0;

                foreach($diseasearray as $key=>$highestdiseasecode)
                {

                    if($bg_color == 'bgcolor="#CCCCCC"')
                    {
                        $bg_color = '';
                    }
                    else
                    {
                        $bg_color = 'bgcolor="#CCCCCC"';
                    }
                    $leadingdiseasetable .= '<tr '.$bg_color.'><td>'.$highestdiseasecode.'</td>';
                    foreach ($caselists as $key => $caselist):

                        //$high_disease_element = $highestdiseasecode;
                        $under_five_element = $highestdiseasecode.'_T_U_F';
                        $over_five_element = $highestdiseasecode.'_T_O_F';

                        if($caselist->epicalendar_id==$epicalendar->id)
                        {
                            $total_current_week = $total_current_week+$caselist->$highestdiseasecode;

                        }
                        else
                        {


                            $total_previous_week = $total_previous_week+$caselist->$highestdiseasecode;
                        }

                        $leadingdiseasetable .= '<td>'.number_format($caselist->$under_five_element).'</td><td>'.number_format($caselist->$over_five_element).'</td><td>'.number_format($caselist->$highestdiseasecode).'</td>';

                       unset($under_five_element);
                       unset($over_five_element);
                    endforeach;

                    $leadingdiseasetable .= '</tr>';

                    //$current++;
                    //$this->outputProgress($current, count($diseasearray));
                }


                $leadingdiseasetable .= '</table>';

                //Twelve
                $current = $current+1;

                $this->outputProgress($current, $total);


                /*******************End summary of diseases****************************/


                /***************Reporting facilities table*******************/

                $colspan = ($total_zones+1);

               //$zonedistributiontable .= '<tr bgcolor="#892A24"><td><font color="#FFFFFF">Suspected Disease</font></td>';

                $reportintable =' <table id="datatable" width="100%" border="1" cellpadding="3" cellspacing="0">
                <tr bgcolor="#892A24"><td colspan="'.$colspan.'"><font color="#FFFFFF">Reporting of health facilities , No.# of districts and patients consultations in week '.$epicalendar->week_no.', '.$epicalendar->epdyear.'</font></td></tr>

            ';

                $reportintable .='<tr bgcolor="#892A24"><td>&nbsp;</td>';

                foreach($zones as $key=>$zone) {
                    $reportintable .='<td><font color="#FFFFFF">'.$zone['zone'].'</font></td>';
                    //$zonedistributiontable .= '<td><font color="#FFFFFF">'.$zone['zone'].'</font></td>';
                }
                $reportintable .='</tr>';
                //$zonedistributiontable .= '</tr>';

                $reportintable .='<tr><td bgcolor="#892A24"><font color="#FFFFFF"># Of '.$country->third_admin_level_label.'</font></td>';

                foreach($zones as $key=>$zone) {
                    $zonedistrictlist = $this->districtsmodel->get_list_by_parameters($country_id,$zone['id'],$reg_id);
                    $zonedistricts = count($zonedistrictlist);
                    $reportintable .='<td>'.$zonedistricts.'</td>';
                    unset($zonedistrictlist);
                    unset($zonedistricts);
                }

                $reportintable .='</tr>';

                $reportintable .='<tr><td bgcolor="#892A24"><font color="#FFFFFF">No.# Of Reps. Wk-'.$epicalendar->week_no.'</font></td>';

                foreach($zones as $key=>$zone) {
                    $zone_reporting_sites = $this->formsmodel->getreportingsites($epicalendar->id, $dist_id,$reg_id,$zone['id'],$hf_id);
                    $reportintable .='<td>'.$zone_reporting_sites.'</td>';
                    unset($zone_reporting_sites);
                }

                $reportintable .='</tr>';

                $reportintable .='<tr><td bgcolor="#892A24"><font color="#FFFFFF">Patients Cons.</font></td>';

                foreach($zones as $key=>$zone) {
                    $zone_consultations = $this->formsmodel->getconsultations($epicalendar->id, $dist_id, $reg_id, $zone['id'], $hf_id);
                    $reportintable .='<td>'.$zone_consultations.'</td>';
                    unset($zone_consultations);
                }

                $reportintable .='</tr>';

                $reportintable .= '</table>';

                //Thirteen
                $current = $current+1;

                $this->outputProgress($current, $total);


                /***************End reporting facilities table*******************/

                /*********************Distribution by states****************************/


                $zonearray = array();

                $colspan = ($limit+2);

                foreach($zones as $key=>$zone)
                {
                    $zonearray[] = $zone['id'];
                }

                $zonediseases = $this->formsmodel->zone_disease_week($epicalendar->id,$zonearray,$diseasearray);

                $zonedistributiontable = '<table width="100%" cellpadding="3" cellspacing="0">
		<tr bgcolor="#892A24"><td colspan="'.$colspan.'"><font color="#FFFFFF">Distribution of consultations of leading diseases by '.$country->first_admin_level_label.', Epi week '.$epicalendar->week_no.'</font></td></tr>
        ';
                $zonedistributiontable .= '<tr bgcolor="#892A24"><td><font color="#FFFFFF">'.$country->first_admin_level_label.'</font></td>';

                foreach($diseasearray as $key=>$highestdiseasecode)
                {
                    $zonedistributiontable .= '<td><font color="#FFFFFF">'.$highestdiseasecode.'</font></td>';

                }

                $zonedistributiontable .= '<td><font color="#FFFFFF">Total</font></td></tr>';


                foreach($zonediseases as $key=>$zonedisease):

                    if($bg_color == 'bgcolor="#CCCCCC"')
                    {
                        $bg_color = '';
                    }
                    else
                    {
                        $bg_color = 'bgcolor="#CCCCCC"';
                    }

                    $zonedistributiontable .= '<tr '.$bg_color.'><td>'.$zonedisease->zone.'</td>';
                    $tot = 0;

                    foreach($diseasearray as $thekey=>$highestdiseasecode)
                    {
                        $zonedistributiontable .= '<td>'.$zonedisease->$highestdiseasecode.'</td>';
                        $tot = ($tot+$zonedisease->$highestdiseasecode);

                    }

                    $zonedistributiontable .= '<td>'.$tot.'</td></tr>';

                    unset($tot);

                endforeach;

               //$this->outputProgress($current, count($zonediseases));

                $zonedistributiontable .= '</table>';

                //Fourteen
                $current = $current+1;

                $this->outputProgress($current, $total);

                /*********************End of distribution table*************************/


                /********Alerts Table**********************/

                $districts = $this->districtsmodel->get_by_country($country_id);

                $districtarray = array();

                foreach($districts as $key=>$district)
                {
                    $districtarray[] = $district->id;
                }

                $districtalerts = $this->formalertsmodel->district_disease_alerts($epicalendar->id,$districtarray,$diseasearray);

                $alertstable = '<table width="100%" cellpadding="3" cellspacing="0">
		<tr bgcolor="#892A24"><td colspan="'.$colspan.'"><font color="#FFFFFF">Alert numbers by '.$country->third_admin_level_label.', Epi week '.$epicalendar->week_no.'</font></td></tr>
        ';
                $alertstable .= '<tr bgcolor="#892A24"><td><font color="#FFFFFF">'.$country->third_admin_level_label.'</font></td>';

                foreach($diseasearray as $key=>$highestdiseasecode)
                {
                    $alertstable .= '<td><font color="#FFFFFF">'.$highestdiseasecode.'</font></td>';

                }

                $alertstable .= '<td><font color="#FFFFFF">Total</font></td></tr>';


                foreach($districtalerts as $key=>$districtalert):


                    $alertstable .= '<tr><td bgcolor="#892A24"><font color="#FFFFFF">'.$districtalert->district.'</font></td>';
                    $tot = 0;

                    foreach($diseasearray as $thekey=>$highestdiseasecode)
                    {

                        if(empty($districtalert->$highestdiseasecode))
                        {
                            $thecases = 0;
                            $tdbg = 'bgcolor = "#ffffb3"';
                        }
                        else{
                            $thecases = $districtalert->$highestdiseasecode;
                            $tdbg = '';
                        }
                        $alertstable .= '<td '.$tdbg.'>'.$thecases.'</td>';
                        $tot = ($tot+$districtalert->$highestdiseasecode);

                    }

                    $alertstable .= '<td>'.$tot.'</td></tr>';

                    unset($tdbg);

                endforeach;


                $alertstable .= '</table>';
                $data['alertstable'] = $alertstable;


                /********End Alerts Table**********************/

                $highlight_entry = $highlight;
                $highlight_entry .= '<p>'.$distribution_table.'</p>';

                //Fifteen
                $current = $current+1;

                $this->outputProgress($current, $total);

                $bulletindata = array(
                    'epicalendar_id' => $epicalendar->id,
                    'week_no' => $epicalendar->week_no,
                    'week_year' => $epicalendar->epdyear,
                    'from_date' => $epicalendar->from,
                    'to_date' => $epicalendar->to,
                    'country_id' => $country_id,
                    'highlight' => $highlight_entry,
                    'highlight_text' => '<p></p>',
                    'reporting_rates_graph' => '-',
                    'distribution_rates_graph' => '-',
                    'alerts_graph' => '-',
                    'epi_curve' => '-',
                    'leading_causes' => $leading_diseases,
                    'interventions' => 'Please enter interventions done.....',
                    'leadingdisease_curve' => '-',
                    'proportional_morbidity' => '-',
                    'respiratory_curve' => '-',
                    'gastro_curve' => '-',
                    'measles_curve' => '-',
                    'malaria_curve' => '-',
                    'leadingdiseasetable' => $leadingdiseasetable,
                    'reportintable' => $reportintable,
                    'zonedistributiontable' => $zonedistributiontable,
                    'alertstable' => $alertstable,
                    'creation_date_time' => date("Y-m-d H:i:s"),
                );

                $this->db->insert('epibulletins', $bulletindata);
                $bulletin_id = $this->db->insert_id();

                //Sixteen
                $current = $current+1;

                $this->outputProgress($current, $total);

                $data['bulletin_id'] = $bulletin_id;
                $data['last_week'] = $last_week;
                $data['first_week'] = $first_week;
                $data['first_year'] = $first_year;
                $data['last_year'] = $last_year;
                $data['epicalendar'] =  $epicalendar;
                $data['highlight'] = $highlight;
                $data['country'] = $country;
                $data['categories'] = $categories;
                $data['total_facilities'] = $total_facilities;
                $data['distribution_table'] = $distribution_table;
                $data['bgcolor'] = $bgcolor;
                $data['colors'] = $colors;
                $data['leading_diseases'] = $leading_diseases;
                $data['highest_disease_code'] = $highest_disease_code;
                $data['previous_year'] = $previous_year;
                $data['leadingdiseasetable'] = $leadingdiseasetable;
                $data['reportintable'] = $reportintable;
                $data['zonedistributiontable'] = $zonedistributiontable;


                $this->load->view('epibulletins/buletintemplate', $data);

            }//end bulettin availability check


        }//end form validation
    }

     public function rates()
    {
        $url = $_POST['url'];
        $object = $_POST['object'];
        $link = $url.''.$object;

        $country = $_POST['country'];
        $week_no = $_POST['week_no'];
        $week_year = $_POST['week_year'];
        $bulletin_id = $_POST['bulletin_id'];

        $image = file_get_contents($link);

        $fp  = fopen('./images/reportelements/rates_'.$country.'_'.$week_no.'_'.$week_year.'.jpg', 'w+');


        $reporting_rates_graph = 'rates_'.$country.'_'.$week_no.'_'.$week_year.'.jpg';


        fputs($fp, $image);
        fclose($fp);
        unset($image);

        $data = array(
            'reporting_rates_graph' => $reporting_rates_graph,
        );
        $this->db->where('id', $bulletin_id);
        $this->db->update('epibulletins', $data);
    }


    public function download()
    {

        $url = $_POST['url'];
        $object = $_POST['object'];
        $link = $url.''.$object;

        $country = $_POST['country'];
        $week_no = $_POST['week_no'];
        $week_year = $_POST['week_year'];
        $bulletin_id = $_POST['bulletin_id'];

        $image = file_get_contents($link);

        $fp  = fopen('./images/reportelements/distribution_'.$country.'_'.$week_no.'_'.$week_year.'.jpg', 'w+');


        $distribution_rates_graph = 'distribution_'.$country.'_'.$week_no.'_'.$week_year.'.jpg';


        fputs($fp, $image);
        fclose($fp);
        unset($image);

        $data = array(
            'distribution_rates_graph' => $distribution_rates_graph,
        );
        $this->db->where('id', $bulletin_id);
        $this->db->update('epibulletins', $data);


    }

    public function alerts()
    {
        $url = $_POST['url'];
        $object = $_POST['object'];
        $link = $url.''.$object;

        $country = $_POST['country'];
        $week_no = $_POST['week_no'];
        $week_year = $_POST['week_year'];
        $bulletin_id = $_POST['bulletin_id'];

        $image = file_get_contents($link);

        $fp  = fopen('./images/reportelements/alerts_'.$country.'_'.$week_no.'_'.$week_year.'.jpg', 'w+');


        $alerts_graph = 'alerts_'.$country.'_'.$week_no.'_'.$week_year.'.jpg';


        fputs($fp, $image);
        fclose($fp);
        unset($image);

        $data = array(
            'alerts_graph' => $alerts_graph,
        );
        $this->db->where('id', $bulletin_id);
        $this->db->update('epibulletins', $data);
    }


    public function epicurve()
    {

        $url = $_POST['url'];
        $object = $_POST['object'];
        $link = $url.''.$object;

        $country = $_POST['country'];
        $week_no = $_POST['week_no'];
        $week_year = $_POST['week_year'];
        $bulletin_id = $_POST['bulletin_id'];

        $image = file_get_contents($link);

        $fp  = fopen('./images/reportelements/epicurve_'.$country.'_'.$week_no.'_'.$week_year.'.jpg', 'w+');


        $epi_curve = 'epicurve_'.$country.'_'.$week_no.'_'.$week_year.'.jpg';


        fputs($fp, $image);
        fclose($fp);
        unset($image);

        $data = array(
            'epi_curve' => $epi_curve,
        );
        $this->db->where('id', $bulletin_id);
        $this->db->update('epibulletins', $data);


    }

    public function leadingdisease()
    {

        $url = $_POST['url'];
        $object = $_POST['object'];
        $link = $url.''.$object;

        $country = $_POST['country'];
        $week_no = $_POST['week_no'];
        $week_year = $_POST['week_year'];
        $bulletin_id = $_POST['bulletin_id'];

        $image = file_get_contents($link);

        $fp  = fopen('./images/reportelements/leadingdisease_'.$country.'_'.$week_no.'_'.$week_year.'.jpg', 'w+');


        $leadingdisease_curve = 'leadingdisease_'.$country.'_'.$week_no.'_'.$week_year.'.jpg';


        fputs($fp, $image);
        fclose($fp);
        unset($image);

        $data = array(
            'leadingdisease_curve' => $leadingdisease_curve,
        );
        $this->db->where('id', $bulletin_id);
        $this->db->update('epibulletins', $data);

    }

    public function proportionalmorbidy()
    {

        $url = $_POST['url'];
        $object = $_POST['object'];
        $link = $url.''.$object;

        $country = $_POST['country'];
        $week_no = $_POST['week_no'];
        $week_year = $_POST['week_year'];
        $bulletin_id = $_POST['bulletin_id'];

        $image = file_get_contents($link);

        $fp  = fopen('./images/reportelements/proportional_morbidity'.$country.'_'.$week_no.'_'.$week_year.'.jpg', 'w+');


        $proportional_morbidity = 'proportional_morbidity'.$country.'_'.$week_no.'_'.$week_year.'.jpg';


        fputs($fp, $image);
        fclose($fp);
        unset($image);

        $data = array(
            'proportional_morbidity' => $proportional_morbidity,
        );
        $this->db->where('id', $bulletin_id);
        $this->db->update('epibulletins', $data);

    }

    public function respiratory()
    {

        $url = $_POST['url'];
        $object = $_POST['object'];
        $link = $url.''.$object;

        $country = $_POST['country'];
        $week_no = $_POST['week_no'];
        $week_year = $_POST['week_year'];
        $bulletin_id = $_POST['bulletin_id'];

        $image = file_get_contents($link);

        $fp  = fopen('./images/reportelements/respiratory_curve_'.$country.'_'.$week_no.'_'.$week_year.'.jpg', 'w+');


        $respiratory_curve = 'respiratory_curve_'.$country.'_'.$week_no.'_'.$week_year.'.jpg';


        fputs($fp, $image);
        fclose($fp);
        unset($image);

        $data = array(
            'respiratory_curve' => $respiratory_curve,
        );
        $this->db->where('id', $bulletin_id);
        $this->db->update('epibulletins', $data);

    }

    public function gastro()
    {

        $url = $_POST['url'];
        $object = $_POST['object'];
        $link = $url.''.$object;

        $country = $_POST['country'];
        $week_no = $_POST['week_no'];
        $week_year = $_POST['week_year'];
        $bulletin_id = $_POST['bulletin_id'];

        $image = file_get_contents($link);

        $fp  = fopen('./images/reportelements/gastro_curve_'.$country.'_'.$week_no.'_'.$week_year.'.jpg', 'w+');


        $gastro_curve = 'gastro_curve_'.$country.'_'.$week_no.'_'.$week_year.'.jpg';


        fputs($fp, $image);
        fclose($fp);
        unset($image);

        $data = array(
            'gastro_curve' => $gastro_curve,
        );
        $this->db->where('id', $bulletin_id);
        $this->db->update('epibulletins', $data);

    }

    public function malaria()
    {

        $url = $_POST['url'];
        $object = $_POST['object'];
        $link = $url.''.$object;

        $country = $_POST['country'];
        $week_no = $_POST['week_no'];
        $week_year = $_POST['week_year'];
        $bulletin_id = $_POST['bulletin_id'];

        $image = file_get_contents($link);

        $fp  = fopen('./images/reportelements/malaria_curve_'.$country.'_'.$week_no.'_'.$week_year.'.jpg', 'w+');


        $malaria_curve = 'malaria_curve_'.$country.'_'.$week_no.'_'.$week_year.'.jpg';


        fputs($fp, $image);
        fclose($fp);
        unset($image);

        $data = array(
            'malaria_curve' => $malaria_curve,
        );
        $this->db->where('id', $bulletin_id);
        $this->db->update('epibulletins', $data);

    }

    public function measles()
    {

        $url = $_POST['url'];
        $object = $_POST['object'];
        $link = $url.''.$object;

        $country = $_POST['country'];
        $week_no = $_POST['week_no'];
        $week_year = $_POST['week_year'];
        $bulletin_id = $_POST['bulletin_id'];

        $image = file_get_contents($link);

        $fp  = fopen('./images/reportelements/measles_curve_'.$country.'_'.$week_no.'_'.$week_year.'.jpg', 'w+');


        $measles_curve = 'measles_curve_'.$country.'_'.$week_no.'_'.$week_year.'.jpg';


        fputs($fp, $image);
        fclose($fp);
        unset($image);

        $data = array(
            'measles_curve' => $measles_curve,
        );
        $this->db->where('id', $bulletin_id);
        $this->db->update('epibulletins', $data);

    }

    public function downloadpdf($id)
    {
        //create new PDF document
        $pdf = new Pdf(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);

        // set document information
        $pdf->SetCreator(PDF_CREATOR);
        $pdf->SetAuthor('WHO EMRO');
        $pdf->SetTitle('EPI Weekly Bulletin');
        $pdf->SetSubject('WHO EMRO Weekly Bulletin');
        $pdf->SetKeywords('WHO, EMRO, Bulletin, Diseases','Surveillance','EPI','Alerts');

        // set default header data
        $pdf->SetHeaderData(false, false, '', '');


        // set header and footer fonts
        $pdf->setHeaderFont(Array(PDF_FONT_NAME_MAIN, '', PDF_FONT_SIZE_MAIN));
        $pdf->setFooterFont(Array(PDF_FONT_NAME_DATA, '', PDF_FONT_SIZE_DATA));

        // set default monospaced font
        $pdf->SetDefaultMonospacedFont(PDF_FONT_MONOSPACED);


        //set margins
        //$pdf->SetMargins(PDF_MARGIN_LEFT, PDF_MARGIN_TOP, PDF_MARGIN_RIGHT);
        $pdf->SetMargins(9,9,9,9);
        $pdf->SetHeaderMargin(PDF_MARGIN_HEADER);
        $pdf->SetFooterMargin(PDF_MARGIN_FOOTER);

        //set auto page breaks
        $pdf->SetAutoPageBreak(TRUE, PDF_MARGIN_BOTTOM);

        //set image scale factor
        $pdf->setImageScale(PDF_IMAGE_SCALE_RATIO);

        //set some language-dependent strings
        //$pdf->setLanguageArray($l);

        // ---------------------------------------------------------

        // set font
        $pdf->SetFont('dejavusans', '', 8);

        $pdf->SetPrintHeader(false);

        // add a page
        //$pdf->AddPage('L','A4');
        $pdf->AddPage();

        $row = $this->db->get_where('epibulletins', array('id' => $id))->row();
        $country = $this->countriesmodel->get_by_id($row->country_id)->row();
        $last_year = $row->week_year-1;

        $week_array = $this->getStartAndEndDate($row->week_no,$row->week_year);

        $end_date = $week_array['week_start'];

        $start_date = date('Y-m-d', strtotime('-9 weeks', strtotime($end_date)));

        $ddate = $start_date;
        $date = new DateTime($ddate);
        $start_week = $date->format("W");
        $resp_start = $start_week+2;

        list($year) = explode("-", $start_date);

        $epicalendar = $this->epdcalendarmodel->get_by_id($row->epicalendar_id)->row();


        $html = '<table width="100%" cellpadding="3" cellspacing="0" border="2" bordercolor="#999999">
        <tr><td align="center"><img src="'. base_url().'images/header.png" alt=""></td></tr>
        <tr bgcolor="#1f7eb8"><th align="center"><center>
        <font color="#FFFFFF"><strong>Epi Week '.$epicalendar->week_no.', '. date("d F Y", strtotime($epicalendar->from)).' - '.date("d F Y", strtotime($epicalendar->to)).'</strong></font></center>
        </th></tr>';

        $highlight_text = $this->strip_HTML_tags($row->highlight_text);

        $html .= '<tr><td>
<table width="100%" cellpadding="2" cellspacing="2" id="customers">
		<tr>
		<td bgcolor="#892A24" width="50%">
		<font color="#FFFFFF"><strong>Highlights</strong></font>
		</td>
		<td bgcolor="#892A24" width="50%">
		<font color="#FFFFFF"><strong>eDEWS Reporting Rates vs Consultations in All '.$country->first_admin_level_label.' in '.$country->country_name.' Epi weeks '.$start_week.' to '.$row->week_no.', '.$row->week_year.'</strong></font>
		</td>
		</tr>
		<tr>
		<td valign="top">'.$row->highlight.'
		'.$row->highlight_text.'
</td>
		<td valign="top">
		<img src="'. base_url().'images/reportelements/'.$row->reporting_rates_graph.'" height="250" alt="">
		<hr>
	<p><font size="6"> <strong>Distribution of Reporting Rates by States (Epi-week '.$row->week_no.' , '.$row->week_year.')</strong></font></p>
		
		<img src="'. base_url().'images/reportelements/'.$row->distribution_rates_graph.'" height="200" alt="">
		</td>
		</tr>
		</table>
        </td></tr>';


        $html .= '<tr><td>
<table width="100%" cellpadding="2" cellspacing="2" id="customers">
		<tr>
		<td bgcolor="#892A24" width="50%">
		<font color="#FFFFFF"><strong>Number of alerts received and reported</strong></font>
		</td>
		<td bgcolor="#892A24" width="50%">
		<font color="#FFFFFF"><strong>Epi curve for priority diseases weeks '.$start_week.' '.$year.' to '.$row->week_no.' '.$row->week_year.'</strong></font>
		</td>
		</tr>
		
		<tr>
		<td>
		<img src="'. base_url().'images/reportelements/'.$row->alerts_graph.'>" height="200" alt="">		
        </td>
		<td>
		
		<img src="'. base_url().'images/reportelements/'.$row->epi_curve.'" height="200" alt="">	
        </td>
        </tr>
		
		
		</table>
</td>

        </tr>';

        $html .= '</table>';

        $html .= '<br pagebreak="true">';

        $html .= '<table width="100%" cellpadding="3" cellspacing="0" border="2" bordercolor="#999999">';
        $html .= '<tr><td>
<table width="100%" cellpadding="2" cellspacing="2" id="customers">
		<tr>
		<td bgcolor="#892A24" width="50%">
		<font color="#FFFFFF"><strong>Leading causes of morbidity and mortality in Epi-week '.$row->week_no.' , '.$row->week_year.'</strong></font>
		</td>
		<td bgcolor="#892A24" width="50%">
		<font color="#FFFFFF"><strong>Leading disease outbreak in all states &amp; Proportional morbidity of leading priority diseases, Epi weeks '.$start_week.' to '.$row->week_no.', '.$row->week_year.'</strong></font>
		</td>
		</tr>
		<tr><td>
		'.$row->leading_causes.'
				
		<p align="justify">'.$row->interventions.'</p>
		</td>
        <td>
        <p> <img src="'. base_url().'images/reportelements/'.$row->leadingdisease_curve.'" height="200" alt=""></p>
       <hr>
       <div align="center"> <strong>Proportional Morbidity</strong></div>
       <p> <img src="'. base_url().'images/reportelements/'.$row->proportional_morbidity.'" height="200" alt=""></p>
        </td>
        </tr>
		
		</table>

        </td></tr>';

        $html .= '<tr><td><table width="100%" border="1" cellpadding="3" cellspacing="0">
		<tr bgcolor="#892A24"><td colspan="2"><font color="#FFFFFF">Weekly trends of Respiratory Diseases, Gastro Intestinal Tract Diseases, Measles, and Suspected Malaria ( Epi week '.$resp_start.' to '.$row->week_no.', '.$last_year.' & '.$row->week_year.')</font></td></tr>
		
		<tr><td>
		<p><div align="center"><strong>Respiratory Diseases</strong></div></p>
		<img src="'. base_url().'images/reportelements/'.$row->respiratory_curve.'" height="250" alt="">
		</td>
		<td>
		<p><div align="center"><strong>Gastro Intestinal Tract Diseases</strong></div></p>
		<img src="'. base_url().'images/reportelements/'.$row->gastro_curve.'" height="250" alt="">
		</td>
		</tr>
		
		</table>

        </td></tr>';

        $html .= '</table>';

        $html .= '<br pagebreak="true">';

        $html .= '<table width="100%" cellpadding="3" cellspacing="0" border="2" bordercolor="#999999">';
        $html .= '<tr><td><table width="100%" border="1" cellpadding="3" cellspacing="0">
            <tr><td>
            <p><div align="center"><strong>Prop. Morb. of Measles</strong></div></p>
            <img src="'. base_url().'images/reportelements/'.$row->measles_curve.'" height="250" alt="">
            </td>
            <td>
            <p><div align="center"><strong>Trends for confirmed Malaria morbidity in Somalia</strong></div></p>
            <img src="'. base_url().'images/reportelements/'.$row->malaria_curve.'" height="250" alt="">
            </td>
            </tr>
		
		</table>
        </td></tr>';
        $html .= '<tr><td><table width="100%" cellpadding="3" cellspacing="0">
		<tr bgcolor="#892A24"><td><font color="#FFFFFF">Summary of Diseases Reported
</font></td></tr>

<tr><td>'.$row->leadingdiseasetable.'
		</td></tr>
		</table>
				
        </td></tr>';
        $html .= '</table>';

        $html .= '<table width="100%" cellpadding="3" cellspacing="0" >';

        $html .= '<tr><td>&nbsp;</td></tr>';

        $html .= '</table>';

        $html .= '<table width="100%" cellpadding="3" cellspacing="0"  border="2" bordercolor="#999999">';

        $html .= '<tr><td>'.$row->reportintable.'</td></tr>';

        $html .= '</table>';

        $html .= '<br pagebreak="true">';

        $html .= '<table width="100%" cellpadding="3" cellspacing="0" border="2" bordercolor="#999999">';

        $html .= '<tr><td>'.$row->zonedistributiontable.'</td></tr>';
        $html .= '<tr><td><font size="7">'.$row->alertstable.'</font></td></tr>';

        $html .= '</table>';


        $html .= '<br pagebreak="true">';

        $zones = $this->zonesmodel->get_country_list($country->id);

        $count = count($zones);
        $i=0;

        $zone_text = '';

        foreach($zones as $key=>$zone):
            $i++;
            if($i==$count){
                $coma = '';
            }
            else{
                $coma = ',';
            }
            $zone_text .= $zone['zone'].''.$coma;

        endforeach;

        $html .= '<table width="100%" cellpadding="3" cellspacing="0" border="2" bordercolor="#999999">';
        $html .= '<tr bgcolor="#892A24"><td><font color="#FFFFFF">The objective of this weekly epidemiological bulletin is to provide a snap shot on selected health events reported from the eWARN surveillance system in all '.$country->first_admin_level_label.' ('.$zone_text.') of '.$country->country_name.'. While every attempt is made to present the weekly trends of epidemic prone diseases, the information presented in the bulletin needs to be interpreted in the context that precise information on the reference populations is not always available. The bulletin also includes information collected by the eWARN teams. The primary focus of eWARN is early detection of epidemic prone desease, to facilitate a rapid public health response.</font></td></tr>
        <tr bgcolor="#cccccc"><td><p><strong>Abbreviations</strong></p>
        <p>*Epi=Epidemiological; Sus=Suspected; HF=Health Facility; SARI=Severe acute respiratory infection; ILI=Influenza like
illnesses; AWD=Acute Watery Diarrhea/Sus.Cholera; BD=Bloody Diarrhea/Sus.Shigellosis; OAD=Other Acute Diarrhea;
Diph=Suspected Diphtheria; WC=Suspected Whooping Cough; Meas=Suspected Measles; NNT=Neonatal Tetanus;
AFP=Acute Flaccid Paralysis; AJS=Suspected Acute Jaundice Syndrome; VHF=Suspected Viral Hemorrhagic Fever/Ebola;
Mal=Confirmed Malaria; Men=Suspected Meningitis; CSR=Communicable disease Surveillance and Response;
INT=Insecticides Treated Nets
</p>
        </td></tr>
        <tr bgcolor="#1f7eb8"><td><font color="#FFFFFF">This weekly Epidemiological bulletin is published jointly by the Health Authorities and the World Health Organization.
For further information, please contact the surveillance team on: '.$country->contact_email.'</font>
</td></tr>
        </table>';



        //echo $html;
        // output the HTML content
        $pdf->writeHTML($html, true, false, true, false, '');

        $txt = date("m/d/Y h:m:s");

        // print a block of text using Write()
        //$pdf->Write($h=0, $txt, $link='', $fill=0, $align='C', $ln=true, $stretch=0, $firstline=false, $firstblock=false, $maxh=0);
        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
        // test pre tag


        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

        // reset pointer to the last page
        $pdf->lastPage();
        ob_start();
        // ---------------------------------------------------------
        //ob_end_clean();
        //Close and output PDF document
        $pdf->Output('EPI_Bulletin_'.$country->country_code.'_'.$row->week_no.'_'.$row->week_year.'.pdf', 'I');


        //============================================================+
        // END OF FILE
        //============================================================+
    }

    public function downloadpdfold($id)
    {
        //create new PDF document
        $pdf = new Pdf(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);

        // set document information
        $pdf->SetCreator(PDF_CREATOR);
        $pdf->SetAuthor('WHO EMRO');
        $pdf->SetTitle('EPI Weekly Bulletin');
        $pdf->SetSubject('WHO EMRO Weekly Bulletin');
        $pdf->SetKeywords('WHO, EMRO, Bulletin, Diseases','Surveillance','EPI','Alerts');

        // set default header data
        $pdf->SetHeaderData(false, false, '', '');


        // set header and footer fonts
        $pdf->setHeaderFont(Array(PDF_FONT_NAME_MAIN, '', PDF_FONT_SIZE_MAIN));
        $pdf->setFooterFont(Array(PDF_FONT_NAME_DATA, '', PDF_FONT_SIZE_DATA));

        // set default monospaced font
        $pdf->SetDefaultMonospacedFont(PDF_FONT_MONOSPACED);


        //set margins
        //$pdf->SetMargins(PDF_MARGIN_LEFT, PDF_MARGIN_TOP, PDF_MARGIN_RIGHT);
        $pdf->SetMargins(8,8,8,8);
        $pdf->SetHeaderMargin(PDF_MARGIN_HEADER);
        $pdf->SetFooterMargin(PDF_MARGIN_FOOTER);

        //set auto page breaks
        $pdf->SetAutoPageBreak(TRUE, PDF_MARGIN_BOTTOM);

        //set image scale factor
        $pdf->setImageScale(PDF_IMAGE_SCALE_RATIO);

        //set some language-dependent strings
        //$pdf->setLanguageArray($l);

        // ---------------------------------------------------------

        // set font
        $pdf->SetFont('dejavusans', '', 9);

        $pdf->SetPrintHeader(false);

        // add a page
        //$pdf->AddPage('L','A4');
        $pdf->AddPage();

        $row = $this->db->get_where('epibulletins', array('id' => $id))->row();
        if(empty($row)) {
            redirect('epibulletins','refresh');
        }


        $country = $this->countriesmodel->get_by_id($row->country_id)->row();



        $html = '<table width="100%" cellpadding="3" cellspacing="0" border="1" bordercolor="#999999">
<tr><td><img src="'. base_url().'images/Header_title.png" alt=""></td></tr>
<tr bgcolor="#1f7eb8"><th align="center"><center>
<font color="#FFFFFF"><strong> Epi Week '.$row->week_no.', '.date("d F Y", strtotime($row->from_date)).' - '.date("d F Y", strtotime($row->to_date)).'</strong></font></center>
</th></tr>
';

        $highlight = $this->strip_HTML_tags($row->highlight);
        $cummulative_figures = $this->strip_HTML_tags($row->cummulative_figures);

        $html .= '<tr><td>
			<table width="100%" cellpadding="3" cellspacing="2" id="customers">
		<tr>
		<td bgcolor="#892A24" width="50%">
		<font color="#FFFFFF"><strong>Highlights</strong></font>
		</td>
		<td bgcolor="#892A24" width="50%">
		<font color="#FFFFFF"><strong>Cumulative Figures</strong></font>
		</td>
		</tr>
		<tr>
		<td valign="top">'.nl2br(ltrim($highlight)).'</td>
		<td valign="top">'.$row->cummulative_figures.'	
		</td>
		</tr>
		</table>
			</td></tr>';
        $html .= '</table>';

        //$html .= '<br pagebreak="true">';

        $html .= '<table width="100%" cellpadding="3" cellspacing="0" border="1" bordercolor="#999999">';
        $html .= '<tr><td>
			<table width="100%" cellpadding="3" cellspacing="2" id="customers">
		<tr>
		<td bgcolor="#892A24"><font color="#FFFFFF"><strong>'.$row->graph_one_title.'</strong></font>
		</td>
		</tr>
			<tr>
			<td><img src="'. base_url().'images/reportelements/'.$row->reporting_rates_graph.'" alt=""></td>
			</tr>
		</table>
			</td>
			</tr>';
        $html .= '</table>';


        $html .= '<br pagebreak="true">';

        $html .= '<table width="100%" cellpadding="3" cellspacing="0" border="1" bordercolor="#999999">';

        $html .= '<tr><td>
			<table width="100%" cellpadding="3" cellspacing="2" id="customers">
				<tr>
					<td bgcolor="#892A24" width="50%">
					<font color="#FFFFFF"><strong>Epidemic situation</strong></font>
					</td>
					<td bgcolor="#892A24" width="50%">
					<font color="#FFFFFF"><strong>Alerts and outbreaks - Epi Week '.$row->week_no.'</strong></font>
					</td>
				</tr>
				<tr>
					<td width="50%">
					'.$row->epidemic_situation.'
					</td>
					<td width="50%">
					<img src="'. base_url().'images/reportelements/'.$row->map_image.'" alt="">
					</td>
					
				</tr>
				
				</table>
			
			</td></tr>';

        $html .= '</table>';

        $html .= '<table width="100%" cellpadding="3" cellspacing="0" border="1" bordercolor="#999999">';
        $html .= '<tr><td>
			<table width="100%" cellpadding="3" cellspacing="2" id="customers">
		<tr>
		<td bgcolor="#892A24"><font color="#FFFFFF"><strong>'.$row->epi_curve_title.'</strong></font>
		</td>
		</tr>
			<tr>
			<td><img src="'. base_url().'images/reportelements/'.$row->epi_curve_graph.'" alt=""></td>
			</tr>
		</table>
			</td>
			</tr>';
        $html .= '</table>';

        $html .= '<br pagebreak="true">';

        $html .= '<table width="100%" cellpadding="3" cellspacing="0" border="1" bordercolor="#999999">';
        $html .= '<tr><td>
			<table width="100%" cellpadding="3" cellspacing="2" id="customers">
		<tr>
		<td bgcolor="#892A24"><font color="#FFFFFF"><strong>Number of alerts received and reported</strong></font>
		</td>
		</tr>
			<tr>
			<td><img src="'. base_url().'images/reportelements/'.$row->alerts_graph.'" alt=""></td>
			</tr>
		</table>
			</td>
			</tr>';
        $html .= '</table>';


        $html .= '<br pagebreak="true">';

        $html .= '<table width="100%" cellpadding="3" cellspacing="0" border="1" bordercolor="#999999">';
        $html .= '<tr><td>
			<table width="100%" cellpadding="3" cellspacing="2" id="customers">
		<tr>
		<td bgcolor="#892A24"><font color="#FFFFFF"><strong>'.$row->summary_title.'</strong></font>
		</td>
		</tr>
			<tr>
			<td>'.$row->leadingdiseasetable.'</td>
			</tr>
		</table>
			</td>
			</tr>';
        $html .= '</table>';

        $html .= '<br pagebreak="true">';

        $html .= '<table width="100%" cellpadding="3" cellspacing="0" border="1" bordercolor="#999999">';
        $html .= '<tr><td>
			<table width="100%" cellpadding="3" cellspacing="2" id="customers">
		<tr>
		<td bgcolor="#892A24"><font color="#FFFFFF"><strong>Trends for confirmed Malaria morbidity in '.$country->country_name.'</strong></font>
		</td>
		</tr>
			<tr>
			<td><img src="'. base_url().'images/reportelements/'.$row->malaria_graph.'" alt=""></td>
			</tr>
		</table>
			</td>
			</tr>';
        $html .= '</table>';

        $html .= '<table width="100%" cellpadding="3" cellspacing="0" border="1" bordercolor="#999999">';
        $html .= '<tr><td>
			<table width="100%" cellpadding="3" cellspacing="2" id="customers">
		<tr>
		<td bgcolor="#892A24"><font color="#FFFFFF"><strong>Summary of malaria morbidity in week '.$row->week_no.' '.$row->week_year.'</strong></font>
		</td>
		</tr>
			<tr>
			<td>'.$row->malariatable.'</td>
			</tr>
		</table>
			</td>
			</tr>';
        $html .= '</table>';

        $html .= '<br pagebreak="true">';

        $html .= '<table width="100%" cellpadding="3" cellspacing="0" bordercolor="#999999">';
        $html .= '<tr><td>
			'.$row->interesttable.'
			</td>
			</tr>';
        $html .= '</table>';

        $html .= '<br pagebreak="true">';

        $html .= '<table width="100%" cellpadding="3" cellspacing="0">';
        $html .= '<tr><td>
			'.$row->doi_one_text.'
			</td>
			</tr>';
        $html .= '</table>';

        $html .= '<br pagebreak="true">';

        $html .= '<table width="100%" cellpadding="3" cellspacing="0" bordercolor="#999999">';
        $html .= '<tr><td>
			'.$row->lastinteresttable.'
			</td>
			</tr>';
        $html .= '</table>';

        $html .= '<br pagebreak="true">';

        $html .= '<table width="100%" cellpadding="3" cellspacing="0">';
        $html .= '<tr><td>
			'.$row->doi_two_text.'
			</td>
			</tr>';
        $html .= '</table>';

        $html .= '<br pagebreak="true">';

        $html .= $row->summarytable;


        $html .= '<table width="100%" cellpadding="3" cellspacing="0">';
        $html .= '<tr><td>&nbsp;</td>
			</tr>';
        $html .= '</table>';

        $html .= '<table width="100%" cellpadding="3" border="1" cellspacing="0">';
        $html .= '<tr bgcolor="#892A24"><td>
			<center>
			<font color="#FFFFFF">'.$row->footer_one.'</font>
			</center>
			</td>
			</tr>';
        $html .= '</table>';

        $html .= '<table width="100%" cellpadding="3" border="1" cellspacing="0">';
        $html .= '<tr bgcolor="#1f7eb8"><td>
			<center>
			<font color="#FFFFFF">'.$row->footer_two.'</font>
			</center>
			</td>
			</tr>';
        $html .= '</table>';



        // output the HTML content
        $pdf->writeHTML($html, true, false, true, false, '');

        $txt = date("m/d/Y h:m:s");

        // print a block of text using Write()
        //$pdf->Write($h=0, $txt, $link='', $fill=0, $align='C', $ln=true, $stretch=0, $firstline=false, $firstblock=false, $maxh=0);
        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
        // test pre tag


        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

        // reset pointer to the last page
        $pdf->lastPage();
        ob_start();
        // ---------------------------------------------------------
        //ob_end_clean();
        //Close and output PDF document
        $pdf->Output('EPI_Bulletin_'.$country->country_code.'_'.$row->week_no.'_'.$row->week_year.'.pdf', 'I');


        //============================================================+
        // END OF FILE
        //============================================================+
    }


    function strip_HTML_tags($text)
    { // Strips HTML 4.01 start and end tags. Preserves contents.
        return preg_replace('%
	        # Match an opening or closing HTML 4.01 tag.
	        </?                  # Tag opening "<" delimiter.
	        (?:                  # Group for HTML 4.01 tags.
	          ABBR|ACRONYM|ADDRESS|APPLET|AREA|A|BASE|BASEFONT|BDO|BIG|
	          BLOCKQUOTE|BODY|BR|BUTTON|B|CAPTION|CENTER|CITE|CODE|COL|
	          COLGROUP|DD|DEL|DFN|DIR|DIV|DL|DT|EM|FIELDSET|FONT|FORM|
	          FRAME|FRAMESET|H\d|HEAD|HR|HTML|IFRAME|IMG|INPUT|INS|
	          ISINDEX|I|KBD|LABEL|LEGEND|LI|LINK|MAP|MENU|META|NOFRAMES|
	          NOSCRIPT|OBJECT|OL|OPTGROUP|OPTION|PARAM|PRE|P|Q|SAMP|
	          SCRIPT|SELECT|SMALL|SPAN|STRIKE|STRONG|STYLE|SUB|SUP|S|
	          TABLE|TD|TBODY|TEXTAREA|TFOOT|TH|THEAD|TITLE|TR|TT|U|UL|VAR
	        )\b                  # End group of tag name alternative.
	        (?:                  # Non-capture group for optional attribute(s).
	          \s+                # Attributes must be separated by whitespace.
	          [\w\-.:]+          # Attribute name is required for attr=value pair.
	          (?:                # Non-capture group for optional attribute value.
	            \s*=\s*          # Name and value separated by "=" and optional ws.
	            (?:              # Non-capture group for attrib value alternatives.
	              "[^"]*"        # Double quoted string.
	            | \'[^\']*\'     # Single quoted string.
	            | [\w\-.:]+      # Non-quoted attrib value can be A-Z0-9-._:
	            )                # End of attribute value alternatives.
	          )?                 # Attribute value is optional.
	        )*                   # Allow zero or more attribute=value pairs
	        \s*                  # Whitespace is allowed before closing delimiter.
	        /?                   # Tag may be empty (with self-closing "/>" sequence.
	        >                    # Opening tag closing ">" delimiter.
	        | <!--.*?-->         # Or a (non-SGML compliant) HTML comment.
	        | <!DOCTYPE[^>]*>    # Or a DOCTYPE.
	        %six', '', $text);
    }


    public function edit($id)
    {
        if (!$this->erkanaauth->try_session_login()) {
            redirect('login','refresh');
        }
        $row = $this->db->get_where('epibulletins', array('id' => $id))->row();
        $country = $this->countriesmodel->get_by_id($row->country_id)->row();
        $last_year = $row->week_year-1;

        $week_array = $this->getStartAndEndDate($row->week_no,$row->week_year);

        $end_date = $week_array['week_start'];

        $start_date = date('Y-m-d', strtotime('-9 weeks', strtotime($end_date)));

        $ddate = $start_date;
        $date = new DateTime($ddate);
        $week = $date->format("W");

        list($year) = explode("-", $start_date);

        $data = array(
            'row' => $row,
            'country' => $country,
            'previous_year' => $last_year,
            'start_week' => $week,
            'start_year' => $year,
        );
        $this->load->view('epibulletins/edit', $data);
    }

    public function edit_validate($id)
    {
        if (!$this->erkanaauth->try_session_login()) {
            redirect('login','refresh');
        }
        $this->load->library('form_validation');
        $this->form_validation->set_rules('highlight_text', 'Highlight', 'trim|required');
        $this->form_validation->set_rules('interventions', 'Intervention/Narrative', 'trim|required');
        if ($this->form_validation->run() == false) {
            $this->edit($id);
        } else {
            //$highlight_text = $this->lchar($this->input->post('highlight_text'),740);
            //$interventions = $this->lchar($this->input->post('interventions'),800);

            $data = array(
                'highlight_text' => $this->input->post('highlight_text'),
                'interventions' =>  $this->input->post('interventions'),
            );

            $this->db->where('id', $id);
            $this->db->update('epibulletins', $data);
            redirect('epibulletins','refresh');
        }
    }

    public function delete($id)
    {
        if (!$this->erkanaauth->try_session_login()) {
            redirect('login','refresh');
        }
        $this->db->delete('epibulletins', array('id' => $id));
        redirect('epibulletins','refresh');
    }

    function top_three_positions($array){

        // Sort the array from max to min
        arsort($array);

        // Unset everything in  sorted array after the first three elements
        $count = 0;
        foreach($array as $key => $ar){
            if($count > 2){
                unset($array[$key]);
            }
            $count++;
        }

        // Return array with top 3 values with their indexes preserved.
        return $array;
    }



    function getStartAndEndDate($week, $year) {
        $dto = new DateTime();
        $dto->setISODate($year, $week);
        $ret['week_start'] = $dto->format('Y-m-d');
        $dto->modify('+6 days');
        $ret['week_end'] = $dto->format('Y-m-d');
        return $ret;
    }

    /**
     * Output span with progress.
     *
     * @param $current integer Current progress out of total
     * @param $total   integer Total steps required to complete
     */
    function outputProgress($current, $total) {
        $percent = round($current / $total * 100);
        echo "<span style='position: absolute;z-index:$current;background:#fff;'><div id='progress' style='width:100px;border:1px solid #ccc;'><div style='width:".$percent.";background-color:#ddd;'>" . round($current / $total * 100) . "%</div></div> </span>";
        //echo '<div id="loader-icon" ><img src="'.base_url().'images/page-loader.gif" /></div>';
        $this->myFlush();
        sleep(1);
    }

    function displaymessage()
    {
        echo '<font face="verdana,arial,sans-serif">Mining data and generating Bulletin template. This may take several minutes. Please be patient.</font>';
    }

    /**
     * Flush output buffer
     */
    function myFlush() {
        echo(str_repeat(' ', 256));
        if (@ob_get_contents()) {
            @ob_end_flush();
        }
        flush();
    }

    function lchar($str,$val){
        return strlen($str)<=$val?$str:substr($str,0,$val).'...';
    }

    function alter()
    {
        $this->load->dbforge();
        $fields = array(
            'epi_curve' => array(
                'name' => 'epi_curve',
                'type' => 'VARCHAR (255)',
            ),
        );
        $this->dbforge->modify_column('epibulletins', $fields);
    }

    function trucatetable()
    {
        $this->load->dbforge();
        $this->db->truncate('epibulletins');
    }


}
