<?php

class Epibulletins extends CI_Controller {

    function __construct()
    {
        parent::__construct();
        $this->load->model('epibulletinsmodel');
        $this->load->model('reportsmodel');
    }

    public function index()
    {
        if (!$this->erkanaauth->try_session_login()) {
            redirect('login','refresh');
        }
        $data = array(
            'rows' => $this->db->get('epibulletins'),
            'error_message' => $this->session->flashdata('error_message'),
        );
        $this->load->view('epibulletins/index', $data);
    }

    public function add()
    {
        if (!$this->erkanaauth->try_session_login()) {
            redirect('login','refresh');
        }

        $country_id = $this->erkanaauth->getField('country_id');

        if(getRole() != 'SuperAdmin' && getRole() != 'Admin')
        {
            redirect('home', 'refresh');
        }

        $data = array();

        $data['countries'] = $this->countriesmodel->get_list();
        $data['country_id'] = $country_id;

        $this->load->view('epibulletins/add',$data);
    }

    public function template()
    {

        //create new PDF document
        $pdf = new Pdf(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);

        // set document information
        $pdf->SetCreator(PDF_CREATOR);
        $pdf->SetAuthor('WHO EMRO');
        $pdf->SetTitle('EPI Weekly Bulletin');
        $pdf->SetSubject('WHO EMRO Weekly Bulletin');
        $pdf->SetKeywords('WHO, EMRO, Bulletin, Diseases','Surveillance','EPI','Alerts');

        // set default header data
        $pdf->SetHeaderData(false, false, '', '');


        // set header and footer fonts
        $pdf->setHeaderFont(Array(PDF_FONT_NAME_MAIN, '', PDF_FONT_SIZE_MAIN));
        $pdf->setFooterFont(Array(PDF_FONT_NAME_DATA, '', PDF_FONT_SIZE_DATA));

        // set default monospaced font
        $pdf->SetDefaultMonospacedFont(PDF_FONT_MONOSPACED);


        //set margins
        //$pdf->SetMargins(PDF_MARGIN_LEFT, PDF_MARGIN_TOP, PDF_MARGIN_RIGHT);
        $pdf->SetMargins(9,9,9,9);
        $pdf->SetHeaderMargin(PDF_MARGIN_HEADER);
        $pdf->SetFooterMargin(PDF_MARGIN_FOOTER);

        //set auto page breaks
        $pdf->SetAutoPageBreak(TRUE, PDF_MARGIN_BOTTOM);

        //set image scale factor
        $pdf->setImageScale(PDF_IMAGE_SCALE_RATIO);

        //set some language-dependent strings
        //$pdf->setLanguageArray($l);

        // ---------------------------------------------------------

        // set font
        $pdf->SetFont('dejavusans', '', 9);

        $pdf->SetPrintHeader(false);

        // add a page
        //$pdf->AddPage('L','A4');
        $pdf->AddPage();


        $html = '<table width="100%" cellpadding="3" cellspacing="0" border="2" bordercolor="#999999">
        <tr><td align="center"><img src="'. base_url().'images/header.png" alt=""></td></tr>
        <tr bgcolor="#1f7eb8"><th align="center"><center>
        <font color="#FFFFFF"><strong>Epi Week 28, 10 July 2017 - 16 July 2017</strong></font></center>
        </th></tr>
        ';

        $html .= '<tr><td>
<table width="100%" cellpadding="2" cellspacing="2" id="customers">
		<tr>
		<td bgcolor="#892A24" width="50%">
		<font color="#FFFFFF"><strong>Highlights</strong></font>
		</td>
		<td bgcolor="#892A24" width="50%">
		<font color="#FFFFFF"><strong>eDEWS Reporting Rates vs Consultations in All States, Epi weeks 1 to 34, 2016</strong></font>
		</td>
		</tr>
		<tr>
		<td valign="top">
		<p>Reports were received from 17 out of 496 reporting
        facilities (3.4%) in week 28. Compared to 13 (2.6%) in
        week 27.</p>
        <p>The total number of consultatations reported during the
        reporting week was 4,326 compared to 2,358
        consultations during week 27.</p>
        <p>The highest number of consultations in week 28 were
        OAD(128 cases), ILI(54 cases), followed by AWD(51 cases)
        The number of AWD decreased from 123 cases in week 27
        to 51 cases in week 28</p>
        <p>There was no change on the number of Meas cases with
        the number remaining at 28 cases in week 27 and 28
        cases in week 28</p>
        
   <p> A total of 291 alerts were generated by eDEWS system in week 34, 2016; Of these 12 alerts were verified as true for further investigations with appropriate response.</p>
       
<p>
<table border="1" width="100%" cellspacing="0" cellpadding="2">
<tr bgcolor="#892A24"><td><font color="#FFFFFF" size="8">State</font></td><td><font color="#FFFFFF" size="8">Reporting Sites</font></td><td><font color="#FFFFFF" size="8">No. Sentinal Sites</font></td><td><font color="#FFFFFF" size="8">Completeness</font></td></tr>
<tr bgcolor="#CCCCCC"><td>Banadir</td><td>107</td><td>109</td><td>98%</td></tr>
<tr><td>Puntland</td><td>107</td><td>109</td><td>98%</td></tr>
<tr bgcolor="#CCCCCC"><td>Somaliland</td><td>107</td><td>109</td><td>98%</td></tr>
<tr><td>Jubaland</td><td>107</td><td>109</td><td>98%</td></tr>
<tr bgcolor="#CCCCCC"><td>Southwest</td><td>107</td><td>109</td><td>98%</td></tr>
<tr><td>Hirshabele</td><td>107</td><td>109</td><td>98%</td></tr>
<tr bgcolor="#CCCCCC"><td>Galmuduq</td><td>107</td><td>109</td><td>98%</td></tr>
<tr><td>Total</td><td>469</td><td>478</td><td>98%</td></tr>

</table>
</p>

</td>
		<td valign="top">
		<img src="'. base_url().'images/reportelements/rates_SOM_28_2017.jpg" height="250" alt="">
		<hr>
	<p><font size="6"> <strong>Distribution of Reporting Rates by States (Epi-week 34 , 2016)</strong></font></p>
		
		<img src="'. base_url().'images/reportelements/chart.jpeg" height="200" alt="">
		</td>
		</tr>
		</table>
        </td></tr>';



        $html .= '<tr><td>
<table width="100%" cellpadding="2" cellspacing="2" id="customers">
		<tr>
		<td bgcolor="#892A24" width="50%">
		<font color="#FFFFFF"><strong>Number of alerts received and reported</strong></font>
		</td>
		<td bgcolor="#892A24" width="50%">
		<font color="#FFFFFF"><strong>Epi curve for priority diseases weeks 18 2017 to 28 2017</strong></font>
		</td>
		</tr>
		
		<tr>
		<td>
		<img src="'. base_url().'images/reportelements/alertgraph_SOM_28_2017.jpg" height="200" alt="">		
        </td>
		<td>
		
		<img src="'. base_url().'images/reportelements/epicurve_SOM_28_2017.jpg" height="200" alt="">	
        </td>
        </tr>
		
		
		</table>
</td>

        </tr>';

        $html .= '</table>';

        $html .= '<br pagebreak="true">';

        $html .= '<table width="100%" cellpadding="3" cellspacing="0" border="2" bordercolor="#999999">';
        $html .= '<tr><td>
<table width="100%" cellpadding="2" cellspacing="2" id="customers">
		<tr>
		<td bgcolor="#892A24" width="50%">
		<font color="#FFFFFF"><strong>Leading causes of morbidity and mortality in Epi-week 34, 2016 a). OAD</strong></font>
		</td>
		<td bgcolor="#892A24" width="50%">
		<font color="#FFFFFF"><strong>Leading disease outbreak in all states &amp; Proportional morbidity of leading priority diseases, Epi weeks 1 to 34, 2016</strong></font>
		</td>
		</tr>
		<tr><td>
		
		<p>446 suspected dengue cases were reported in 14 governorates, out of these 112 cases reported from Al-Hodidah, 85 Cases from Shabwah, 32 Cases from Aden, and 22 Cases from Lahj, 1 cases with hemorrhagic manifestations were reported in Mareb governorate through the eDEWS system.
        </p>
        <p>Other Acute Diarrhea (4.3%), Malaria (0.6%), Suspected Measles (0.0%) remain the leading causes of morbidity representing a total of 4.9%.</p>
       <p>Severe acute respiratory infection, acute watery diarrhea and Acute Jaundice Syndrome represented less than 0.0% of total morbidity in reporting period. Bloody diarrhea represented 0.0% of this morbidity.</p>
		<p>All diarrheal diseases comprised 4.3% and Influenza like illnesses 0.0% of total morbidity in all zones this week.</p>
		<p>All diarrheal diseases &lt; 5 accounted for 3.9% and those &gt; 5 years of age accounted for 0.4% of total morbidity in all zones this week.</p>
		
		<table width="100%" border="1" >
		<tr bgcolor="#892A24"><td><font color="#FFFFFF">Leading Diseases</font></td><td colspan="2"><font color="#FFFFFF">Epi week 49</font></td><td colspan="2"><font color="#FFFFFF">Epi week 48</font></td></tr>
		<tr bgcolor="#892A24"><td>&nbsp;</td><td><font color="#FFFFFF">Cases</font></td><td><font color="#FFFFFF">Percentage</font></td><td><font color="#FFFFFF">Cases</font></td><td><font color="#FFFFFF">Percentage</font></td></tr>
		<tr><td>OAD</td><td>80</td><td>30%</td><td>80</td><td>30%</td></tr>
		<tr><td>ILI</td><td>80</td><td>30%</td><td>80</td><td>30%</td></tr>
		<tr><td>AWD</td><td>80</td><td>30%</td><td>80</td><td>30%</td></tr>
		<tr bgcolor="#892A24"><td><font color="#FFFFFF">Total Consultations</font></td><td><font color="#FFFFFF">240</font></td><td><font color="#FFFFFF">100%</font></td><td><font color="#FFFFFF">240</font></td><td><font color="#FFFFFF">100%</font></td></tr>
		
		
        </table>
		</td>
        <td>
        <p> <img src="'. base_url().'images/reportelements/epicurve_SOM_28_2017.jpg" height="200" alt=""></p>
       <hr>
       <p> <img src="'. base_url().'images/reportelements/epicurve_SOM_28_2017.jpg" height="200" alt=""></p>
        </td>
        </tr>
		
		</table>

        </td></tr>';

        $html .= '<tr><td><table width="100%" border="1" cellpadding="3" cellspacing="0">
		<tr bgcolor="#892A24"><td colspan="2"><font color="#FFFFFF">Weekly trends of Respiratory Diseases, Gastro Intestinal Tract Diseases, Measles, and Suspected Malaria ( Epi week 1 to 34, 2015 & 2016)</font></td></tr>
		
		<tr><td>
		<p><div align="center"><strong>Respiratory Diseases</strong></div></p>
		<img src="'. base_url().'images/reportelements/chart.jpeg" height="250" alt="">
		SARI,ILI
		</td>
		<td>
		<p><div align="center"><strong>Gastro Intestinal Tract Diseases</strong></div></p>
		<img src="'. base_url().'images/reportelements/chart.jpeg" height="250" alt="">
		AWD,BD,OAD
		</td>
		</tr>
		
		</table>

        </td></tr>';

        $html .= '</table>';

        $html .= '<br pagebreak="true">';

        $html .= '<table width="100%" cellpadding="3" cellspacing="0" border="2" bordercolor="#999999">';
        $html .= '<tr><td><table width="100%" border="1" cellpadding="3" cellspacing="0">
            <tr><td>
            <p><div align="center"><strong>Prop. Morb. of Measles</strong></div></p>
            <img src="'. base_url().'images/reportelements/chart.jpeg" height="250" alt="">
            </td>
            <td>
            <p><div align="center"><strong>Trends for confirmed Malaria morbidity in Somalia</strong></div></p>
            <img src="'. base_url().'images/reportelements/malariagraph_SOM_28_2017.jpg" height="250" alt="">
            </td>
            </tr>
		
		</table>
        </td></tr>';
        $html .= '<tr><td><table width="100%" cellpadding="3" cellspacing="0">
		<tr bgcolor="#892A24"><td><font color="#FFFFFF">Summary of Diseases Reported in weeks 27 and 28
</font></td></tr>

<tr><td><table width="100%" cellpadding="3" cellspacing="0" border="1">
		<tr bgcolor="#892A24"><td><font color="#FFFFFF">Disease</font></td><td colspan="3" align="center"><font color="#FFFFFF">EPI week 27</font></td><td colspan="3"><font color="#FFFFFF">Epi week 28</font></td></tr>
		<tr bgcolor="#892A24"><td>&nbsp;</td><td><font color="#FFFFFF">&lt; 5</font></td><td><font color="#FFFFFF">&gt; 5</font></td><td><font color="#FFFFFF">Total Cases</font></td><td><font color="#FFFFFF">&lt; 5</font></td><td><font color="#FFFFFF">&gt; 5</font></td><td><font color="#FFFFFF">Total Cases</font></td></tr>
		</table>
		</td></tr>
		</table>
				
        </td></tr>';

        $html .= '';
        $html .= '</table>';

        $html .= '<br pagebreak="true">';

        $html .= '<table width="100%" cellpadding="3" cellspacing="0" border="2" bordercolor="#999999">';
        $html .= '<tr><td><table width="100%" cellpadding="3" cellspacing="0">
		<tr bgcolor="#892A24"><td><font color="#FFFFFF">Distribution of consultations of leading diseases by States, Epi week 34</font></td></tr>
        <tr><td><table width="100%" cellpadding="3" cellspacing="0" border="1">
		<tr bgcolor="#892A24"><td><font color="#FFFFFF">Suspected Disease</font></td><td><font color="#FFFFFF">Banadir</font></td><td><font color="#FFFFFF">Puntland</font></td><td><font color="#FFFFFF">Somaliland</font></td><td><font color="#FFFFFF">Jubaland</font></td><td><font color="#FFFFFF">South West</font></td><td><font color="#FFFFFF">Hirshabele</font></td><td><font color="#FFFFFF">Galmuduq</font></td></tr>
		
		</table>
		</td></tr>
        </table>

        </td></tr>
        
        <tr><td><table width="100%" cellpadding="3" cellspacing="0">
		<tr bgcolor="#892A24"><td><font color="#FFFFFF">Alerts\' Numbers by District</font></td></tr>
        <tr><td><table width="100%" cellpadding="3" cellspacing="0" border="1">
		<tr bgcolor="#892A24"><td><font color="#FFFFFF">Region</font></td><td><font color="#FFFFFF">Banadir</font></td><td><font color="#FFFFFF">Puntland</font></td><td><font color="#FFFFFF">Somaliland</font></td><td><font color="#FFFFFF">Jubaland</font></td><td><font color="#FFFFFF">South West</font></td><td><font color="#FFFFFF">Hirshabele</font></td><td><font color="#FFFFFF">Galmuduq</font></td></tr>
		
		</table>
		</td></tr>
        </table>

        </td></tr>
       
        </table>';

        $html .= '<br pagebreak="true">';


        $html .= '<table width="100%" cellpadding="3" cellspacing="0" border="2" bordercolor="#999999">';
        $html .= '<tr bgcolor="#892A24"><td><font color="#FFFFFF">The objective of this weekly epidemiological bulletin is to provide a snap shot on selected health events reported from the eWARN surveillance system in all states (Banadir, Puntland, Somaliland, Galmudug, Jubaland, South East) of Somalia. While every attempt is made to present the weekly trends of epidemic prone diseases, the information presented in the bulletin needs to be interpreted in the context that precise information on the reference populations is not always available. The bulletin also includes information collected by the eWARN teams. The primary focus of eWARN is early detection of epidemic prone desease, to facilitate a rapid public health response.</font></td></tr>
        <tr bgcolor="#cccccc"><td><p><strong>Abbreviations</strong></p>
        <p>*Epi=Epidemiological; Sus=Suspected; HF=Health Facility; SARI=Severe acute respiratory infection; ILI=Influenza like
illnesses; AWD=Acute Watery Diarrhea/Sus.Cholera; BD=Bloody Diarrhea/Sus.Shigellosis; OAD=Other Acute Diarrhea;
Diph=Suspected Diphtheria; WC=Suspected Whooping Cough; Meas=Suspected Measles; NNT=Neonatal Tetanus;
AFP=Acute Flaccid Paralysis; AJS=Suspected Acute Jaundice Syndrome; VHF=Suspected Viral Hemorrhagic Fever/Ebola;
Mal=Confirmed Malaria; Men=Suspected Meningitis; CSR=Communicable disease Surveillance and Response;
INT=Insecticides Treated Nets
</p>
        </td></tr>
        <tr bgcolor="#1f7eb8"><td><font color="#FFFFFF">This weekly Epidemiological bulletin is published jointly by the Health Authorities and the World Health Organization.
For further information, please contact the surveillance team on: mutaawea@who.int</font>
</td></tr>
        </table>';



        //echo $html;
        // output the HTML content
        $pdf->writeHTML($html, true, false, true, false, '');

        $txt = date("m/d/Y h:m:s");

        // print a block of text using Write()
        //$pdf->Write($h=0, $txt, $link='', $fill=0, $align='C', $ln=true, $stretch=0, $firstline=false, $firstblock=false, $maxh=0);
        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
        // test pre tag


        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

        // reset pointer to the last page
        $pdf->lastPage();
        ob_start();
        // ---------------------------------------------------------
        //ob_end_clean();
        //Close and output PDF document
        $pdf->Output('EPI_Bulletin_template.pdf', 'I');


        //============================================================+
        // END OF FILE
        //============================================================+
    }

    public function generatebulletin()
    {
        if (!$this->erkanaauth->try_session_login()) {
            redirect('login','refresh');
        }
        $this->load->library('form_validation');

        $this->form_validation->set_rules('week_no', 'Week no', 'trim|required');
        $this->form_validation->set_rules('week_year', 'Week year', 'trim|required');
        $this->form_validation->set_rules('country_id', 'Country id', 'trim|required');

        if ($this->form_validation->run() == false) {
            $this->add();
        } else {
            $current_week = $this->input->post('week_no');
            $current_year = $this->input->post('week_year');
            $country_id = $this->input->post('country_id');

            $country = $this->countriesmodel->get_by_id($country_id)->row();

            if($current_week==52)
            {
                $comming_week = 52;
            }
            else
            {
                $comming_week = ($current_week+1);
            }

            //$week_array = $this->getStartAndEndDate($current_week,$current_year);
            $week_array = $this->getStartAndEndDate($comming_week,$current_year);

            $epicalendar = $this->epdcalendarmodel->get_by_year_week_country($current_year,$current_week,$country->id)->row();

            $row = $this->db->get_where('epibulletins', array('epicalendar_id' => $epicalendar->id))->row();

            if(!empty($row))
            {
                $this->session->set_flashdata('error_message', 'A bulletin for week '.$current_week.' '.$current_year.' in '.$country->country_name.' has already been added.');

                redirect('epibulletins','refresh');
            }//end first if for $row empty check
            else
            {

                ?>
                <!-- Progress bar holder -->
                <div id="progress" style="width:500px;border:1px solid #ccc;"></div>
                <!-- Progress information -->
                <div id="information" style="width"></div>

                <?php


                $data = array();
                $zon_id = 0;
                $reg_id = 0;
                $dist_id = 0;
                $hf_id = 0;

                $yearepilists = $this->epdcalendarmodel->get_list_by_year_country($current_year,$country_id);
                $epiyearidArray = array();

                foreach($yearepilists as $key=>$yearepilist):

                    $epiyearidArray[] = $yearepilist['id'];
                endforeach;

                $first_id = reset($epiyearidArray);
                $last_id = end($epiyearidArray);

                /***HIGHLIGH SECTTION **/

                $reporting_facilities = $this->formsmodel->getreportingsites($epicalendar->id, $dist_id,$reg_id,$zon_id,$hf_id);

                $healthfacilities = $this->healthfacilitiesmodel->get_list_by_country($country_id);
                $total_facilities = count($healthfacilities);

                $zones = $this->zonesmodel->get_country_list($country_id);
                $total_zones = count($zones);

                if($total_facilities==0)
                {
                    $hf_percentage=0;
                }
                else
                {
                    $hf_percentage = ($reporting_facilities/$total_facilities)*100;
                }

                $consultations = $this->formsmodel->getconsultations($epicalendar->id, $dist_id,$reg_id,$zon_id,$hf_id);

                $find_last_week = ($current_week-1);
                if($find_last_week=0)
                {
                    $last_year = ($current_year-1);
                    $last_week = 52;
                    $query_year = $last_year;
                }
                else
                {
                    $query_year = $current_year;
                    $last_week = ($current_week-1);
                }

                $previousepi = $this->epdcalendarmodel->get_by_year_week_country($query_year,$last_week,$country_id)->row();
                $previous_consultations = $this->formsmodel->getconsultations($previousepi->id, $dist_id,$reg_id,$zon_id,$hf_id);


                $previous_reporting_facilities = $this->formsmodel->getreportingsites($previousepi->id, $dist_id,$reg_id,$zon_id,$hf_id);
                if($total_facilities==0)
                {
                    $prev_hf_percentage=0;
                }
                else
                {
                    $prev_hf_percentage = ($previous_reporting_facilities/$total_facilities)*100;
                }



                $diseasecount = $this->diseasesmodel->get_country_list($country_id);
                $limit = count($diseasecount);

                $diseases  = $this->db->get_where('diseases', array('country_id' => $country_id),$limit);

                $diseasearray = array();

                $colors = "";
                foreach ($diseases->result() as $disease):
                    $diseasearray[] = $disease->disease_code;
                    $colors .= "'".$disease->color_code."',";

                endforeach;


                $lists = $this->reportsmodel->get_full_list_case_single_week($epicalendar->id,$dist_id,$reg_id,$zon_id,$hf_id,$diseasearray);

                //find the highest number of mobirdity

                $highlightArray = array();

                foreach($lists as $key=>$list)
                {
                    foreach($diseasearray as $key=>$diseasecode):
                        $disease_element = $diseasecode;

                        $highlightArray["".$diseasecode.""] = $list->$disease_element;

                    endforeach;
                }


                $highest_highlight_num    = max($highlightArray);
                $highest_disease = array_keys($highlightArray, max($highlightArray));

                $total_highlight = $consultations;
                $previous_total_highlight = $previous_consultations;

                if($total_highlight==0)
                {
                    $highlight_percentage = 0;
                }
                else
                {
                    $highlight_percentage = ($highest_highlight_num/$total_highlight)*100;
                }


                $highlight = '<ul>';
                $highlight .= '<li>Reports were received from '.$reporting_facilities.' out of '.$total_facilities.' reporting facilities ('.number_format($hf_percentage,1).'%) in week '.$epicalendar->week_no.'. Compared to '.$previous_reporting_facilities.' ('.number_format($prev_hf_percentage,1).'%) in week '.$previousepi->week_no.'.</li>';

                $highlight .= '<li>The total number of consultatations reported during the reporting week was '.number_format($consultations).' compared to '.number_format($previous_consultations).' consultations during week '.$previousepi->week_no.'. </li>';



                //first paragraph
                $highlight .= '<li>The highest number of consultations in week '.$epicalendar->week_no.' were ';
                $positions = $this->top_three_positions($highlightArray);
                $total_percent = 0;

                $highestdiseaseArray = array();

                foreach($positions as $key=>$position)
                {

                    if($total_highlight==0)
                    {
                        $disease_percentage = 0;
                    }
                    else
                    {
                        $disease_percentage = ($position/$total_highlight)*100;
                    }


                    if($position==min($positions))
                    {
                        $highlight .= 'followed by ';
                    }

                    $highlight .= $key.'('.number_format($position).' cases)';

                    if($position!=min($positions))
                    {
                        $highlight .= ', ';
                    }
                    else
                    {
                        $highlight .= ' ';
                    }

                    $highestdiseaseArray[] = $key;
                }


                $highlight .= '</li>';


                //disease of interest
                $diseasesofinterest = $this->diseaseofinterestmodel->get_combined_list($country_id);

                $diseseinterestarray = array();
                $interestidArray = array();
                foreach($diseasesofinterest as $key=>$diseaseofinterest):

                    $diseseinterestarray[] = $diseaseofinterest->disease_code;
                    $interestidArray[] = $diseaseofinterest->id;

                endforeach;

                $first_interest_id = reset($interestidArray);
                $last_interest_id = end($interestidArray);

                $interest_diseases = '';
                $diseases_of_interest = '';

                foreach($diseseinterestarray as $key=>$diseaseinterestcode):

                    $interest_cases = $this->formsdatamodel->disease_interest_epi($epicalendar->id,$country_id,$dist_id,$reg_id,$zon_id,$hf_id,$diseaseinterestcode);
                    $previous_cases = $this->formsdatamodel->disease_interest_epi($previousepi->id,$country_id,$dist_id,$reg_id,$zon_id,$hf_id,$diseaseinterestcode);

                    $cummulative_cases = $this->formsdatamodel->cummulative_interest_figures($first_id,$last_id,$country_id,$diseaseinterestcode);

                    $interest_diseases .= '<li><strong>'.number_format($cummulative_cases).'</strong> cumulative cases of '.$diseaseinterestcode.'</li>';


                    if($previous_cases<$interest_cases)
                    {
                        $interesttext = 'There was an increase in the number of '.$diseaseinterestcode.' cases from';
                        $conjoin = 'to';
                    }
                    else if($previous_cases>$interest_cases)
                    {
                        $interesttext = 'The number of '.$diseaseinterestcode.' decreased from ';
                        $conjoin = 'to';
                    }
                    else
                    {
                        $interesttext = 'There was no change on the number of '.$diseaseinterestcode.' cases with the number remaining at';
                        $conjoin = 'and';
                    }

                    $highlight .= '<li>'.$interesttext.' '.number_format($previous_cases).' cases in week '.$previousepi->week_no.' '.$conjoin.' '.number_format($interest_cases).' cases in week '.$epicalendar->week_no.'</li>';


                endforeach;

                $cases = $this->formalertsmodel->get_total_alerts($epicalendar->id,$dist_id,$reg_id,$zon_id,$hf_id);
                $true_cases = $this->formalertsmodel->get_total_true_alerts($epicalendar->id,$dist_id,$reg_id,$zon_id,$hf_id);


                $highlight .= '<li> A total of '.$cases.' alerts were generated by eWARN system in week '.$epicalendar->week_no.', '.$epicalendar->epdyear.'; Of these '.$true_cases.' alerts were verified as true
for further investigations with appropriate response.</li>';


                $highlight .= '</ul>';


                /***END HIGHLIGHT***/

                $end_date = $week_array['week_start'];

                $baseline_date = date('Y-m-d', strtotime('-10 weeks', strtotime($end_date)));

                $first_week = date("W", strtotime($baseline_date));
                $last_week = date("W", strtotime($end_date));

                $first_year = date("Y", strtotime($baseline_date));
                $last_year = date("Y", strtotime($end_date));

                /****End consultations and reporting rates****/

                $epi_lists = $this->epdcalendarmodel->get_list_by_date($baseline_date,$end_date,$country_id);
                $categories = '';
                $consultations_column = '';
                $reporting_sites_column = '';

                foreach($epi_lists as $key=>$epi_list)
                {
                    $consultations = $this->formsmodel->getconsultations($epi_list->id, $dist_id,$reg_id,$zon_id,$hf_id);
                    $reporting_sites = $this->formsmodel->getreportingsites($epi_list->id, $dist_id,$reg_id,$zon_id,$hf_id);

                    $categories .=  "'Wk".$epi_list->week_no."',";
                    $consultations_column .= $consultations.',';
                    $reporting_sites_column .= $reporting_sites.',';

                }


                //zone reporting rates

                $zonecategories    = "";
                $zonereportingrate = "";

                $distribution_table = '<table border="1" width="100%" cellspacing="0" cellpadding="1">';
                $distribution_table .= '<tr bgcolor="#892A24"><td><font color="#FFFFFF">State</font></td><td><font color="#FFFFFF">Reporting Sites</font></td><td><font color="#FFFFFF">No. Sentinal Sites</font></td><td><font color="#FFFFFF">Completeness</font></td></tr>';

                $bgcolor = 'bgcolor = "#CCCCCC"';
                $total_sites = 0;
                $total_sentinal = 0;
                foreach($zones as $key=>$zone)
                {
                    $thezonehf = $this->healthfacilitiesmodel->get_by_zone($zone['id']);
                    $hfsinzone          = count($thezonehf->result());

                    $zone_reporting_sites = $this->formsmodel->getreportingsites($epicalendar->id, $dist_id,$reg_id,$zone['id'],$hf_id);
                    if ($zone_reporting_sites == 0) {
                        $percentagezonereporting = 0;
                    } else {
                        $percentagezonereporting = ($zone_reporting_sites / $hfsinzone) * 100;
                    }

                    $zonecategories .= "'" . $zone['zone'] . "',";

                    $zonereportingrate .= number_format($percentagezonereporting, 1) . ", ";

                    if($bgcolor == 'bgcolor = "#CCCCCC"')
                    {
                        $bgcolor = '';
                    }
                    else
                    {
                        $bgcolor = 'bgcolor = "#CCCCCC"';
                    }

                    $distribution_table .= '<tr '.$bgcolor.'><td>'.$zone['zone'] .'</td><td>'.$zone_reporting_sites.'</td><td>'.$hfsinzone.'</td><td>'.number_format($percentagezonereporting).'%</td></tr>';
                    $total_sites = $total_sites+$zone_reporting_sites;
                    $total_sentinal = $total_sentinal+$hfsinzone;
                }

                $overal_percentage = ($total_sites/$total_sentinal)*100;

                $distribution_table .= '<tr bgcolor="#892A24"><td><font color="#FFFFFF">Total</font></td><td><font color="#FFFFFF">'.$total_sites.'</font></td><td><font color="#FFFFFF">'.$total_sentinal.'</font></td><td><font color="#FFFFFF">'.number_format($overal_percentage).'%</font></td></tr>';
                $distribution_table .= '</table>';


                /****End consultations and reporting rates****/

                /***Number of alerts received and reported***/
                $alerts = $this->reportsmodel->get_full_list_alert_week($query_year,$current_year,$previousepi->id,$epicalendar->id,$dist_id,$reg_id,$zon_id,$hf_id,$diseasearray);

                $graphcategories = '';
                $alertseries = '';

                foreach ($alerts as $key => $alert) {

                    $graphcategories .= "'Wk".$alert->week_no."',";
                }

                foreach($diseasearray as $key=>$diseasecode):

                    $alertseries .= "{
						name: '".$diseasecode."',
						data: [";

                    foreach ($alerts as $key => $alert) {

                        $alert_element = $diseasecode;

                        $alertseries .= $alert->$alert_element.",";

                    }

                    $alertseries .= "]";

                    $alertseries .= "},";

                endforeach;


                /***End alerts received**/

                /******EPI curve******/

                $int_end_date = $week_array['week_start'];

                $int_start_date = date('Y-m-d', strtotime('-8 weeks', strtotime($int_end_date)));

                $epilists = $this->epdcalendarmodel->get_list_by_date($int_start_date,$int_end_date,$country_id);

                $epicalendaridArray = array();

                foreach($epilists as $key=>$epilist)
                {
                    $epicalendaridArray[] =  $epilist->id;

                }

                $interest_lists = $this->reportsmodel->get_full_list_case_epi_week($reporting_year='',$reporting_year2='',$epicalendaridArray,$dist_id,$reg_id,$zon_id,$hf_id,$diseseinterestarray);
                $interestseries = '';
                $interestcategory = '';

                foreach($diseseinterestarray as $key=>$diseaseinterestcode):

                    $interestseries .= '{';
                    $interestseries .= "name: '".$diseaseinterestcode."',";
                    $interestseries .= 'data: [';

                    foreach($interest_lists as $key=>$interest_list)
                    {
                        $interestseries .= number_format($interest_list->$diseaseinterestcode).',';

                        $interestcategory .= "'WK.".$interest_list->week_no."',";

                    }


                    $interestseries .= ']';

                    $interestseries .= '},';

                endforeach;

                /********End EPI curve************/


                /*********Leading diseases section************/


                $leading_diseases = '<ul>';

                $diarrheal = '';
                $respiratory = '';

                $diarrheal_diseases = $this->diseasesmodel->get_by_category_country(2,$country_id);
                $respiratory_diseases = $this->diseasesmodel->get_by_category_country(1,$country_id);

                $allcases = 0;
                $malariacases = 0;
                $measlescases = 0;

                foreach ($highlightArray as $key => $value) {

                    $allcases = $allcases+$value;

                    if($key=='Mal')
                    {
                        $malariacases = $malariacases+$value;
                    }

                    if($key=='Meas')
                    {
                        $measlescases = $measlescases+$value;
                    }
                }


                $total_diarrheal = 0;
                foreach ($diarrheal_diseases as $thekey=>$diarrheal_disease):
                    foreach ($highlightArray as $key => $value) {

                        if($diarrheal_disease->disease_code==$key)
                        {

                            $diarrheal .= $key.'('.$value.' cases),';
                            $total_diarrheal = $total_diarrheal+$value;
                        }

                    }

                endforeach;
                $percentage_diarrheal = ($total_diarrheal/$allcases)*100;

                $total_respiratory = 0;
                foreach ($respiratory_diseases as $thkey=>$respiratory_disease):
                    foreach ($highlightArray as $key => $value) {

                        if($respiratory_disease->disease_code==$key)
                        {
                            $respiratory .= $key.'('.$value.' cases),';

                            $total_respiratory = $total_respiratory+$value;
                        }


                    }

                endforeach;

                $percentage_respiratory = ($total_respiratory/$allcases)*100;
                $malaria_percent = ($malariacases/$allcases)*100;
                $measles_percent = ($measlescases/$allcases)*100;
                $upper_percent = $percentage_diarrheal+$percentage_respiratory;
                $other_percent = (100 - $upper_percent);

                $highest_disease_code =  $highest_disease[0];

                $leading_diseases .= '<li>Being the highest course of morbidity in the reporting week, '.$highest_highlight_num.' cases of '.$highest_disease_code.' where reported in '.$total_zones.' sates, out of these, the reported cases from the states included ';
                foreach($zones as $key=>$zone)
                {

                    $diseasenumber = $this->reportsmodel->get_full_zone_week($epicalendar->id, $dist_id, $reg_id, $zone['id'], $hf_id,$highest_disease_code);

                    if(!empty($diseasenumber))
                    {
                        $leading_diseases .= $diseasenumber->$highest_disease_code.' Cases from '.$zone['zone'].', ';
                    }


                }

                $leading_diseases .= 'which were captured through the eWARN system.</li>';


                $leading_diseases .= '<li>The number of cases for all diarrheal diseases i.e '.$diarrheal.' comprised '.number_format($percentage_diarrheal).'% of all the cases reported in Epi-week '.$epicalendar->week_no.', '.$epicalendar->epdyear.'</li>';
                $leading_diseases .= '<li>Respiratory diseases, i.e. '.$respiratory.' accounted for '.number_format($percentage_respiratory).' % of total morbidity in the reporting period</li>';

                $leading_diseases .= '<li>'.$measlescases.' cases of suspected measles were reported with '.$malariacases.' cases of confirmed malaria, each accounting for '.number_format($measles_percent).'% and '.number_format($malaria_percent).'% of total morbidity respectively.</li>';
                $leading_diseases .= '<li>All together, other vaccine preventable diseases and communicable diseases accounted for '.number_format($other_percent).'% of total morbidity in all states this week</li>';
                $leading_diseases .= '</ul>';


                /**********************End**********************/

                /*************Disease outbreak in states******************/
                $interest_lists = $this->reportsmodel->get_full_list_case_epi_week($reporting_year='',$reporting_year2='',$epicalendaridArray,$dist_id,$reg_id,$zon_id,$hf_id,$diseseinterestarray);
                $interestseries = '';
                $interestcategory = '';

                foreach($diseseinterestarray as $key=>$diseaseinterestcode):

                    $interestseries .= '{';
                    $interestseries .= "name: '".$diseaseinterestcode."',";
                    $interestseries .= 'data: [';

                    foreach($interest_lists as $key=>$interest_list)
                    {
                        $interestseries .= number_format($interest_list->$diseaseinterestcode).',';

                        $interestcategory .= "'WK.".$interest_list->week_no."',";

                    }


                    $interestseries .= ']';

                    $interestseries .= '},';

                endforeach;

                $outbreakcategories = '';
                $outbreakseries = '';

                foreach($zones as $key=>$zone) {

                    $diseasenumbers = $this->reportsmodel->get_full_list_zone_week($epicalendaridArray, $dist_id, $reg_id, $zone['id'], $hf_id, $highest_disease_code);
                    $outbreakseries .= '{';
                    $outbreakseries .= "name: '".$zone['zone']."',";
                    $outbreakseries .= 'data: [';

                    $i = 0;

                    foreach($diseasenumbers as $key=>$diseasenumber)
                    {
                        $outbreakseries .= number_format($diseasenumber->$highest_disease_code).',';

                        $outbreakcategories .= "'WK.".$diseasenumber->week_no."',";


                    }

                    $outbreakseries .= ']';

                    $outbreakseries .= '},';

                }

                $piedata = '';
                $i=0;

                foreach ($highlightArray as $key => $value) {
                    $i++;
                    $diseasepercent = ($value/$allcases)*100;

                    if($i==5)
                    {
                        $piedata .= "{
                        name: '".$key."',
                        y:  ".number_format($diseasepercent).",
                        sliced: true,
                        selected: true
                        },";
                    }
                    else{
                        $piedata .= " ['".$key."',    ".number_format($diseasepercent)."],";
                    }


                }


                /*******************End disease outbreak in states******/


                /******************Weekly trends****************************/

                $previous_year = ($current_year-1);

                //previous year EPI calendar array
                $previousepiarray = array();

                foreach($epilists as $key=>$epilist)
                {
                    $previousepicalendar = $this->epdcalendarmodel->get_by_year_week_country($previous_year,$epilist->week_no,$country_id)->row();
                    $previousepiarray[] =  $previousepicalendar->id;

                }

                //respiratory diseases
                $respcategory = '';
                $resplists = $this->reportsmodel->get_list_category_sum($epicalendaridArray, $dist_id, $reg_id, $zon_id, $hf_id,1);
                $respseries = '{';
                $respseries .= "name: '".$current_year."',";
                $respseries .= 'data: [';

                foreach($resplists as $key=>$resplist)
                {
                    $weekcases = $this->reportsmodel->get_list_sum($resplist->epicalendar_id, $dist_id, $reg_id, $zon_id, $hf_id);
                    $resppercent = ($resplist->Category_Total/$weekcases)*100;
                    $respseries .= number_format($resppercent).',';

                    $respcategory .= "'WK.".$resplist->week_no."',";

                }


                $respseries .= ']';

                $respseries .= '},';

                $respprevlists = $this->reportsmodel->get_list_category_sum($previousepiarray, $dist_id, $reg_id, $zon_id, $hf_id,1);
                $respseries .= '{';
                $respseries .= "name: '".$previous_year."',";
                $respseries .= 'data: [';

                foreach($respprevlists as $key=>$respprevlist)
                {
                    $prevweekcases = $this->reportsmodel->get_list_sum($respprevlist->epicalendar_id, $dist_id, $reg_id, $zon_id, $hf_id);
                    $respprevpercent = ($respprevlist->Category_Total/$prevweekcases)*100;
                    $respseries .= number_format($respprevpercent).',';

                }

                $respseries .= ']';

                $respseries .= '},';

                //Gastro intestinal diseases
                $gastrolists = $this->reportsmodel->get_list_category_sum($epicalendaridArray, $dist_id, $reg_id, $zon_id, $hf_id,2);
                $gastroseries = '{';
                $gastroseries .= "name: '".$current_year."',";
                $gastroseries .= 'data: [';

                foreach($gastrolists as $key=>$gastrolist)
                {
                    $weekcases = $this->reportsmodel->get_list_sum($gastrolist->epicalendar_id, $dist_id, $reg_id, $zon_id, $hf_id);
                    $gastropercent = ($gastrolist->Category_Total/$weekcases)*100;
                    $gastroseries .= number_format($gastropercent).',';

                }


                $gastroseries .= ']';

                $gastroseries .= '},';

                $prevgastrolists = $this->reportsmodel->get_list_category_sum($previousepiarray, $dist_id, $reg_id, $zon_id, $hf_id,1);
                $gastroseries .= '{';
                $gastroseries .= "name: '".$previous_year."',";
                $gastroseries .= 'data: [';

                foreach($prevgastrolists as $key=>$prevgastrolist)
                {
                    $prevweekcases = $this->reportsmodel->get_list_sum($prevgastrolist->epicalendar_id, $dist_id, $reg_id, $zon_id, $hf_id);
                    $gastoprevpercent = ($prevgastrolist->Category_Total/$prevweekcases)*100;
                    $gastroseries .= number_format($gastoprevpercent).',';

                }

                $gastroseries .= ']';

                $gastroseries .= '},';

                //measles
                $measleslists = $this->reportsmodel->get_list_disease_sum($epicalendaridArray, $dist_id, $reg_id, $zon_id, $hf_id,'Meas');
                $measseries = '{';
                $measseries .= "name: '".$current_year."',";
                $measseries .= 'data: [';

                foreach($measleslists as $key=>$measleslist)
                {
                    $weekcases = $this->reportsmodel->get_list_sum($measleslist->epicalendar_id, $dist_id, $reg_id, $zon_id, $hf_id);
                    $measpercent = ($measleslist->Disease_Total/$weekcases)*100;
                    $measseries .= number_format($measpercent).',';

                }


                $measseries .= ']';

                $measseries .= '},';

                $prevmeaslists = $this->reportsmodel->get_list_disease_sum($previousepiarray, $dist_id, $reg_id, $zon_id, $hf_id,'Meas');

                $measseries .= '{';
                $measseries .= "name: '".$previous_year."',";
                $measseries .= 'data: [';

                foreach($prevmeaslists as $key=>$prevmeaslist)
                {
                    $prevweekcases = $this->reportsmodel->get_list_sum($prevmeaslist->epicalendar_id, $dist_id, $reg_id, $zon_id, $hf_id);
                    $measprevpercent = ($prevmeaslist->Disease_Total/$prevweekcases)*100;
                    $measseries .= number_format($measprevpercent).',';

                }

                $measseries .= ']';

                $measseries .= '},';

                //malaria
                $malarialists = $this->reportsmodel->get_list_disease_sum($epicalendaridArray, $dist_id, $reg_id, $zon_id, $hf_id,'Mal');
                $malsearies = '{';
                $malsearies .= "name: '".$current_year."',";
                $malsearies .= 'data: [';

                foreach($malarialists as $key=>$malarialist)
                {
                    $weekcases = $this->reportsmodel->get_list_sum($malarialist->epicalendar_id, $dist_id, $reg_id, $zon_id, $hf_id);
                    $malspercent = ($measleslist->Disease_Total/$weekcases)*100;
                    $malsearies .= number_format($malspercent).',';

                }


                $malsearies .= ']';

                $malsearies .= '},';

                $prevmallists = $this->reportsmodel->get_list_disease_sum($previousepiarray, $dist_id, $reg_id, $zon_id, $hf_id,'Mal');

                $malsearies .= '{';
                $malsearies .= "name: '".$previous_year."',";
                $malsearies .= 'data: [';

                foreach($prevmallists as $key=>$prevmallist)
                {
                    $prevweekcases = $this->reportsmodel->get_list_sum($prevmallist->epicalendar_id, $dist_id, $reg_id, $zon_id, $hf_id);
                    $malsprevpercent = ($prevmallist->Disease_Total/$prevweekcases)*100;
                    $malsearies .= number_format($malsprevpercent).',';

                }

                $malsearies .= ']';

                $malsearies .= '},';

                /******************End Weekly trends****************************/

                /***********************summary of diseases*************************************/

                $caselists = $this->reportsmodel->get_full_list_case_week($first_year,$last_year,$previousepi->id,$epicalendar->id,$dist_id,$reg_id,$zon_id,$hf_id,$diseasearray);

                //$caselists = $this->formsmodel->get_full_list($first_year, $last_year, $previousepi->id,$epicalendar->id, $dist_id, $reg_id, $zon_id, $hf_id,$diseasearray);

                //get previous week data
                $previouslists = $this->reportsmodel->get_full_list_case_single_week($previousepi->id,$dist_id,$reg_id,$zon_id,$hf_id,$diseasearray);

                $leadingdiseasetable = '<table id="datatable" width="100%" border="1" cellspacing="0" cellpadding="2" bordercolor="#892a24">';
                $leadingdiseasetable .= '<tr bgcolor="#892A24" bordercolor="#892A24"><td><font color="#FFFFFF">Disease/syndrome</font></td>';

                foreach ($caselists as $key => $caselist):

                    $leadingdiseasetable .='<td colspan="3" align="center"><font color="#FFFFFF">Epi week ' . $caselist->week_no . '</font></td>';

                endforeach;

                $leadingdiseasetable .= '</tr>';
                $leadingdiseasetable .= '<tr bgcolor="#892A24"><td>&nbsp;</td><td><font color="#FFFFFF">Cases &lt;5</font></td><td><font color="#FFFFFF">Cases &gt;5</font></td><td><font color="#FFFFFF">Total Cases</font></td><td><font color="#FFFFFF">Cases &lt;5</font></td><td><font color="#FFFFFF">Cases &gt;5</font></td><td><font color="#FFFFFF">Total Cases</font></td></tr>';

                $total_current_week = 0;
                $total_previous_week = 0;
                $bg_color = 'bgcolor="#CCCCCC"';

                foreach($diseasearray as $key=>$highestdiseasecode)
                {

                    if($bg_color == 'bgcolor="#CCCCCC"')
                    {
                        $bg_color = '';
                    }
                    else
                    {
                        $bg_color = 'bgcolor="#CCCCCC"';
                    }
                    $leadingdiseasetable .= '<tr '.$bg_color.'><td>'.$highestdiseasecode.'</td>';
                    foreach ($caselists as $key => $caselist):

                        $high_disease_element = $highestdiseasecode;
                        $under_five_element = $highestdiseasecode.'_T_U_F';
                        $over_five_element = $highestdiseasecode.'_T_O_F';

                        if($caselist->epicalendar_id==$epicalendar->id)
                        {
                            $total_current_week = $total_current_week+$caselist->$high_disease_element;

                        }
                        else
                        {


                            $total_previous_week = $total_previous_week+$caselist->$high_disease_element;
                        }

                        $leadingdiseasetable .= '<td>'.number_format($caselist->$under_five_element).'</td><td>'.number_format($caselist->$over_five_element).'</td><td>'.number_format($caselist->$high_disease_element).'</td>';
                    endforeach;

                    $leadingdiseasetable .= '</tr>';
                }


                $leadingdiseasetable .= '</table>';


                /*******************End summary of diseases****************************/


                /***************Reporting facilities table*******************/

                $colspan = ($total_zones+1);

                //$zonedistributiontable .= '<tr bgcolor="#892A24"><td><font color="#FFFFFF">Suspected Disease</font></td>';

                $reportintable =' <table id="datatable" width="100%" border="1" cellpadding="3" cellspacing="0">
                <tr bgcolor="#892A24"><td colspan="'.$colspan.'"><font color="#FFFFFF">Reporting of health facilities , No.# of districts and patients consultations in week '.$epicalendar->week_no.', '.$epicalendar->epdyear.'</font></td></tr>

            ';

                $reportintable .='<tr bgcolor="#892A24"><td>&nbsp</td>';

                foreach($zones as $key=>$zone) {
                    $reportintable .='<td><font color="#FFFFFF">'.$zone['zone'].'</font></td>';
                    //$zonedistributiontable .= '<td><font color="#FFFFFF">'.$zone['zone'].'</font></td>';
                }
                $reportintable .='</tr>';
                //$zonedistributiontable .= '</tr>';

                $reportintable .='<tr><td bgcolor="#892A24"><font color="#FFFFFF"># Of '.$country->third_admin_level_label.'</font></td>';

                foreach($zones as $key=>$zone) {
                    $zonedistrictlist = $this->districtsmodel->get_list_by_parameters($country_id,$zone['id'],$reg_id);
                    $zonedistricts = count($zonedistrictlist);
                    $reportintable .='<td>'.$zonedistricts.'</td>';
                }

                $reportintable .='</tr>';

                $reportintable .='<tr><td bgcolor="#892A24"><font color="#FFFFFF">No.# Of Reps. Wk-'.$epicalendar->week_no.'</font></td>';

                foreach($zones as $key=>$zone) {
                    $zone_reporting_sites = $this->formsmodel->getreportingsites($epicalendar->id, $dist_id,$reg_id,$zone['id'],$hf_id);
                    $reportintable .='<td>'.$zone_reporting_sites.'</td>';
                }

                $reportintable .='</tr>';

                $reportintable .='<tr><td bgcolor="#892A24"><font color="#FFFFFF">Patients Cons.</font></td>';

                foreach($zones as $key=>$zone) {
                    $zone_consultations = $this->formsmodel->getconsultations($epicalendar->id, $dist_id, $reg_id, $zone['id'], $hf_id);
                    $reportintable .='<td>'.$zone_consultations.'</td>';
                }

                $reportintable .='</tr>';

                $reportintable .= '</table>';


                /***************End reporting facilities table*******************/

                /*********************Distribution by states****************************/


                $zonearray = array();

                $colspan = ($limit+2);

                foreach($zones as $key=>$zone)
                {
                    $zonearray[] = $zone['id'];
                }

                $zonediseases = $this->formsmodel->zone_disease_week($epicalendar->id,$zonearray,$diseasearray);

                $zonedistributiontable = '<table width="100%" cellpadding="3" cellspacing="0">
		<tr bgcolor="#892A24"><td colspan="'.$colspan.'"><font color="#FFFFFF">Distribution of consultations of leading diseases by States, Epi week '.$epicalendar->week_no.'</font></td></tr>
        ';
                $zonedistributiontable .= '<tr bgcolor="#892A24"><td><font color="#FFFFFF">'.$country->first_admin_level_label.'</font></td>';

                foreach($diseasearray as $key=>$highestdiseasecode)
                {
                    $zonedistributiontable .= '<td><font color="#FFFFFF">'.$highestdiseasecode.'</font></td>';

                }

                $zonedistributiontable .= '<td><font color="#FFFFFF">Total</font></td></tr>';

                foreach($zonediseases as $key=>$zonedisease):

                    if($bg_color == 'bgcolor="#CCCCCC"')
                    {
                        $bg_color = '';
                    }
                    else
                    {
                        $bg_color = 'bgcolor="#CCCCCC"';
                    }

                    $zonedistributiontable .= '<tr '.$bg_color.'><td>'.$zonedisease->zone.'</td>';
                    $tot = 0;

                    foreach($diseasearray as $thekey=>$highestdiseasecode)
                    {
                        $disease_element = $highestdiseasecode;

                        $total_disease_cases = $zonedisease->$disease_element;
                        $zonedistributiontable .= '<td>'.$total_disease_cases.'</td>';
                        $tot = $tot+$total_disease_cases;

                    }

                    $zonedistributiontable .= '<td>'.$tot.'</td></tr>';

                endforeach;


                $zonedistributiontable .= '</table>';

                /*********************End of distribution table*************************/

                // Total processes
                $total = 3;
                // Loop through process
                for($i=1; $i<=$total; $i++) {
                    // Calculate the percentation
                    $percent = intval($i / $total * 100) . "%";
                    ?><script language="javascript">
                        document.getElementById("progress").innerHTML="<div style=\"width:<?php echo $percent;?>;background-color:#ddd;\">&nbsp;</div>";
                        document.getElementById("information").innerHTML="<?php $i;?> row(s) processed.";
                    </script><?php

                    // This is for the buffer achieve the minimum size in order to flush data
                    echo str_repeat(' ',1024*64);


// Send output to browser immediately
                    flush();


// Sleep one second so we can see the delay
                    sleep(1);
                }

                // Tell user that the process is completed
                echo '<script language="javascript">document.getElementById("information").innerHTML="Process completed"</script>';

                $data['bulletin_id'] = 1;
                $data['last_week'] = $last_week;
                $data['first_week'] = $first_week;
                $data['first_year'] = $first_year;
                $data['last_year'] = $last_year;
                $data['map_center'] = $country->map_center;
                $data['epicalendar'] =  $epicalendar;
                $data['highlight'] = $highlight;
                $data['country'] = $country;
                $data['categories'] = $categories;
                $data['consultations_column'] = $consultations_column;
                $data['reporting_sites_column'] = $reporting_sites_column;
                $data['total_facilities'] = $total_facilities;
                $data['zonecategories'] = $zonecategories;
                $data['zonereportingrate'] = $zonereportingrate;
                $data['distribution_table'] = $distribution_table;
                $data['bgcolor'] = $bgcolor;
                $data['graphcategories'] = $graphcategories;
                $data['alertseries'] = $alertseries;
                $data['colors'] = $colors;
                $data['interestcategory'] = $interestcategory;
                $data['interestseries'] = $interestseries;
                $data['leading_diseases'] = $leading_diseases;
                $data['outbreakcategories'] = $outbreakcategories;
                $data['outbreakseries'] = $outbreakseries;
                $data['highest_disease_code'] = $highest_disease_code;
                $data['piedata'] = $piedata;
                $data['previous_year'] = $previous_year;
                $data['respseries'] = $respseries;
                $data['respcategory'] = $respcategory;
                $data['gastroseries'] = $gastroseries;
                $data['measseries'] = $measseries;
                $data['malsearies'] = $malsearies;
                $data['leadingdiseasetable'] = $leadingdiseasetable;
                $data['reportintable'] = $reportintable;
                $data['zonedistributiontable'] = $zonedistributiontable;

                $this->load->view('epibulletins/buletintemplate', $data);

            }//end bulettin availability check


        }//end form validation
    }

    public function generatebulletinold()
    {
        if (!$this->erkanaauth->try_session_login()) {
            redirect('login','refresh');
        }
        $this->load->library('form_validation');

        $this->form_validation->set_rules('week_no', 'Week no', 'trim|required');
        $this->form_validation->set_rules('week_year', 'Week year', 'trim|required');
        $this->form_validation->set_rules('country_id', 'Country id', 'trim|required');

        if ($this->form_validation->run() == false) {
            $this->add();
        } else {
            $current_week = $this->input->post('week_no');
            $current_year = $this->input->post('week_year');
            $country_id = $this->input->post('country_id');

            $country = $this->countriesmodel->get_by_id($country_id)->row();

            //$next_week = ($current_week+1);

            if($current_week==52)
            {
                $comming_week = 52;
            }
            else
            {
                $comming_week = ($current_week+1);
            }

            //$week_array = $this->getStartAndEndDate($current_week,$current_year);
            $week_array = $this->getStartAndEndDate($comming_week,$current_year);

            $epicalendar = $this->epdcalendarmodel->get_by_year_week_country($current_year,$current_week,$country_id)->row();

            $row = $this->db->get_where('epibulletins', array('epicalendar_id' => $epicalendar->id))->row();

            if(!empty($row))
            {
                $this->session->set_flashdata('error_message', 'A bulletin for week '.$current_week.' '.$current_year.' in '.$country->country_name.' has already been added.');

                redirect('epibulletins','refresh');
            }//end first if for $row empty check
            else
            {

                $zon_id = 0;
                $reg_id = 0;
                $dist_id = 0;
                $hf_id = 0;

                $yearepilists = $this->epdcalendarmodel->get_list_by_year_country($current_year,$country_id);
                $epiyearidArray = array();

                foreach($yearepilists as $key=>$yearepilist):

                    $epiyearidArray[] = $yearepilist['id'];
                endforeach;

                $first_id = reset($epiyearidArray);
                $last_id = end($epiyearidArray);

                /***HIGHLIGH SECTTION **/

                $reporting_facilities = $this->formsmodel->getreportingsites($epicalendar->id, $dist_id,$reg_id,$zon_id,$hf_id);

                $healthfacilities = $this->healthfacilitiesmodel->get_list_by_country($country_id);
                $total_facilities = count($healthfacilities);

                $zones = $this->zonesmodel->get_country_list($country_id);
                $total_zones = count($zones);

                if($total_facilities==0)
                {
                    $hf_percentage=0;
                }
                else
                {
                    $hf_percentage = ($reporting_facilities/$total_facilities)*100;
                }

                $consultations = $this->formsmodel->getconsultations($epicalendar->id, $dist_id,$reg_id,$zon_id,$hf_id);

                $find_last_week = ($current_week-1);
                if($find_last_week=0)
                {
                    $last_year = ($current_year-1);
                    $last_week = 52;
                    $query_year = $last_year;
                }
                else
                {
                    $query_year = $current_year;
                    $last_week = ($current_week-1);
                }

                $previousepi = $this->epdcalendarmodel->get_by_year_week_country($query_year,$last_week,$country_id)->row();
                $previous_consultations = $this->formsmodel->getconsultations($previousepi->id, $dist_id,$reg_id,$zon_id,$hf_id);


                $previous_reporting_facilities = $this->formsmodel->getreportingsites($previousepi->id, $dist_id,$reg_id,$zon_id,$hf_id);
                if($total_facilities==0)
                {
                    $prev_hf_percentage=0;
                }
                else
                {
                    $prev_hf_percentage = ($previous_reporting_facilities/$total_facilities)*100;
                }



                $diseasecount = $this->diseasesmodel->get_country_list($country_id);
                $limit = count($diseasecount);

                $diseases  = $this->db->get_where('diseases', array('country_id' => $country_id),$limit);

                $diseasearray = array();

                $colors = "";
                foreach ($diseases->result() as $disease):
                    $diseasearray[] = $disease->disease_code;
                    $colors .= "'".$disease->color_code."',";

                endforeach;


                $lists = $this->reportsmodel->get_full_list_case_single_week($epicalendar->id,$dist_id,$reg_id,$zon_id,$hf_id,$diseasearray);

                //find the highest number of mobirdity

                $highlightArray = array();

                foreach($lists as $key=>$list)
                {
                    foreach($diseasearray as $key=>$diseasecode):
                        $disease_element = $diseasecode;

                        $highlightArray["".$diseasecode.""] = $list->$disease_element;

                    endforeach;
                }

                $highest_highlight_num    = max($highlightArray);
                $highest_disease = array_keys($highlightArray, max($highlightArray));

                $total_highlight = $consultations;
                $previous_total_highlight = $previous_consultations;

                if($total_highlight==0)
                {
                    $highlight_percentage = 0;
                }
                else
                {
                    $highlight_percentage = ($highest_highlight_num/$total_highlight)*100;
                }


                $highlight = '<ul>';
                $highlight .= '<li>Reports were received from '.$reporting_facilities.' out of '.$total_facilities.' reporting facilities ('.number_format($hf_percentage,1).'%) in week '.$epicalendar->week_no.'. Compared to '.$previous_reporting_facilities.' ('.number_format($prev_hf_percentage,1).'%) in week '.$previousepi->week_no.'.</li>';

                $highlight .= '<li>The total number of consultatations reported during the reporting week was '.number_format($consultations).' compared to '.number_format($previous_consultations).' consultations during week '.$previousepi->week_no.'. </li>';



                //first paragraph
                $highlight .= '<li>The highest number of consultations in week '.$epicalendar->week_no.' were ';
                $positions = $this->top_three_positions($highlightArray);
                $total_percent = 0;

                $highestdiseaseArray = array();

                foreach($positions as $key=>$position)
                {

                    if($total_highlight==0)
                    {
                        $disease_percentage = 0;
                    }
                    else
                    {
                        $disease_percentage = ($position/$total_highlight)*100;
                    }


                    if($position==min($positions))
                    {
                        $highlight .= 'followed by ';
                    }

                    $highlight .= $key.'('.number_format($position).' cases)';

                    if($position!=min($positions))
                    {
                        $highlight .= ', ';
                    }
                    else
                    {
                        $highlight .= ' ';
                    }

                    $highestdiseaseArray[] = $key;
                }


                $highlight .= '</li>';


                //disease of interest
                $diseasesofinterest = $this->diseaseofinterestmodel->get_combined_list($country_id);

                $diseseinterestarray = array();
                $interestidArray = array();
                foreach($diseasesofinterest as $key=>$diseaseofinterest):

                    $diseseinterestarray[] = $diseaseofinterest->disease_code;
                    $interestidArray[] = $diseaseofinterest->id;

                endforeach;

                $first_interest_id = reset($interestidArray);
                $last_interest_id = end($interestidArray);

                $interest_diseases = '';
                $diseases_of_interest = '';

                foreach($diseseinterestarray as $key=>$diseaseinterestcode):

                    $interest_cases = $this->formsdatamodel->disease_interest_epi($epicalendar->id,$country_id,$dist_id,$reg_id,$zon_id,$hf_id,$diseaseinterestcode);
                    $previous_cases = $this->formsdatamodel->disease_interest_epi($previousepi->id,$country_id,$dist_id,$reg_id,$zon_id,$hf_id,$diseaseinterestcode);

                    $cummulative_cases = $this->formsdatamodel->cummulative_interest_figures($first_id,$last_id,$country_id,$diseaseinterestcode);

                    $interest_diseases .= '<li><strong>'.number_format($cummulative_cases).'</strong> cumulative cases of '.$diseaseinterestcode.'</li>';


                    if($previous_cases<$interest_cases)
                    {
                        $interesttext = 'There was an increase in the number of '.$diseaseinterestcode.' cases from';
                        $conjoin = 'to';
                    }
                    else if($previous_cases>$interest_cases)
                    {
                        $interesttext = 'The number of '.$diseaseinterestcode.' decreased from ';
                        $conjoin = 'to';
                    }
                    else
                    {
                        $interesttext = 'There was no change on the number of '.$diseaseinterestcode.' cases with the number remaining at';
                        $conjoin = 'and';
                    }

                    $highlight .= '<li>'.$interesttext.' '.number_format($previous_cases).' cases in week '.$previousepi->week_no.' '.$conjoin.' '.number_format($interest_cases).' cases in week '.$epicalendar->week_no.'</li>';


                endforeach;



                $highlight .= '</ul>';

                /***END HIGHLIGHT***/

                /***Cumulative figures***/

                $cases = $this->formalertsmodel->get_total_alerts($epicalendar->id,$dist_id,$reg_id,$zon_id,$hf_id);
                $true_cases = $this->formalertsmodel->get_total_true_alerts($epicalendar->id,$dist_id,$reg_id,$zon_id,$hf_id);


                $cummulative_consultations = $this->formsdatamodel->cummulative_figures($first_id,$last_id,$country_id);


                $cumulative_figures = '<ul>';


                $cumulative_figures .= '<li><strong>'.number_format($cummulative_consultations).'</strong> total consultations</li>';
                $cumulative_figures .= $interest_diseases;
                $cumulative_figures .= '<li><strong>'.$reporting_facilities.'</strong> health facilities submitted reports in week '.$epicalendar->week_no.'</li>';
                $cumulative_figures .= '<li><strong>'.$cases.'</strong> Alerts were received from all regions</li>';
                $cumulative_figures .= '<li><strong>'.$true_cases.'</strong> were true alerts</li>';

                $cumulative_figures .= '</ul>';

                /******/

                $end_date = $week_array['week_start'];

                $baseline_date = date('Y-m-d', strtotime('-10 weeks', strtotime($end_date)));

                $first_week = date("W", strtotime($baseline_date));
                $last_week = date("W", strtotime($end_date));

                $first_year = date("Y", strtotime($baseline_date));
                $last_year = date("Y", strtotime($end_date));

                /****End consultations and reporting rates****/

                $epi_lists = $this->epdcalendarmodel->get_list_by_date($baseline_date,$end_date,$country_id);
                $categories = '';
                $consultations_column = '';
                $reporting_sites_column = '';

                foreach($epi_lists as $key=>$epi_list)
                {
                    $consultations = $this->formsmodel->getconsultations($epi_list->id, $dist_id,$reg_id,$zon_id,$hf_id);
                    $reporting_sites = $this->formsmodel->getreportingsites($epi_list->id, $dist_id,$reg_id,$zon_id,$hf_id);

                    $categories .=  "'Wk".$epi_list->week_no."',";
                    $consultations_column .= $consultations.',';
                    $reporting_sites_column .= $reporting_sites.',';

                }


                //zone reporting rates

                $zonecategories    = "";
                $zonereportingrate = "";

                foreach($zones as $key=>$zone)
                {
                    $thezonehf = $this->healthfacilitiesmodel->get_by_zone($zone['id']);
                    $hfsinzone          = count($thezonehf->result());

                    $zone_reporting_sites = $this->formsmodel->getreportingsites($epicalendar->id, $dist_id,$reg_id,$zone['id'],$hf_id);
                    if ($zone_reporting_sites == 0) {
                        $percentagezonereporting = 0;
                    } else {
                        $percentagezonereporting = ($zone_reporting_sites / $hfsinzone) * 100;
                    }

                    $zonecategories .= "'" . $zone['zone'] . "',";

                    $zonereportingrate .= number_format($percentagezonereporting, 1) . ", ";

                }


                /****End consultations and reporting rates****/

                /**alerts map **/

                $points = array();

                $maps = $this->formalertsmodel->get_list_by_period_limit($epicalendar->id,$dist_id,$reg_id,$zon_id,$hf_id);

                $map_elements = 'http://maps.google.com/maps/api/staticmap?center='.$country->country_name.'&zoom=5&size=512x512&maptype=hybrid';

                foreach($maps as $key=>$map)
                {
                    if(empty($map->lat))
                    {
                        //do not show
                    }
                    else
                    {

                        $gps['lat'] = $map->lat;
                        $gps['lng'] = $map->long;
                        $mapdata['position'] = $gps;
                        $mapdata['icon'] = ''.base_url().'img/warning.png';
                        $mapdata['info'] = '
							   Zone: '.$map->zone.'<br>
							   Region: '.$map->region.'<br>
							   District: '.$map->district.'<br>
							   Health Facility: '.$map->health_facility.'<br>
							   Alert: '.$map->disease_name.'<br>
							   Cases: '.$map->cases.'<br>
							   Date Reported: '.date("d F Y", strtotime($map->entry_date)).'<br>
							   Time reported: '.$map->entry_time.'<br>
							   Reported by: '.$map->username.'<br>
							   Contact: '.$map->contact_number.'<br>
							   ';

                        $map_elements .= '&markers=icon:http://ewarn.emro.who.int/SOM/img/warning.png|label:P|'.$map->lat.','.$map->long.'';


                        $points[] = $mapdata;
                    }

                }

                $map_elements .= '&sensor=false';
                $map_json =  json_encode($points,JSON_HEX_QUOT | JSON_HEX_TAG);

                $map_elements .= '&sensor=false';

                $image = file_get_contents($map_elements);

                $fp  = fopen('./images/reportelements/'.$country->country_code.'_'.$current_week.'_'.$current_year.'.jpg', 'w+');

                fputs($fp, $image);
                fclose($fp);
                unset($image);

                $map_image = $country->country_code.'_'.$current_week.'_'.$current_year.'.jpg';

                /**End alerts map***/


                /******EPI curve******/

                $epi_id_one = $this->epdcalendarmodel->get_by_country_date($country_id,$baseline_date);
                $epi_id_two = $this->epdcalendarmodel->get_by_country_date($country_id,$end_date);

                $int_end_date = $week_array['week_start'];

                $int_start_date = date('Y-m-d', strtotime('-10 weeks', strtotime($int_end_date)));

                $epilists = $this->epdcalendarmodel->get_list_by_date($int_start_date,$int_end_date,$country_id);

                $epicalendaridArray = array();

                foreach($epilists as $key=>$epilist)
                {
                    $epicalendaridArray[] =  $epilist->id;

                }

                //$interest_lists = $this->formsdatamodel->disease_interest_numbers($epi_id_one,$previousepi->id,$country_id,$dist_id,$reg_id,$zon_id,$hf_id,$diseseinterestarray);
                $interest_lists = $this->formsdatamodel->disease_interest_epi_numbers($epicalendaridArray,$country_id,$dist_id,$reg_id,$zon_id,$hf_id,$diseseinterestarray);

                $interestseries = '';
                $interestcategory = '';

                $seriescolor = "";
                //foreach($diseseinterestarray as $key=>$diseaseinterestcode):
                foreach($diseasesofinterest as $key=>$diseaseofinterest):

                    $interestseries .= '{';
                    //$interestseries .= "name: '".$diseaseinterestcode."',";
                    $interestseries .= "name: '".$diseaseofinterest->disease_code."',";
                    $interestseries .= 'data: [';

                    $seriescolor .= "'".$diseaseofinterest->color_code."',";
                    $elem = $diseaseofinterest->disease_code;
                    /**
                    foreach($interest_lists as $key=>$interest_list)
                    {
                    //$interestseries .= number_format($interest_list->$diseaseinterestcode).',';
                    $interestseries .= number_format($interest_list->$elem).',';


                    }
                     **/

                    foreach($interest_lists as $key=>$interest_list)
                    {
                        $interestseries .= number_format($interest_list->$diseaseinterestcode).',';

                        $interestcategory .= "'WK.".$interest_list->week_no."',";

                    }


                    $interestseries .= ']';

                    $interestseries .= '},';

                endforeach;

                /********End EPI curve************/

                /***Number of alerts received and reported***/
                $alerts = $this->reportsmodel->get_full_list_alert_week($query_year,$current_year,$previousepi->id,$epicalendar->id,$dist_id,$reg_id,$zon_id,$hf_id,$diseasearray);

                $graphcategories = '';
                $alertseries = '';

                foreach ($alerts as $key => $alert) {

                    $graphcategories .= "'Wk".$alert->week_no."',";
                }

                foreach($diseasearray as $key=>$diseasecode):

                    $alertseries .= "{
						name: '".$diseasecode."',
						data: [";

                    foreach ($alerts as $key => $alert) {

                        $alert_element = $diseasecode;

                        $alertseries .= $alert->$alert_element.",";

                    }

                    $alertseries .= "]";

                    $alertseries .= "},";

                endforeach;


                /***End alerts received**/


                /***********Summary of diseases reported***********/

                $caselists = $this->reportsmodel->get_full_list_case_week($first_year,$last_year,$previousepi->id,$epicalendar->id,$dist_id,$reg_id,$zon_id,$hf_id,$diseasearray);

                //$caselists = $this->formsmodel->get_full_list($first_year, $last_year, $previousepi->id,$epicalendar->id, $dist_id, $reg_id, $zon_id, $hf_id,$diseasearray);

                //get previous week data
                $previouslists = $this->reportsmodel->get_full_list_case_single_week($previousepi->id,$dist_id,$reg_id,$zon_id,$hf_id,$diseasearray);

                $leadingdiseasetable = '<table id="datatable" width="100%" border="1" cellspacing="0" cellpadding="2" bordercolor="#892a24">';
                $leadingdiseasetable .= '<tr bgcolor="#892A24" bordercolor="#892A24"><td><font color="#FFFFFF">Disease/syndrome</font></td>';

                foreach ($caselists as $key => $caselist):

                    $leadingdiseasetable .='<td colspan="3" align="center"><font color="#FFFFFF">Epi week ' . $caselist->week_no . '</font></td>';

                endforeach;

                $leadingdiseasetable .= '</tr>';
                $leadingdiseasetable .= '<tr bgcolor="#892A24"><td>&nbsp;</td><td><font color="#FFFFFF">Cases &lt;5</font></td><td><font color="#FFFFFF">Cases &gt;5</font></td><td><font color="#FFFFFF">Total Cases</font></td><td><font color="#FFFFFF">Cases &lt;5</font></td><td><font color="#FFFFFF">Cases &gt;5</font></td><td><font color="#FFFFFF">Total Cases</font></td></tr>';

                $total_current_week = 0;
                $total_previous_week = 0;
                $bg_color = 'bgcolor="#CCCCCC"';

                foreach($diseasearray as $key=>$highestdiseasecode)
                {

                    if($bg_color == 'bgcolor="#CCCCCC"')
                    {
                        $bg_color = '';
                    }
                    else
                    {
                        $bg_color = 'bgcolor="#CCCCCC"';
                    }
                    $leadingdiseasetable .= '<tr '.$bg_color.'><td>'.$highestdiseasecode.'</td>';
                    foreach ($caselists as $key => $caselist):

                        $high_disease_element = $highestdiseasecode;
                        $under_five_element = $highestdiseasecode.'_T_U_F';
                        $over_five_element = $highestdiseasecode.'_T_O_F';

                        if($caselist->epicalendar_id==$epicalendar->id)
                        {
                            /**
                            if($total_highlight==0)
                            {
                            $disease_week_percentage = 0;
                            }
                            else
                            {
                            $disease_week_percentage = ($caselist->$high_disease_element/$total_highlight)*100;
                            }
                             **/
                            $total_current_week = $total_current_week+$caselist->$high_disease_element;

                        }
                        else
                        {
                            /**
                            if($previous_total_highlight==0)
                            {
                            $disease_week_percentage = 0;
                            }
                            else
                            {
                            $disease_week_percentage = ($caselist->$high_disease_element/$previous_total_highlight)*100;
                            }
                             **/

                            $total_previous_week = $total_previous_week+$caselist->$high_disease_element;
                        }

                        $leadingdiseasetable .= '<td>'.number_format($caselist->$under_five_element).'</td><td>'.number_format($caselist->$over_five_element).'</td><td>'.number_format($caselist->$high_disease_element).'</td>';
                    endforeach;

                    $leadingdiseasetable .= '</tr>';
                }


                $leadingdiseasetable .= '</table>';
                /***********Summary of diseases reported***********/

                /**Trends of malaria morbidity in week **/

                $alert_end_date = $week_array['week_start'];

                $alert_start_date = date('Y-m-d', strtotime('-4 weeks', strtotime($alert_end_date)));

                $alertepilists = $this->epdcalendarmodel->get_list_by_date($alert_start_date,$alert_end_date,$country_id);

                $alertepicalendaridArray = array();
                $alertyearArray = array();
                $alertweekArray = array();

                foreach($alertepilists as $key=>$alertepilist)
                {
                    $alertepicalendaridArray[] =  $alertepilist->id;
                    $alertyearArray[] =  $alertepilist->epdyear;
                    $alertweekArray[] =  $alertepilist->week_no;

                }

                //if the country has no calendar added
                if(empty($alertepicalendaridArray))
                {

                    $firstid = 0;
                    $lastid = 0;
                    $alert_from_date = DateTime::createFromFormat("Y-m-d", $alert_start_date);
                    $alert_from_year =  $alert_from_date->format("Y");

                    $alert_to_date = DateTime::createFromFormat("Y-m-d", $alert_end_date);
                    $alert_to_year =  $alert_to_date->format("Y");

                    $alert_from_week = date("W", strtotime($alert_start_date));
                    $alert_to_week = date("W", strtotime($alert_end_date));
                }
                else
                {

                    $firstid = reset($alertepicalendaridArray);
                    $lastid = end($alertepicalendaridArray);

                    $alert_from_year = reset($alertyearArray);
                    $alert_to_year = end($alertyearArray);

                    $alert_from_week = reset($alertweekArray);
                    $alert_to_week = end($alertweekArray);

                }


                $malarialists = $this->formsmodel->malariareport($firstid,$lastid,$dist_id,$reg_id,$zon_id);
                $malariacategories = '';
                $malariadata = '';
                $frdata = '';
                $sprdata = '';
                $malariaufivedata = '';
                $malariaofivedata = '';

                foreach ($malarialists as $key => $malarialist) {

                    $totalslides = $malarialist->totpv + $malarialist->totpmix + $malarialist->totpf;
                    $sre = $malarialist->totsre;

                    if($totalslides==0)
                    {
                        $spr = 0;
                        $fr = 0;
                    }
                    else
                    {
                        if($sre==0)
                        {
                            $spr = 0;
                        }
                        else
                        {
                            $spr = ($totalslides/$sre) * 100;
                        }
                        $fr = ($malarialist->totpf/$totalslides) * 100;
                    }

                    $malariacategories .= "'WK ".$malarialist->epdyear."/".$malarialist->week_no."', ";
                    $frdata .= "".number_format($fr).", ";
                    $sprdata .= "".number_format($spr).", ";


                }

                unset($malarialists);

                $mallists = $this->formsmodel->malariadata($firstid,$lastid,$dist_id,$reg_id,$zon_id);


                foreach ($mallists as $key => $mallist) {

                    $malariaufivedata .= "".$mallist->disease_under_five.", ";
                    $malariaofivedata .= "".$mallist->disease_over_five.", ";

                }

                unset($mallists);


                /**End rends of malaria morbidity in week **/


                /**Summary of malaria morbidity**/

                $zonesarray = array();
                foreach($zones as $key=>$zone)
                {
                    $zonesarray[] = $zone['id'];
                }

                $malariareports = $this->formsmodel->malaria_week_report_zones($epicalendar->id,$zonesarray);
                $malariazonereports = $this->formsdatamodel->malaria_week_report_zones($epicalendar->id,$zonesarray);


                $malariatable = '<table id="datatable" width="100%" border="1" cellspacing="0" cellpadding="2" bordercolor="#892a24">';

                $malariatable .= '<tr bgcolor="#892A24" bordercolor="#892A24"><td><font color="#FFFFFF">&nbsp;</font></td>';


                foreach($zones as $key=>$zone)
                {
                    $malariatable .= '<td><font color="#FFFFFF">'.$zone['zone'].'</font></td>';

                }

                $malariatable .= '</tr>';


                for($i=1;$i<=7;$i++)
                {
                    if($i==1)
                    {
                        $td_element = 'Pf';
                    }
                    if($i==2)
                    {
                        $td_element = 'Pv';
                    }
                    if($i==3)
                    {
                        $td_element = 'Mixed';
                    }
                    if($i==4)
                    {
                        $td_element = 'SPR';
                    }
                    if($i==5)
                    {
                        $td_element = 'FR';
                    }
                    if($i==6)
                    {
                        $td_element = 'Total +ve Slides';
                    }
                    if($i==7)
                    {
                        $td_element = 'Total Slides Tested';
                    }
                    $malariatable .= '<tr><td>'.$td_element.'</td>';

                    foreach($zonesarray as $key=>$zoneid)
                    {
                        $malariatable .= '<td>';

                        foreach($malariareports as $key=>$malariareport):

                            if($i==1)
                            {

                                if($malariareport->zone_id==$zoneid)
                                {
                                    $malariatable .= $malariareport->totpf;
                                }
                                else
                                {
                                    $malariatable .= 0;
                                }

                            }
                            if($i==2)
                            {
                                if($malariareport->zone_id==$zoneid)
                                {
                                    $malariatable .= $malariareport->totpv;
                                }
                                else
                                {
                                    $malariatable .= 0;
                                }
                            }
                            if($i==3)
                            {
                                if($malariareport->zone_id==$zoneid)
                                {
                                    $malariatable .= $malariareport->totpmix;
                                }
                                else
                                {
                                    $malariatable .= 0;
                                }
                            }
                            if($i==4)
                            {

                                if($malariareport->zone_id==$zoneid)
                                {

                                    if($malariareport->totsre==0)
                                    {
                                        $malariatable .= '0%';
                                    }
                                    else
                                    {
                                        if($malariareport->slides_tested==0)
                                        {
                                            $malariatable .= '0%';
                                        }
                                        else
                                        {
                                            $spr = ($malariareport->slides_tested/$malariareport->totsre) * 100;
                                            $malariatable .= number_format($spr).'%';
                                        }
                                    }

                                }
                                else
                                {
                                    $malariatable .= '0%';
                                }

                            }
                            if($i==5)
                            {
                                if($malariareport->zone_id==$zoneid)
                                {
                                    if($malariareport->totsre==0)
                                    {
                                        $malariatable .= '0%';
                                    }
                                    else
                                    {
                                        if($malariareport->slides_tested==0)
                                        {
                                            $malariatable .= '0%';
                                        }
                                        else
                                        {
                                            $fr = ($malariareport->totpf/$malariareport->slides_tested) * 100;
                                            $malariatable .= number_format($fr).'%';
                                        }

                                    }
                                }
                                else
                                {
                                    $malariatable .= '0%';
                                }


                            }
                            if($i==6)
                            {
                                if($malariareport->zone_id==$zoneid)
                                {
                                    $malariatable .= $malariareport->positive_slides;
                                }
                                else
                                {
                                    $malariatable .= 0;
                                }
                            }
                            if($i==7)
                            {
                                if($malariareport->zone_id==$zoneid)
                                {
                                    $malariatable .= $malariareport->slides_tested;
                                }
                                else
                                {
                                    $malariatable .= 0;
                                }
                            }

                        endforeach;

                        $malariatable .= '</td>';

                    }


                    $malariatable .= '</tr>';
                }

                $malariatable .= '<tr><td>Clinically Suspected</td>';

                foreach($zonesarray as $key=>$zoneid)
                {
                    $malariatable .= '<td>';

                    foreach($malariazonereports as $key=>$malariazonereport):

                        if($malariazonereport->zone_id==$zoneid)
                        {
                            $malariatable .= $malariazonereport->diease_total;
                        }
                        else
                        {
                            $malariatable .= 0;
                        }

                    endforeach;

                    $malariatable .= '</td>';
                }




                $malariatable .= '</tr>';


                $malariatable .= '</table>';

                unset($malariazonereports);
                unset($malariareports);


                /**end 	Summary of malaria morbidity **/


                /*******Summary of diseases of interest by region********/
                $final_date = $week_array['week_start'];
                $first_date = date('Y-m-d', strtotime('-3 weeks', strtotime($final_date)));
                $epilists = $this->epdcalendarmodel->get_list_by_date($first_date,$final_date,$country_id);

                //$epicalendaridArray = array();
                //$yearArray = array();
                //$weekArray = array();

                //$first_interest_id = reset($interestidArray);
                // $last_interest_id = end($interestidArray);

                $thedisease = $this->diseasesmodel->get_by_id($first_interest_id)->row();

                $interesttable = '<table id="datatable" width="100%" border="1" cellspacing="0" cellpadding="2" bordercolor="#892a24">';
                $interesttable .= '<tr bgcolor="#892A24" bordercolor="#892A24"><td colspan="10"><font color="#FFFFFF">Summary of '.$thedisease->disease_name.' cases by region as of week '.$epicalendar->week_no.', '.$epicalendar->epdyear.'</font></td></tr>';
                $interesttable .= '<tr bgcolor="#892A24" bordercolor="#892A24"><td><font color="#FFFFFF">Region</font></td>';

                $intarray[] = array();
                foreach($epilists as $key=>$epilist)
                {
                    $intarray[] =  $epilist->id;
                    //$yearArray[] =  $epilist->epdyear;
                    //$weekArray[] =  $epilist->week_no;

                    $interesttable .= '<td colspan="3"><font color="#FFFFFF">Week '.$epilist->week_no.'</font></td>';

                }


                $interesttable .= '</tr>';

                $interesttable .= '<tr bgcolor="#892A24"><td>&nbsp;</td><td><font color="#FFFFFF">Cases &lt;5</font></td><td><font color="#FFFFFF">Cases &gt;5</font></td><td><font color="#FFFFFF">Total Cases</font></td><td><font color="#FFFFFF">Cases &lt;5</font></td><td><font color="#FFFFFF">Cases &gt;5</font></td><td><font color="#FFFFFF">Total Cases</font></td><td><font color="#FFFFFF">Cases &lt;5</font></td><td><font color="#FFFFFF">Cases &gt;5</font></td><td><font color="#FFFFFF">Total Cases</font></td></tr>';

                $regionarray = array();
                $regions = $this->regionsmodel->get_by_country($country_id);


                foreach($regions as $key=>$region)
                {
                    $regionarray[] = $region->id;

                }


                $regionsinterest = $this->diseaseofinterestmodel->get_cases_by_region($firstid,$lastid,$first_interest_id,$regionarray);



                foreach($regions as $key=>$region)
                {



                    if($bg_color == 'bgcolor="#CCCCCC"')
                    {
                        $bg_color = '';
                    }
                    else
                    {
                        $bg_color = 'bgcolor="#CCCCCC"';
                    }

                    $interesttable .= '<tr '.$bg_color.'><td>'.$region->region.'</td>';

                    $j = 0;
                    foreach($epilists as $key=>$epilist)
                    {



                        /**
                        $epicases = $this->diseaseofinterestmodel->get_cases_by_region_disease($region->id, $first_interest_id, $epilist->id);

                        $interesttable .= '<td>'.$epicases->under_five.'</td><td>'.$epicases->over_five.'</td><td>'.number_format($epicases->disease_total).'</td>';

                         **/



                        foreach($regionsinterest as $key=>$regioninterest):

                            $j++;

                            $under_five = "Region_".$region->id."_T_U_F";
                            $over_five = "Region_".$region->id."_T_O_F";
                            $total_cases = "Region_".$region->id;

                            /**

                            if($regioninterest->epicalendar_id==$epilist->id)
                            {
                             **/
                            $under_five_col = $regioninterest->$under_five;
                            $over_five_col = $regioninterest->$over_five;
                            $cases_col = $regioninterest->$total_cases;
                            /**
                            echo $regioninterest->epicalendar_id.''.$epilist->id.'<br>';
                            }
                            else
                            {
                            $under_five_col = 0;
                            $over_five_col = 0;
                            $cases_col = 0;
                            }
                             **/

                            if($j<=3)
                            {
                                $interesttable .= '<td>'.number_format($under_five_col).'</td><td>'.number_format($over_five_col).'</td><td>'.number_format($cases_col).'</td>';
                            }




                        endforeach;


                    }



                    $interesttable .= '</tr>';
                }



                $interesttable .= '</table>';


                unset($regionarray);
                unset($regions);
                unset($regionsinterest);
                unset($j);
                unset($under_five);
                unset($over_five);
                unset($total_cases);


                $secdisease = $this->diseasesmodel->get_by_id($last_interest_id)->row();

                $lastinteresttable = '<table id="datatable" width="100%" border="1" cellspacing="0" cellpadding="2" bordercolor="#892a24">';
                $lastinteresttable .= '<tr bgcolor="#892A24" bordercolor="#892A24"><td colspan="10"><font color="#FFFFFF">Summary of '.$secdisease->disease_name.' cases by region as of week '.$epicalendar->week_no.', '.$epicalendar->epdyear.'</font></td></tr>';
                $lastinteresttable .= '<tr bgcolor="#892A24" bordercolor="#892A24"><td><font color="#FFFFFF">Region</font></td>';


                foreach($epilists as $key=>$epilist)
                {

                    $lastinteresttable .= '<td colspan="3"><font color="#FFFFFF">Week '.$epilist->week_no.'</font></td>';

                }


                $lastinteresttable .= '</tr>';

                $lastinteresttable .= '<tr bgcolor="#892A24"><td>&nbsp;</td><td><font color="#FFFFFF">Cases &lt;5</font></td><td><font color="#FFFFFF">Cases &gt;5</font></td><td><font color="#FFFFFF">Total Cases</font></td><td><font color="#FFFFFF">Cases &lt;5</font></td><td><font color="#FFFFFF">Cases &gt;5</font></td><td><font color="#FFFFFF">Total Cases</font></td><td><font color="#FFFFFF">Cases &lt;5</font></td><td><font color="#FFFFFF">Cases &gt;5</font></td><td><font color="#FFFFFF">Total Cases</font></td></tr>';

                $regionarray = array();
                $regions = $this->regionsmodel->get_by_country($country_id);


                foreach($regions as $key=>$region)
                {
                    $regionarray[] = $region->id;

                }


                $regionsinterest = $this->diseaseofinterestmodel->get_cases_by_region($firstid,$lastid,$last_interest_id,$regionarray);



                foreach($regions as $key=>$region)
                {

                    if($bg_color == 'bgcolor="#CCCCCC"')
                    {
                        $bg_color = '';
                    }
                    else
                    {
                        $bg_color = 'bgcolor="#CCCCCC"';
                    }

                    $lastinteresttable .= '<tr '.$bg_color.'><td>'.$region->region.'</td>';

                    $j = 0;
                    foreach($epilists as $key=>$epilist)
                    {

                        /**
                        $epicases = $this->diseaseofinterestmodel->get_cases_by_region_disease($region->id, $first_interest_id, $epilist->id);

                        $interesttable .= '<td>'.$epicases->under_five.'</td><td>'.$epicases->over_five.'</td><td>'.number_format($epicases->disease_total).'</td>';

                         **/

                        foreach($regionsinterest as $key=>$regioninterest):

                            $j++;

                            $under_five = "Region_".$region->id."_T_U_F";
                            $over_five = "Region_".$region->id."_T_O_F";
                            $total_cases = "Region_".$region->id;

                            /**

                            if($regioninterest->epicalendar_id==$epilist->id)
                            {
                             **/
                            $under_five_col = $regioninterest->$under_five;
                            $over_five_col = $regioninterest->$over_five;
                            $cases_col = $regioninterest->$total_cases;
                            /**
                            echo $regioninterest->epicalendar_id.''.$epilist->id.'<br>';
                            }
                            else
                            {
                            $under_five_col = 0;
                            $over_five_col = 0;
                            $cases_col = 0;
                            }
                             **/

                            if($j<=3)
                            {
                                $lastinteresttable .= '<td>'.number_format($under_five_col).'</td><td>'.number_format($over_five_col).'</td><td>'.number_format($cases_col).'</td>';
                            }




                        endforeach;


                    }



                    $lastinteresttable .= '</tr>';
                }



                $lastinteresttable .= '</table>';

                unset($epiyearidArray);
                unset($yearepilists);


                /*****Summary of epidemic prone diseases and syndromes in different districts******/
                $districts = $this->districtsmodel->get_by_country($country_id);

                $districtarray = array();

                foreach($districts as $key=>$district)
                {
                    $districtarray[] = $district->id;
                }


                $districtdiseases = $this->formsmodel->location_disease_week($epicalendar->id,$districtarray,$diseasearray);

                $colspan = ($limit+1);

                $summarytable = '<table id="datatable" width="100%" border="1" cellspacing="0" cellpadding="2" bordercolor="#892a24">';
                $summarytable .= '<thead>';
                $summarytable .= '<tr bgcolor="#892A24"><td colspan="'.$colspan.'"><font color="#FFFFFF">Summary of epidemic prone diseases and syndromes in different '.$country->third_admin_level_label.' of '.$country->country_name.' as of week '.$epicalendar->week_no.'</font></td></tr>';

                $summarytable .= '<tr bgcolor="#892A24"><td><font color="#FFFFFF">'.$country->third_admin_level_label.'</font></td>';

                foreach($diseasearray as $key=>$highestdiseasecode)
                {
                    $summarytable .= '<td><font color="#FFFFFF">'.$highestdiseasecode.'</font></td>';

                }

                $summarytable .= '</tr>
			 </thead>
			 <tbody>';



                /**
                foreach($districts as $key=>$district)
                {
                $summarytable .= '<tr><td>'.$district->district.'</td>';
                $k = 0;
                foreach($districtdiseases as $key=>$districtdisease):
                foreach($diseasearray as $key=>$highestdiseasecode)
                {


                $k++;
                $disease_element = $highestdiseasecode;
                $district_element = $district->id;


                if($district->id==$districtdisease->district_id)
                {
                $total_disease_cases = $districtdisease->$disease_element;
                $summarytable .= '<td>'.$total_disease_cases.'</td>';
                }





                }

                endforeach;


                $summarytable .= '</tr>';
                }

                 **/

                foreach($districtdiseases as $key=>$districtdisease):

                    if($bg_color == 'bgcolor="#CCCCCC"')
                    {
                        $bg_color = '';
                    }
                    else
                    {
                        $bg_color = 'bgcolor="#CCCCCC"';
                    }

                    $summarytable .= '<tr '.$bg_color.'><td>'.$districtdisease->district.'</td>';

                    foreach($diseasearray as $key=>$highestdiseasecode)
                    {
                        $disease_element = $highestdiseasecode;
                        $district_element = $district->id;

                        $total_disease_cases = $districtdisease->$disease_element;
                        $summarytable .= '<td>'.$total_disease_cases.'</td>';

                    }

                    $summarytable .= '</tr>';

                endforeach;


                $summarytable .= '
			 </tbody>
			 </table>';

                $epi_curve_title = 'Epi curve for priority diseases weeks '.$first_week.' '.$first_year.' to '.$last_week.' '.$last_year.'';
                $graph_one_title = 'Reporting rates vs consultations in Somalia, Epi Weeks '.$first_week.' '.$first_year.' to '.$last_week.' '.$last_year.'';
                $summary_title = 'Summary of Diseases Reported in weeks '.$previousepi->week_no.' and '.$epicalendar->week_no.'';
                $malaria_table_title = 'Summary of malaria morbidity in week '.$epicalendar->week_no.' '.$epicalendar->epdyear.'';

                $footer_one = '*Epi=Epidemiological; Sus=Suspected; HF=Health Facility; ';

                foreach ($diseases->result() as $disease):
                    $footer_one .= $disease->disease_code.'='.$disease->disease_name.'; ';
                endforeach;

                $footer_one .= 'CSR=Communicable disease Surveillance and Response; INT=Insecticides Treated Nets';

                $footer_two = 'This weekly Epidemiological bulletin is published jointly by the Health Authorities and the World Health Organization. For further information, please contact the surveillance team on: '.$country->contact_email.'';

                $bulletindata = array(
                    'epicalendar_id' => $epicalendar->id,
                    'week_no' => $epicalendar->week_no,
                    'week_year' => $epicalendar->epdyear,
                    'from_date' => $epicalendar->from,
                    'to_date' => $epicalendar->to,
                    'country_id' => $country_id,
                    'highlight' => $highlight,
                    'cummulative_figures' => $cumulative_figures,
                    'graph_one_title' => $graph_one_title,
                    'consultations_column' => $consultations_column,
                    'reporting_sites_column' => $reporting_sites_column,
                    'epidemic_situation' => 'Please add text on the epidemic situation.......',
                    'alerts_map' => $map_json,
                    'epi_curve_title' => $epi_curve_title,
                    'categories' => $categories,
                    'interestseries' => $interestseries,
                    'summary_title' => $summary_title,
                    'leadingdiseasetable' => $leadingdiseasetable,
                    'malariacategories' => $malariacategories,
                    'malariaufivedata' => $malariaufivedata,
                    'malariaofivedata' => $malariaofivedata,
                    'sprdata' => $sprdata,
                    'frdata' => $frdata,
                    'malaria_table_title' => $malaria_table_title,
                    'malariatable' => $malariatable,
                    'interesttable' => $interesttable,
                    'doi_one_text' => 'add text on information on the first disease of interest (e.g. vaccination campaigns, outbreak response etc)....',
                    'lastinteresttable' => $lastinteresttable,
                    'doi_two_text' => 'add text on information on the second disease of interest (e.g. vaccination campaigns, outbreak response etc)....',
                    'summarytable' => $summarytable,
                    'reporting_rates_graph' => '-',
                    'epi_curve_graph' => '-',
                    'alerts_graph' => '-',
                    'malaria_graph' => '-',
                    'map_image' => $map_image,
                    'map_center' => $country->map_center,
                    'footer_one' => $footer_one,
                    'footer_two' => $footer_two,
                    'creation_date_time' => date("Y-m-d H:i:s"),
                );
                $this->db->insert('epibulletins', $bulletindata);
                $bulletin_id = $this->db->insert_id();



                $data = array();

                $data['bulletin_id'] = $bulletin_id;
                $data['first_year'] = $first_year;
                $data['last_year'] = $last_year;
                $data['first_week'] = $first_week;
                $data['last_week'] = $last_week;
                $data['map_center'] = $country->map_center;
                $data['epicalendar'] =  $epicalendar;
                $data['country'] =  $country;
                $data['highlight'] =  $highlight;
                $data['cumulative_figures'] = $cumulative_figures;
                $data['zonereportingrate'] =  $zonereportingrate;
                $data['zonecategories'] =  $zonecategories;
                $data['consultations_column'] =  $consultations_column;
                $data['reporting_sites_column'] =  $reporting_sites_column;
                $data['total_facilities'] =  $total_facilities;
                $data['categories'] =  $categories;
                $data['graphcategories'] = $graphcategories;
                $data['alertseries'] = $alertseries;
                $data['points'] =  $points;
                $data['interestseries'] = $interestseries;
                $data['previous_week'] = $previousepi->week_no;
                $data['leadingdiseasetable'] = $leadingdiseasetable;
                $data['malariacategories'] = $malariacategories;
                $data['frdata'] = $frdata;
                $data['sprdata'] = $sprdata;
                $data['malariaufivedata'] = $malariaufivedata;
                $data['malariaofivedata'] = $malariaofivedata;
                $data['malariatable'] = $malariatable;
                $data['interesttable'] = $interesttable;
                $data['lastinteresttable'] = $lastinteresttable;
                $data['summarytable'] = $summarytable;
                $data['diseases'] = $diseases;
                $data['previousepi'] = $previousepi;
                $data['colors'] = $colors;
                $data['seriescolor'] = $seriescolor;
                $data['interestcategory'] = $interestcategory;


                $this->load->view('epibulletins/template', $data);

            }//end first else checking availability of said bulletin
        }//end form validation

    }


    public function download()
    {

        $url = $_POST['url'];
        $object = $_POST['object'];
        $link = $url.''.$object;

        $country = $_POST['country'];
        $week_no = $_POST['week_no'];
        $week_year = $_POST['week_year'];
        $bulletin_id = $_POST['bulletin_id'];

        $image = file_get_contents($link);

        $fp  = fopen('./images/reportelements/rates_'.$country.'_'.$week_no.'_'.$week_year.'.jpg', 'w+');


        $reporting_rates_graph = 'rates_'.$country.'_'.$week_no.'_'.$week_year.'.jpg';


        fputs($fp, $image);
        fclose($fp);
        unset($image);

        $data = array(
            'reporting_rates_graph' => $reporting_rates_graph,
        );
       $this->db->where('id', $bulletin_id);
       $this->db->update('epibulletins', $data);


    }


    public function epicurve()
    {

        $url = $_POST['url'];
        $object = $_POST['object'];
        $link = $url.''.$object;

        $country = $_POST['country'];
        $week_no = $_POST['week_no'];
        $week_year = $_POST['week_year'];
        $bulletin_id = $_POST['bulletin_id'];

        $image = file_get_contents($link);

        $fp  = fopen('./images/reportelements/epicurve_'.$country.'_'.$week_no.'_'.$week_year.'.jpg', 'w+');


        $epi_curve_graph = 'epicurve_'.$country.'_'.$week_no.'_'.$week_year.'.jpg';


        fputs($fp, $image);
        fclose($fp);
        unset($image);

        $data = array(
            'epi_curve_graph' => $epi_curve_graph,
        );
        $this->db->where('id', $bulletin_id);
        $this->db->update('epibulletins', $data);


    }


    public function alertgraph()
    {

        $url = $_POST['url'];
        $object = $_POST['object'];
        $link = $url.''.$object;

        $country = $_POST['country'];
        $week_no = $_POST['week_no'];
        $week_year = $_POST['week_year'];
        $bulletin_id = $_POST['bulletin_id'];

        $image = file_get_contents($link);

        $fp  = fopen('./images/reportelements/alertgraph_'.$country.'_'.$week_no.'_'.$week_year.'.jpg', 'w+');


        $alerts_graph = 'alertgraph_'.$country.'_'.$week_no.'_'.$week_year.'.jpg';


        fputs($fp, $image);
        fclose($fp);
        unset($image);

        $data = array(
            'alerts_graph' => $alerts_graph,
        );
        $this->db->where('id', $bulletin_id);
        $this->db->update('epibulletins', $data);


    }


    public function malariagraph()
    {

        $url = $_POST['url'];
        $object = $_POST['object'];
        $link = $url.''.$object;

        $country = $_POST['country'];
        $week_no = $_POST['week_no'];
        $week_year = $_POST['week_year'];
        $bulletin_id = $_POST['bulletin_id'];

        $image = file_get_contents($link);

        $fp  = fopen('./images/reportelements/malariagraph_'.$country.'_'.$week_no.'_'.$week_year.'.jpg', 'w+');


        $malaria_graph = 'malariagraph_'.$country.'_'.$week_no.'_'.$week_year.'.jpg';


        fputs($fp, $image);
        fclose($fp);
        unset($image);

        $data = array(
            'malaria_graph' => $malaria_graph,
        );
        $this->db->where('id', $bulletin_id);
        $this->db->update('epibulletins', $data);



    }

    public function downloadpdf($id)
    {
        //create new PDF document
        $pdf = new Pdf(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);

        // set document information
        $pdf->SetCreator(PDF_CREATOR);
        $pdf->SetAuthor('WHO EMRO');
        $pdf->SetTitle('EPI Weekly Bulletin');
        $pdf->SetSubject('WHO EMRO Weekly Bulletin');
        $pdf->SetKeywords('WHO, EMRO, Bulletin, Diseases','Surveillance','EPI','Alerts');

        // set default header data
        $pdf->SetHeaderData(false, false, '', '');


        // set header and footer fonts
        $pdf->setHeaderFont(Array(PDF_FONT_NAME_MAIN, '', PDF_FONT_SIZE_MAIN));
        $pdf->setFooterFont(Array(PDF_FONT_NAME_DATA, '', PDF_FONT_SIZE_DATA));

        // set default monospaced font
        $pdf->SetDefaultMonospacedFont(PDF_FONT_MONOSPACED);


        //set margins
        //$pdf->SetMargins(PDF_MARGIN_LEFT, PDF_MARGIN_TOP, PDF_MARGIN_RIGHT);
        $pdf->SetMargins(8,8,8,8);
        $pdf->SetHeaderMargin(PDF_MARGIN_HEADER);
        $pdf->SetFooterMargin(PDF_MARGIN_FOOTER);

        //set auto page breaks
        $pdf->SetAutoPageBreak(TRUE, PDF_MARGIN_BOTTOM);

        //set image scale factor
        $pdf->setImageScale(PDF_IMAGE_SCALE_RATIO);

        //set some language-dependent strings
        //$pdf->setLanguageArray($l);

        // ---------------------------------------------------------

        // set font
        $pdf->SetFont('dejavusans', '', 9);

        $pdf->SetPrintHeader(false);

        // add a page
        //$pdf->AddPage('L','A4');
        $pdf->AddPage();

        $row = $this->db->get_where('epibulletins', array('id' => $id))->row();
        if(empty($row)) {
            redirect('epibulletins','refresh');
        }


        $country = $this->countriesmodel->get_by_id($row->country_id)->row();



        $html = '<table width="100%" cellpadding="3" cellspacing="0" border="1" bordercolor="#999999">
<tr><td><img src="'. base_url().'images/Header_title.png" alt=""></td></tr>
<tr bgcolor="#1f7eb8"><th align="center"><center>
<font color="#FFFFFF"><strong> Epi Week '.$row->week_no.', '.date("d F Y", strtotime($row->from_date)).' - '.date("d F Y", strtotime($row->to_date)).'</strong></font></center>
</th></tr>
';

        $highlight = $this->strip_HTML_tags($row->highlight);
        $cummulative_figures = $this->strip_HTML_tags($row->cummulative_figures);

        $html .= '<tr><td>
			<table width="100%" cellpadding="3" cellspacing="2" id="customers">
		<tr>
		<td bgcolor="#892A24" width="50%">
		<font color="#FFFFFF"><strong>Highlights</strong></font>
		</td>
		<td bgcolor="#892A24" width="50%">
		<font color="#FFFFFF"><strong>Cumulative Figures</strong></font>
		</td>
		</tr>
		<tr>
		<td valign="top">'.nl2br(ltrim($highlight)).'</td>
		<td valign="top">'.$row->cummulative_figures.'	
		</td>
		</tr>
		</table>
			</td></tr>';
        $html .= '</table>';

        //$html .= '<br pagebreak="true">';

        $html .= '<table width="100%" cellpadding="3" cellspacing="0" border="1" bordercolor="#999999">';
        $html .= '<tr><td>
			<table width="100%" cellpadding="3" cellspacing="2" id="customers">
		<tr>
		<td bgcolor="#892A24"><font color="#FFFFFF"><strong>'.$row->graph_one_title.'</strong></font>
		</td>
		</tr>
			<tr>
			<td><img src="'. base_url().'images/reportelements/'.$row->reporting_rates_graph.'" alt=""></td>
			</tr>
		</table>
			</td>
			</tr>';
        $html .= '</table>';


        $html .= '<br pagebreak="true">';

        $html .= '<table width="100%" cellpadding="3" cellspacing="0" border="1" bordercolor="#999999">';

        $html .= '<tr><td>
			<table width="100%" cellpadding="3" cellspacing="2" id="customers">
				<tr>
					<td bgcolor="#892A24" width="50%">
					<font color="#FFFFFF"><strong>Epidemic situation</strong></font>
					</td>
					<td bgcolor="#892A24" width="50%">
					<font color="#FFFFFF"><strong>Alerts and outbreaks - Epi Week '.$row->week_no.'</strong></font>
					</td>
				</tr>
				<tr>
					<td width="50%">
					'.$row->epidemic_situation.'
					</td>
					<td width="50%">
					<img src="'. base_url().'images/reportelements/'.$row->map_image.'" alt="">
					</td>
					
				</tr>
				
				</table>
			
			</td></tr>';

        $html .= '</table>';

        $html .= '<table width="100%" cellpadding="3" cellspacing="0" border="1" bordercolor="#999999">';
        $html .= '<tr><td>
			<table width="100%" cellpadding="3" cellspacing="2" id="customers">
		<tr>
		<td bgcolor="#892A24"><font color="#FFFFFF"><strong>'.$row->epi_curve_title.'</strong></font>
		</td>
		</tr>
			<tr>
			<td><img src="'. base_url().'images/reportelements/'.$row->epi_curve_graph.'" alt=""></td>
			</tr>
		</table>
			</td>
			</tr>';
        $html .= '</table>';

        $html .= '<br pagebreak="true">';

        $html .= '<table width="100%" cellpadding="3" cellspacing="0" border="1" bordercolor="#999999">';
        $html .= '<tr><td>
			<table width="100%" cellpadding="3" cellspacing="2" id="customers">
		<tr>
		<td bgcolor="#892A24"><font color="#FFFFFF"><strong>Number of alerts received and reported</strong></font>
		</td>
		</tr>
			<tr>
			<td><img src="'. base_url().'images/reportelements/'.$row->alerts_graph.'" alt=""></td>
			</tr>
		</table>
			</td>
			</tr>';
        $html .= '</table>';


        $html .= '<br pagebreak="true">';

        $html .= '<table width="100%" cellpadding="3" cellspacing="0" border="1" bordercolor="#999999">';
        $html .= '<tr><td>
			<table width="100%" cellpadding="3" cellspacing="2" id="customers">
		<tr>
		<td bgcolor="#892A24"><font color="#FFFFFF"><strong>'.$row->summary_title.'</strong></font>
		</td>
		</tr>
			<tr>
			<td>'.$row->leadingdiseasetable.'</td>
			</tr>
		</table>
			</td>
			</tr>';
        $html .= '</table>';

        $html .= '<br pagebreak="true">';

        $html .= '<table width="100%" cellpadding="3" cellspacing="0" border="1" bordercolor="#999999">';
        $html .= '<tr><td>
			<table width="100%" cellpadding="3" cellspacing="2" id="customers">
		<tr>
		<td bgcolor="#892A24"><font color="#FFFFFF"><strong>Trends for confirmed Malaria morbidity in '.$country->country_name.'</strong></font>
		</td>
		</tr>
			<tr>
			<td><img src="'. base_url().'images/reportelements/'.$row->malaria_graph.'" alt=""></td>
			</tr>
		</table>
			</td>
			</tr>';
        $html .= '</table>';

        $html .= '<table width="100%" cellpadding="3" cellspacing="0" border="1" bordercolor="#999999">';
        $html .= '<tr><td>
			<table width="100%" cellpadding="3" cellspacing="2" id="customers">
		<tr>
		<td bgcolor="#892A24"><font color="#FFFFFF"><strong>Summary of malaria morbidity in week '.$row->week_no.' '.$row->week_year.'</strong></font>
		</td>
		</tr>
			<tr>
			<td>'.$row->malariatable.'</td>
			</tr>
		</table>
			</td>
			</tr>';
        $html .= '</table>';

        $html .= '<br pagebreak="true">';

        $html .= '<table width="100%" cellpadding="3" cellspacing="0" bordercolor="#999999">';
        $html .= '<tr><td>
			'.$row->interesttable.'
			</td>
			</tr>';
        $html .= '</table>';

        $html .= '<br pagebreak="true">';

        $html .= '<table width="100%" cellpadding="3" cellspacing="0">';
        $html .= '<tr><td>
			'.$row->doi_one_text.'
			</td>
			</tr>';
        $html .= '</table>';

        $html .= '<br pagebreak="true">';

        $html .= '<table width="100%" cellpadding="3" cellspacing="0" bordercolor="#999999">';
        $html .= '<tr><td>
			'.$row->lastinteresttable.'
			</td>
			</tr>';
        $html .= '</table>';

        $html .= '<br pagebreak="true">';

        $html .= '<table width="100%" cellpadding="3" cellspacing="0">';
        $html .= '<tr><td>
			'.$row->doi_two_text.'
			</td>
			</tr>';
        $html .= '</table>';

        $html .= '<br pagebreak="true">';

        $html .= $row->summarytable;


        $html .= '<table width="100%" cellpadding="3" cellspacing="0">';
        $html .= '<tr><td>&nbsp;</td>
			</tr>';
        $html .= '</table>';

        $html .= '<table width="100%" cellpadding="3" border="1" cellspacing="0">';
        $html .= '<tr bgcolor="#892A24"><td>
			<center>
			<font color="#FFFFFF">'.$row->footer_one.'</font>
			</center>
			</td>
			</tr>';
        $html .= '</table>';

        $html .= '<table width="100%" cellpadding="3" border="1" cellspacing="0">';
        $html .= '<tr bgcolor="#1f7eb8"><td>
			<center>
			<font color="#FFFFFF">'.$row->footer_two.'</font>
			</center>
			</td>
			</tr>';
        $html .= '</table>';



        // output the HTML content
        $pdf->writeHTML($html, true, false, true, false, '');

        $txt = date("m/d/Y h:m:s");

        // print a block of text using Write()
        //$pdf->Write($h=0, $txt, $link='', $fill=0, $align='C', $ln=true, $stretch=0, $firstline=false, $firstblock=false, $maxh=0);
        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
        // test pre tag


        // - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

        // reset pointer to the last page
        $pdf->lastPage();
        ob_start();
        // ---------------------------------------------------------
        //ob_end_clean();
        //Close and output PDF document
        $pdf->Output('EPI_Bulletin_'.$country->country_code.'_'.$row->week_no.'_'.$row->week_year.'.pdf', 'I');


        //============================================================+
        // END OF FILE
        //============================================================+
    }


    function strip_HTML_tags($text)
    { // Strips HTML 4.01 start and end tags. Preserves contents.
        return preg_replace('%
	        # Match an opening or closing HTML 4.01 tag.
	        </?                  # Tag opening "<" delimiter.
	        (?:                  # Group for HTML 4.01 tags.
	          ABBR|ACRONYM|ADDRESS|APPLET|AREA|A|BASE|BASEFONT|BDO|BIG|
	          BLOCKQUOTE|BODY|BR|BUTTON|B|CAPTION|CENTER|CITE|CODE|COL|
	          COLGROUP|DD|DEL|DFN|DIR|DIV|DL|DT|EM|FIELDSET|FONT|FORM|
	          FRAME|FRAMESET|H\d|HEAD|HR|HTML|IFRAME|IMG|INPUT|INS|
	          ISINDEX|I|KBD|LABEL|LEGEND|LI|LINK|MAP|MENU|META|NOFRAMES|
	          NOSCRIPT|OBJECT|OL|OPTGROUP|OPTION|PARAM|PRE|P|Q|SAMP|
	          SCRIPT|SELECT|SMALL|SPAN|STRIKE|STRONG|STYLE|SUB|SUP|S|
	          TABLE|TD|TBODY|TEXTAREA|TFOOT|TH|THEAD|TITLE|TR|TT|U|UL|VAR
	        )\b                  # End group of tag name alternative.
	        (?:                  # Non-capture group for optional attribute(s).
	          \s+                # Attributes must be separated by whitespace.
	          [\w\-.:]+          # Attribute name is required for attr=value pair.
	          (?:                # Non-capture group for optional attribute value.
	            \s*=\s*          # Name and value separated by "=" and optional ws.
	            (?:              # Non-capture group for attrib value alternatives.
	              "[^"]*"        # Double quoted string.
	            | \'[^\']*\'     # Single quoted string.
	            | [\w\-.:]+      # Non-quoted attrib value can be A-Z0-9-._:
	            )                # End of attribute value alternatives.
	          )?                 # Attribute value is optional.
	        )*                   # Allow zero or more attribute=value pairs
	        \s*                  # Whitespace is allowed before closing delimiter.
	        /?                   # Tag may be empty (with self-closing "/>" sequence.
	        >                    # Opening tag closing ">" delimiter.
	        | <!--.*?-->         # Or a (non-SGML compliant) HTML comment.
	        | <!DOCTYPE[^>]*>    # Or a DOCTYPE.
	        %six', '', $text);
    }


    public function edit($id)
    {
        if (!$this->erkanaauth->try_session_login()) {
            redirect('login','refresh');
        }
        $row = $this->db->get_where('epibulletins', array('id' => $id))->row();
        $data = array(
            'row' => $row,
        );
        $this->load->view('epibulletins/edit', $data);
    }

    public function edit_validate($id)
    {
        if (!$this->erkanaauth->try_session_login()) {
            redirect('login','refresh');
        }
        $this->load->library('form_validation');
        $this->form_validation->set_rules('highlight', 'Highlight', 'trim|required');
        $this->form_validation->set_rules('cummulative_figures', 'Cummulative figures', 'trim|required');
        $this->form_validation->set_rules('epidemic_situation', 'Epidemic situation', 'trim|required');
        $this->form_validation->set_rules('leadingdiseasetable', 'Leading disease table', 'trim|required');
        $this->form_validation->set_rules('malariatable', 'Malaria table', 'trim|required');
        $this->form_validation->set_rules('interesttable', 'First disease of interest table', 'trim|required');
        $this->form_validation->set_rules('doi_one_text', 'Information on the first disease of interest', 'trim|required');
        $this->form_validation->set_rules('lastinteresttable', 'Second disease of interest table', 'trim|required');
        $this->form_validation->set_rules('doi_two_text', 'Information on the second disease of interest', 'trim|required');
        $this->form_validation->set_rules('summarytable', 'Summary table', 'trim|required');
        $this->form_validation->set_rules('footer_one', 'Footer one', 'trim|required');
        $this->form_validation->set_rules('footer_two', 'Footer two', 'trim|required');
        if ($this->form_validation->run() == false) {
            $this->edit($id);
        } else {
            $data = array(
                'highlight' => $this->input->post('highlight'),
                'cummulative_figures' => $this->input->post('cummulative_figures'),
                'epidemic_situation' => $this->input->post('epidemic_situation'),
                'leadingdiseasetable' => $this->input->post('leadingdiseasetable'),
                'malariatable' => $this->input->post('malariatable'),
                'interesttable' => $this->input->post('interesttable'),
                'doi_one_text' => $this->input->post('doi_one_text'),
                'lastinteresttable' => $this->input->post('lastinteresttable'),
                'doi_two_text' => $this->input->post('doi_two_text'),
                'summarytable' => $this->input->post('summarytable'),
                'footer_one' => $this->input->post('footer_one'),
                'footer_two' => $this->input->post('footer_two'),
            );
            $this->db->where('id', $id);
            $this->db->update('epibulletins', $data);
            redirect('epibulletins','refresh');
        }
    }

    public function delete($id)
    {
        if (!$this->erkanaauth->try_session_login()) {
            redirect('login','refresh');
        }
        $this->db->delete('epibulletins', array('id' => $id));
        redirect('epibulletins','refresh');
    }

    function top_three_positions($array){

        // Sort the array from max to min
        arsort($array);

        // Unset everything in  sorted array after the first three elements
        $count = 0;
        foreach($array as $key => $ar){
            if($count > 2){
                unset($array[$key]);
            }
            $count++;
        }

        // Return array with top 3 values with their indexes preserved.
        return $array;
    }



    function getStartAndEndDate($week, $year) {
        $dto = new DateTime();
        $dto->setISODate($year, $week);
        $ret['week_start'] = $dto->format('Y-m-d');
        $dto->modify('+6 days');
        $ret['week_end'] = $dto->format('Y-m-d');
        return $ret;
    }

}
